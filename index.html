<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏàòÌñâÌèâÍ∞Ä Ï†êÏàò ÌôïÏù∏ ÏãúÏä§ÌÖú v1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getDatabase, ref, set, onValue, update, remove } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';

        // Firebase Ï¥àÍ∏∞ÌôîÎäî ÏÇ¨Ïö©Ïûê ÏÑ§Ï†ï ÌõÑÏóê ÏßÑÌñâ
        let firebaseInitialized = false;

        // Ï†ÑÏó≠ Î≥ÄÏàò Ï¥àÍ∏∞Ìôî
        window.firebase = null;
        window.firebaseInitialized = false;

        // Firebase Ï¥àÍ∏∞Ìôî Ìï®Ïàò
        async function initializeFirebase() {
            try {
                // localStorageÏóêÏÑú ÏÑ§Ï†ï Î∂àÎü¨Ïò§Í∏∞
                const apiKey = localStorage.getItem('firebaseApiKey');
                const authDomain = localStorage.getItem('firebaseAuthDomain');
                const databaseURL = localStorage.getItem('userDatabaseURL');
                const projectId = localStorage.getItem('firebaseProjectId');
                const storageBucket = localStorage.getItem('firebaseStorageBucket');

                if (!apiKey || !databaseURL || !projectId) {
                    console.error('Firebase ÏÑ§Ï†ïÏù¥ ÏóÜÏäµÎãàÎã§.');
                    return false;
                }

                const firebaseConfig = {
                    apiKey: apiKey,
                    authDomain: authDomain,
                    databaseURL: databaseURL,
                    projectId: projectId,
                    storageBucket: storageBucket
                };

                const app = initializeApp(firebaseConfig);
                const database = getDatabase(app);

                // Ï†ÑÏó≠ Î≥ÄÏàòÎ°ú ÏÑ§Ï†ï
                window.firebase = {
                    database,
                    ref,
                    set,
                    onValue,
                    update,
                    remove,
                    app
                };

                firebaseInitialized = true;
                window.firebaseInitialized = true;
                console.log('Firebase Ï¥àÍ∏∞Ìôî ÏÑ±Í≥µ');

                // QR ÏΩîÎìú Î≤ÑÌäº ÌëúÏãú
                const qrBtn = document.getElementById('qrCodeBtn');
                if (qrBtn) {
                    qrBtn.style.display = 'inline-block';
                }

                return true;
            } catch (error) {
                console.error('Firebase Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', error);
                window.firebase = null;
                firebaseInitialized = false;
                window.firebaseInitialized = false;
                return false;
            }
        }

        // Ï†ÑÏó≠ Ìï®ÏàòÎ°ú ÎÖ∏Ï∂ú
        window.initializeFirebase = initializeFirebase;

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Firebase Ï¥àÍ∏∞Ìôî ÏãúÎèÑ
        window.addEventListener('load', async () => {
            await initializeFirebase();
        });
    </script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            overflow-x: hidden;
            zoom: 0.8;
            margin: 5px;
            padding: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* Ìó§Îçî Ïä§ÌÉÄÏùº */
        .header {
            background-color: white;
            color: #333;
            padding: 12px 15px;
            border-radius: 6px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
            margin-bottom: 2px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            margin: 0;
            font-size: 18px;
            color: #333;
            display: flex;
            align-items: center;
        }

        .header h1::before {
            content: "üìä";
            margin-right: 10px;
            font-size: 24px;
        }

        .header-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }

        .connection-status {
            background-color: #ffc107;
            color: #212529;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 14px;
            white-space: nowrap;
            min-width: 120px;
        }

        .tab.active {
            background: white;
            border-bottom: 3px solid #007bff;
        }

        .tab-content {
            display: none;
            padding: 20px;
        }

        .tab-content.active {
            display: block;
        }

        .subject-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
        }

        .section {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .subject-section {
            background-color: #f0f8ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .subject-management-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .subject-input-section {
            flex: 0 0 300px;
            background-color: #e8f5e8;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            padding: 20px;
        }

        .subject-list-section {
            flex: 1;
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 20px;
        }

        .grade-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .grade-column {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            background-color: #f8f9fa;
        }

        .grade-column h5 {
            margin: 0 0 10px 0;
            color: #007bff;
            font-size: 14px;
            text-align: center;
            border-bottom: 2px solid #007bff;
            padding-bottom: 8px;
        }

        .grade-column.grade-3 {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }

        .grade-column.grade-2 {
            background-color: #e8f5e9;
            border-color: #4caf50;
        }

        .grade-column.grade-1 {
            background-color: #fff3e0;
            border-color: #ff9800;
        }

        /* Ï†êÏàò Í¥ÄÎ¶¨Ïö© Í≥ºÎ™© ÏÑ†ÌÉù Ïä§ÌÉÄÏùº */
        .score-subject-section {
            background-color: #f0f8ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .score-subject-item {
            display: block;
            background: #fff3e0;
            color: #e65100;
            padding: 8px 12px;
            border-radius: 8px;
            margin: 5px 0;
            font-size: 12px;
            border: 1px solid #ffcc02;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .score-subject-item:hover {
            background: #e65100;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .score-subject-item.selected {
            background: #e65100;
            color: white;
            border-color: #bf360c;
        }

        .grade-subject-group {
            margin-bottom: 15px;
        }

        .grade-subject-group h5 {
            margin: 0 0 10px 0;
            color: #007bff;
            font-size: 14px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        .subject-item {
            display: block;
            background: #e3f2fd;
            color: #1976d2;
            padding: 8px 12px;
            border-radius: 8px;
            margin: 5px 0;
            font-size: 12px;
            border: 1px solid #bbdefb;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .subject-item:hover {
            background: #1976d2;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .subject-item.selected {
            background: #1976d2;
            color: white;
            border-color: #0d47a1;
        }

        .subject-item .delete-btn {
            margin-left: 8px;
            color: #f44336;
            cursor: pointer;
            font-weight: bold;
        }

        .subject-item .delete-btn:hover {
            color: #d32f2f;
        }

        /* Îì±Î°ù ÏÑπÏÖò Í∞úÏÑ†Îêú Î†àÏù¥ÏïÑÏõÉ */
        .registration-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .registration-item {
            flex: 1;
            background-color: #e8f5e8;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            padding: 20px;
        }

        .registration-item h4 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #155724;
        }

        /* Î∞òÏùëÌòï ÎîîÏûêÏù∏: Î™®Î∞îÏùºÏóêÏÑúÎäî ÏÑ∏Î°ú Ï†ïÎ†¨ */
        @media (max-width: 768px) {
            .registration-row {
                flex-direction: column;
                gap: 15px;
            }
        }

        .grade-tabs {
            display: flex;
            border-bottom: 1px solid #ccc;
            margin-bottom: 20px;
            background-color: #f8f9fa;
            border-radius: 4px 4px 0 0;
        }

        .grade-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            background: #e9ecef;
            border: none;
            font-size: 14px;
            border-right: 1px solid #ccc;
        }

        .grade-tab:last-child {
            border-right: none;
        }

        .grade-tab.active {
            background: white;
            border-bottom: 2px solid #007bff;
            font-weight: bold;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .input-field {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .select-field {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }

        .score-input {
            width: 60px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }

        .btn {
            padding: 8px 14px;
            margin: 3px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
            background-color: #007bff;
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn.success {
            background-color: #28a745;
        }

        .btn.success:hover {
            background-color: #218838;
        }

        .btn.danger {
            background-color: #dc3545;
        }

        .btn.danger:hover {
            background-color: #c82333;
        }

        .btn.warning {
            background-color: #ffc107;
            color: #212529;
        }

        .btn.warning:hover {
            background-color: #e0a800;
        }

        .btn.info {
            background-color: #17a2b8;
        }

        .btn.info:hover {
            background-color: #138496;
        }

        .tag {
            border-radius: 20px;
            padding: 5px 15px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin: 2px;
        }

        .area-tag {
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
        }

        .subject-tag {
            background-color: #f0f8ff;
            border: 1px solid #4169e1;
        }

        .tag .remove-btn {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .list-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .subject-areas {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .class-matrix {
            overflow-x: auto;
            margin: 20px 0;
        }

        .matrix-table {
            border-collapse: collapse;
            min-width: 100%;
            background: white;
        }

        .matrix-table th {
            background-color: #007bff;
            color: white;
            padding: 8px 4px;
            text-align: center;
            font-size: 12px;
            min-width: 80px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .matrix-table th.row-header {
            background-color: #28a745;
            position: sticky;
            left: 0;
            z-index: 11;
            min-width: 40px;
        }

        .matrix-table td {
            border: 1px solid #ddd;
            padding: 4px;
            text-align: center;
            font-size: 11px;
            min-width: 80px;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            height: 35px;
            vertical-align: middle;
        }

        .matrix-table td.row-header {
            background-color: #e8f5e8;
            font-weight: bold;
            position: sticky;
            left: 0;
            z-index: 9;
            min-width: 40px;
            max-width: 40px;
        }

        .matrix-table td.student-cell {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .matrix-table td.student-cell:hover {
            background-color: #e3f2fd;
        }

        .matrix-table td.student-cell.empty {
            background-color: #f8f9fa;
            color: #999;
        }

        .matrix-table td.student-cell.filled {
            background-color: #e8f5e8;
            color: #333;
            font-weight: bold;
        }

        .score-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            overflow-x: auto;
            display: block;
            white-space: nowrap;
        }

        .score-table thead, .score-table tbody {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        .score-table th, .score-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            min-width: 80px;
        }

        .score-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            position: sticky;
            top: 0;
        }

        .student-login {
            text-align: center;
            padding: 40px;
        }

        .login-input {
            padding: 12px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px;
            width: 120px;
            text-align: center;
        }

        .result-box {
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 4px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 4px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }

        .upload-area.dragover {
            border-color: #2196f3;
            background-color: #e3f2fd;
            transform: scale(1.02);
        }

        .stats-box {
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 4px;
            padding: 15px;
            text-align: center;
            margin: 10px 0;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .modal-content {
            background-color: white;
            margin: 0;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            text-align: left;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
            box-sizing: border-box;
            overflow: hidden;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 20px 30px;
            text-align: center;
            border-bottom: none;
        }

        .modal-header h4 {
            margin: 0 0 10px 0;
            font-size: 20px;
        }

        .student-info-text {
            margin: 0;
            font-weight: bold;
            opacity: 0.9;
            font-size: 16px;
        }

        .modal-body {
            padding: 30px;
        }

        .modal-footer {
            padding: 20px 30px;
            background-color: #f8f9fa;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: nowrap;
        }

        .modal-footer .btn {
            flex: 1;
            font-size: 13px;
            padding: 10px 8px;
            min-width: 0;
            white-space: nowrap;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .password-field {
            background-color: #f8f9fa !important;
        }

        .password-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .password-toggle-btn {
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .password-toggle-btn:hover {
            background-color: #f8f9fa;
            border-color: #007bff;
        }

        .info-box {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
            font-size: 14px;
            color: #856404;
            line-height: 1.5;
        }

        .btn-secondary {
            background-color: #6c757d !important;
            color: white !important;
        }

        .btn-secondary:hover {
            background-color: #545b62 !important;
        }

        /* Firebase Î™®Îã¨ Ïä§ÌÉÄÏùº */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0,0,0,0.8);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 0;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
            position: relative;
            z-index: 10000;
        }

        .modal-title {
            margin: 0;
            font-size: 18px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: #333;
        }

        .modal-step {
            padding: 20px;
        }

        .modal-buttons {
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .subject-selector {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #e3f2fd;
            border-radius: 4px;
        }

        .hidden {
            display: none !important;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f8f9fa;
            transition: background-color 0.2s;
        }

        .checkbox-item:hover {
            background-color: #e9ecef;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 12px;
            transform: scale(1.2);
        }

        .checkbox-item label {
            flex: 1;
            cursor: pointer;
            margin: 0;
        }

        .checkbox-item .subject-info {
            color: #666;
            font-size: 12px;
            margin-left: 8px;
        }

        .grade-section {
            margin-bottom: 25px;
            border: 1px solid #007bff;
            border-radius: 4px;
            overflow: hidden;
        }

        .grade-header {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .grade-content {
            padding: 15px;
        }

        .select-all-grade {
            background: none;
            border: 1px solid white;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
        }

        .select-all-grade:hover {
            background-color: rgba(255,255,255,0.2);
        }

        @media (max-width: 768px) {
            .input-group {
                flex-direction: column;
            }

            .tabs {
                font-size: 12px;
            }

            .tab {
                min-width: 100px;
                padding: 10px;
            }

            .matrix-table th, .matrix-table td {
                min-width: 60px;
                max-width: 60px;
                font-size: 10px;
            }

            .modal {
                padding: 10px 0;
            }

            .modal-content {
                margin: 20px auto;
                width: 95%;
                max-width: none;
            }

            .modal-header {
                padding: 15px 20px;
            }

            .modal-body {
                padding: 20px;
            }

            .modal-footer {
                padding: 15px 20px;
                flex-direction: column;
                gap: 8px;
            }

            .modal-footer .btn {
                width: 100%;
                flex: none;
                font-size: 14px;
                padding: 12px;
            }

            .password-input-group {
                flex-direction: column;
                gap: 8px;
            }

            .password-toggle-btn {
                width: 100%;
            }
        }

        /* Î©îÏãúÏßÄ Í¥ÄÎ†® Ïä§ÌÉÄÏùº */
        .messages-header {
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }

        .messages-filters {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .messages-container {
            max-height: 600px;
            overflow-y: auto;
        }

        .message-item {
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
        }

        .message-item.answered {
            border-left-color: #28a745;
            background: #f8fff9;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .message-info {
            font-size: 12px;
            color: #666;
        }

        .message-content {
            margin: 10px 0;
            padding: 10px;
            background: #f1f3f4;
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.4;
        }

        .message-reply {
            margin-top: 10px;
            padding: 10px;
            background: #e8f5e8;
            border-radius: 4px;
            border-left: 3px solid #28a745;
        }

        .reply-form {
            margin-top: 10px;
            padding: 10px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .reply-textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }

        .reply-buttons {
            margin-top: 8px;
            text-align: right;
        }

        .status-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .status-unanswered {
            background: #fff3cd;
            color: #856404;
        }

        .status-answered {
            background: #d4edda;
            color: #155724;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ÏàòÌñâÌèâÍ∞Ä Ï†êÏàò ÌôïÏù∏ ÏãúÏä§ÌÖú v1</h1>
            <div class="header-buttons">
                <div class="connection-status" id="connectionStatus">
                    üîÑ Ïó∞Í≤∞ Ï§ë...
                </div>
                <button class="btn btn-secondary" onclick="openFirebaseSettings()" id="firebaseSettingsBtn">
                    ‚öôÔ∏è Firebase ÏÑ§Ï†ï
                </button>
                <button class="btn btn-primary" onclick="openQRModal()" id="qrCodeBtn" style="display: none;">
                    üì± ÌïôÏÉù QR ÏΩîÎìú
                </button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('students')">üë• ÌïôÏÉùÍ¥ÄÎ¶¨</button>
            <button class="tab" onclick="switchTab('subjects')">üìö Í≥ºÎ™©/ÏòÅÏó≠ÏÑ§Ï†ï</button>
            <button class="tab" onclick="switchTab('admin')">üéØ Ï†êÏàòÍ¥ÄÎ¶¨</button>
        </div>

        <!-- ÌïôÏÉùÍ¥ÄÎ¶¨ ÌÉ≠ -->
        <div id="students-content" class="tab-content active">

            <!-- Í∞úÎ≥ÑÎì±Î°ùÍ≥º ÏùºÍ¥ÑÎì±Î°ùÏùÑ ÎÇòÎûÄÌûà Î∞∞Ïπò -->
            <div class="registration-row">
                <div class="registration-item">
                    <h4>üìù ÌïôÏÉù Í∞úÎ≥Ñ Îì±Î°ù</h4>
                    <div class="input-group">
                        <input type="text" class="input-field" id="studentNumber" placeholder="ÌïôÎ≤à (Ïòà: 30101)" style="width: 100px;"
                               title="ÌïôÏÉùÏùò ÌïôÎ≤àÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (5ÏûêÎ¶¨ Ïà´Ïûê)"
                               aria-label="ÌïôÏÉù ÌïôÎ≤à ÏûÖÎ†•">
                        <input type="text" class="input-field" id="studentName" placeholder="ÌïôÏÉù Ïù¥Î¶Ñ" style="flex: 1;"
                               title="ÌïôÏÉùÏùò Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                               aria-label="ÌïôÏÉù Ïù¥Î¶Ñ ÏûÖÎ†•">
                        <button class="btn" onclick="addStudent()">‚ûï ÌïôÏÉù Ï∂îÍ∞Ä</button>
                    </div>
                </div>
                <div class="registration-item">
                    <h4>üì§ Î™ÖÎã® ÏùºÍ¥Ñ Îì±Î°ù</h4>
                    <div class="upload-area" id="studentUploadArea" onclick="document.getElementById('studentFileInput').click()">
                        <p>üìÅ ÏóëÏÖÄ ÌååÏùºÏùÑ ÎìúÎûòÍ∑∏ÌïòÏó¨ ÎÜìÍ±∞ÎÇò ÌÅ¥Î¶≠ÌïòÏó¨ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</p>
                        <p style="font-size: 12px; color: #666;">ÌòïÏãù: AÏó¥-ÌïôÎ≤à(30101), BÏó¥-Ïù¥Î¶Ñ</p>
                        <p style="font-size: 11px; color: #999;">ÏßÄÏõê ÌòïÏãù: .xlsx, .xls</p>
                        <input type="file" id="studentFileInput" accept=".xlsx,.xls" style="display: none;" onchange="uploadStudentFile(event)"
                               title="ÌïôÏÉù Î™ÖÎã® ÏóëÏÖÄ ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî"
                               aria-label="ÌïôÏÉù Î™ÖÎã® ÌååÏùº ÏÑ†ÌÉù">
                    </div>
                </div>
            </div>

            <!-- ÌïôÎÖÑÎ≥Ñ ÌÉ≠ -->
            <div class="grade-tabs">
                <button class="grade-tab active" onclick="switchGrade(3)" id="grade3-tab">3ÌïôÎÖÑ</button>
                <button class="grade-tab" onclick="switchGrade(2)" id="grade2-tab">2ÌïôÎÖÑ</button>
                <button class="grade-tab" onclick="switchGrade(1)" id="grade1-tab">1ÌïôÎÖÑ</button>
            </div>

            <div id="matrixContainer" class="class-matrix">
                <!-- ÌïôÍ∏â Îß§Ìä∏Î¶≠Ïä§Í∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn warning" onclick="downloadStudentTemplate()">üì• Î™ÖÎã® ÏñëÏãù Îã§Ïö¥Î°úÎìú</button>
                <button class="btn danger" onclick="clearAllStudents()">üóëÔ∏è Î™®Îì† ÌïôÏÉù ÏÇ≠Ï†ú</button>
            </div>
        </div>

        <!-- Í≥ºÎ™©/ÏòÅÏó≠ÏÑ§Ï†ï ÌÉ≠ -->
        <div id="subjects-content" class="tab-content">

            <!-- Í≥ºÎ™© Í¥ÄÎ¶¨Î•º Ï¢åÏö∞Î°ú Î∞∞Ïπò -->
            <div class="subject-management-row">
                <div class="subject-input-section">
                    <h4>üìñ Í≥ºÎ™© Ï∂îÍ∞Ä</h4>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <select class="select-field" id="subjectGrade"
                                title="Í≥ºÎ™©ÏùÑ Ï∂îÍ∞ÄÌï† ÌïôÎÖÑÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî"
                                aria-label="ÌïôÎÖÑ ÏÑ†ÌÉù">
                            <option value="1">1ÌïôÎÖÑ</option>
                            <option value="2">2ÌïôÎÖÑ</option>
                            <option value="3" selected>3ÌïôÎÖÑ</option>
                        </select>
                        <input type="text" class="input-field" id="subjectName" placeholder="Í≥ºÎ™©Î™Ö (Ïòà: Íµ≠Ïñ¥, ÏàòÌïô, ÏÇ¨Ìöå)"
                               title="Ï∂îÍ∞ÄÌï† Í≥ºÎ™©Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                               aria-label="Í≥ºÎ™©Î™Ö ÏûÖÎ†•">
                        <input type="text" class="input-field" id="teacherName" placeholder="ÍµêÏÇ¨Ïù¥Î¶Ñ (ÏÑ†ÌÉùÏÇ¨Ìï≠)"
                               title="Îã¥Îãπ ÍµêÏÇ¨Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (ÏÑ†ÌÉùÏÇ¨Ìï≠)"
                               aria-label="ÍµêÏÇ¨Ïù¥Î¶Ñ ÏûÖÎ†•">
                        <button class="btn info" onclick="addSubject()">‚ûï Í≥ºÎ™© Ï∂îÍ∞Ä</button>
                    </div>
                </div>
                <div class="subject-list-section">
                    <h4>üìö Îì±Î°ùÎêú Í≥ºÎ™© Î∞è ÏàòÌñâÏòÅÏó≠ ÏÑ§Ï†ï <span style="font-size: 12px; color: #666; font-weight: normal;">(Îì±Î°ùÎêú Í≥ºÎ™©ÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÏàòÌñâÏòÅÏó≠ÏùÑ ÏÑ§Ï†ïÌïòÏÑ∏Ïöî)</span></h4>
                    <div id="subjectList" class="subject-list-by-grade">
                        <!-- ÌïôÎÖÑÎ≥ÑÎ°ú Íµ¨Î∂ÑÎêú Í≥ºÎ™©Îì§Ïù¥ Ïó¨Í∏∞ ÌëúÏãúÎê©ÎãàÎã§ -->
                    </div>
                </div>
            </div>

            <div class="section">

                <div id="areaManagement" style="display: none;">
                    <div class="input-group">
                        <input type="text" class="input-field" id="areaName" placeholder="ÏàòÌñâÏòÅÏó≠Î™Ö (Ïòà: ÌÜ†Î°†Ï∞∏Ïó¨, Î∞úÌëú)" style="flex: 1;"
                               title="ÏàòÌñâÏòÅÏó≠Ïùò Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                               aria-label="ÏàòÌñâÏòÅÏó≠Î™Ö ÏûÖÎ†•">
                        <input type="number" class="score-input" id="areaMaxScore" placeholder="ÎßåÏ†ê" min="1" max="100"
                               title="Ìï¥Îãπ ÏàòÌñâÏòÅÏó≠Ïùò ÎßåÏ†êÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                               aria-label="ÎßåÏ†ê ÏûÖÎ†•">
                        <button class="btn" onclick="addArea()">‚ûï ÏòÅÏó≠ Ï∂îÍ∞Ä</button>
                        <button class="btn success" onclick="generateTemplate()" id="templateBtn" disabled style="margin-left: 10px;">üì• Ï†êÏàòÌëú ÌÖúÌîåÎ¶ø Îã§Ïö¥Î°úÎìú</button>
                    </div>

                    <div id="currentSubjectAreas" class="subject-areas">
                        <!-- ÏÑ†ÌÉùÎêú Í≥ºÎ™©Ïùò ÏàòÌñâÏòÅÏó≠Îì§Ïù¥ Ïó¨Í∏∞ ÌëúÏãúÎê©ÎãàÎã§ -->
                    </div>
                </div>

            </div>
        </div>

        <!-- Ï†êÏàòÍ¥ÄÎ¶¨ ÌÉ≠ -->
        <div id="admin-content" class="tab-content">
            <div class="score-subject-section">
                <h4>üìö Ï†êÏàò Í¥ÄÎ¶¨Ìï† Í≥ºÎ™© ÏÑ†ÌÉù <span style="font-size: 12px; color: #666; font-weight: normal;">(Í≥ºÎ™©ÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ Ï†êÏàòÎ•º Í¥ÄÎ¶¨ÌïòÏÑ∏Ïöî)</span></h4>
                <div id="scoreSubjectList" class="score-subject-list-by-grade">
                    <!-- ÌïôÎÖÑÎ≥ÑÎ°ú Íµ¨Î∂ÑÎêú Ï†êÏàò Í¥ÄÎ¶¨Ïö© Í≥ºÎ™©Îì§Ïù¥ Ïó¨Í∏∞ ÌëúÏãúÎê©ÎãàÎã§ -->
                </div>
            </div>

            <div id="scoreUploadSection" style="display: none;">
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <h4>üì§ Ï†êÏàòÌëú ÏóëÏÖÄ ÌååÏùº ÏóÖÎ°úÎìú</h4>
                    <p>ÏôÑÏÑ±Îêú Ï†êÏàòÌëú ÏóëÏÖÄ ÌååÏùºÏùÑ Ïó¨Í∏∞Ïóê ÎìúÎûòÍ∑∏ÌïòÍ±∞ÎÇò ÌÅ¥Î¶≠ÌïòÏó¨ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</p>
                    <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;" onchange="uploadFile(event)"
                           title="Ï†êÏàòÌëú ÏóëÏÖÄ ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî"
                           aria-label="Ï†êÏàòÌëú ÌååÏùº ÏÑ†ÌÉù">
                </div>

                <div id="scoreTableContainer">
                    <!-- ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îêú Ï†êÏàòÌëúÍ∞Ä Ïó¨Í∏∞ ÌëúÏãúÎê©ÎãàÎã§ -->
                </div>


            </div>
        </div>


    </div>

    <!-- ÌïôÏÉù Ï†ïÎ≥¥ ÏàòÏ†ï Î™®Îã¨ -->
    <!-- ÌïôÏÉù Ï†ïÎ≥¥ Î™®Îã¨ -->
    <div id="studentModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; width: 500px; max-width: 90%; max-height: 90vh; overflow-y: auto;">
            <h3 style="margin: 0 0 20px 0; color: #007bff;">üë§ ÌïôÏÉù Ï†ïÎ≥¥ Í¥ÄÎ¶¨</h3>
            <p id="modalStudentInfo" style="margin: 0 0 20px 0; font-size: 14px; color: #666;"></p>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">ÌïôÏÉù Ïù¥Î¶Ñ:</label>
                <input type="text" id="modalStudentName" placeholder="ÌïôÏÉù Ïù¥Î¶Ñ"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;"
                       title="ÌïôÏÉùÏùò Ïù¥Î¶ÑÏùÑ ÏàòÏ†ïÌïòÏÑ∏Ïöî" aria-label="ÌïôÏÉù Ïù¥Î¶Ñ ÏàòÏ†ï">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">ÌòÑÏû¨ ÎπÑÎ∞ÄÎ≤àÌò∏:</label>
                <div style="display: flex; gap: 5px;">
                    <input type="password" id="modalStudentPassword" readonly
                           style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;"
                           title="ÌïôÏÉùÏùò ÌòÑÏû¨ ÎπÑÎ∞ÄÎ≤àÌò∏ÏûÖÎãàÎã§" aria-label="ÌïôÏÉù ÌòÑÏû¨ ÎπÑÎ∞ÄÎ≤àÌò∏">
                    <button type="button" id="togglePasswordBtn" onclick="togglePasswordVisibility()"
                            style="padding: 10px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;"
                            title="ÎπÑÎ∞ÄÎ≤àÌò∏ ÌëúÏãú/Ïà®Í∏∞Í∏∞ Ï†ÑÌôò" aria-label="ÎπÑÎ∞ÄÎ≤àÌò∏ ÌëúÏãú Ï†ÑÌôò Î≤ÑÌäº">üëÅÔ∏è</button>
                </div>
            </div>

            <div style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 4px; padding: 15px; margin-bottom: 20px; font-size: 14px;">
                <strong>üí° ÎπÑÎ∞ÄÎ≤àÌò∏ Í¥ÄÎ¶¨:</strong><br>
                ‚Ä¢ ÌïôÏÉùÏù¥ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûäÏóàÏùÑ Îïå ÌôïÏù∏Ïö©<br>
                ‚Ä¢ Ï¥àÍ∏∞Ìôî Î≤ÑÌäºÏúºÎ°ú ÎπÑÎ∞ÄÎ≤àÌò∏Î•º 123456ÏúºÎ°ú Ïû¨ÏÑ§Ï†ï<br>
                ‚Ä¢ ÌïôÏÉùÏùÄ Îã§Ïùå Î°úÍ∑∏Ïù∏ Ïãú ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏ ÏÑ§Ï†ï ÌïÑÏöî
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="updateStudent()" style="padding: 10px 20px; border: none; background: #007bff; color: white; border-radius: 4px; cursor: pointer;">Ï†ÄÏû•</button>
                <button onclick="resetPassword()" style="padding: 10px 20px; border: none; background: #ffc107; color: black; border-radius: 4px; cursor: pointer;">Ï¥àÍ∏∞Ìôî</button>
                <button onclick="deleteStudent()" style="padding: 10px 20px; border: none; background: #dc3545; color: white; border-radius: 4px; cursor: pointer;">ÏÇ≠Ï†ú</button>
                <button onclick="closeModal()" style="padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">Îã´Í∏∞</button>
            </div>
        </div>
    </div>

    <!-- Í≥ºÎ™© Ï∂îÍ∞Ä Îã®Í≥ÑÎ≥Ñ Î™®Îã¨ -->
    <div id="subjectAddModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; width: 500px; max-width: 90%; max-height: 90vh; overflow-y: auto;">

            <!-- 1Îã®Í≥Ñ: Î∞ò ÏÑ†ÌÉù -->
            <div id="step1ClassSelection">
                <h3 style="margin: 0 0 20px 0; color: #007bff;">üè´ 1Îã®Í≥Ñ: Îã¥Îãπ Î∞ò ÏÑ†ÌÉù</h3>
                <div id="subjectInfoDisplay" style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                    <!-- Í≥ºÎ™© Ï†ïÎ≥¥Í∞Ä ÌëúÏãúÎê©ÎãàÎã§ -->
                </div>
                <p style="margin: 0 0 20px 0; color: #666;">Îã¥ÎãπÌïòÏã§ Î∞òÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî. (Î≥µÏàò ÏÑ†ÌÉù Í∞ÄÎä•)</p>

                <div id="classSelectionContent" style="margin-bottom: 20px;">
                    <!-- ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±ÎêòÎäî Ï≤¥ÌÅ¨Î∞ïÏä§Îì§ -->
                </div>

                <div style="text-align: center; border-top: 1px solid #ddd; padding-top: 20px;">
                    <button onclick="goToStep2()" style="padding: 10px 20px; border: none; background: #007bff; color: white; border-radius: 4px; cursor: pointer; margin: 0 5px;">Îã§Ïùå Îã®Í≥Ñ ‚Üí</button>
                    <button onclick="closeSubjectAddModal()" style="padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; margin: 0 5px;">Ï∑®ÏÜå</button>
                </div>
            </div>

            <!-- 2Îã®Í≥Ñ: ÏàòÌñâÏòÅÏó≠ ÏÑ§Ï†ï -->
            <div id="step2AreaSetup" style="display: none;">
                <h3 style="margin: 0 0 20px 0; color: #007bff;">üéØ 2Îã®Í≥Ñ: ÏàòÌñâÏòÅÏó≠ ÏÑ§Ï†ï</h3>
                <div id="areaSetupContent">
                    <!-- ÏàòÌñâÏòÅÏó≠ Í¥ÄÎ†® ÎÇ¥Ïö©Ïù¥ ÌëúÏãúÎê©ÎãàÎã§ -->
                </div>

                <div style="text-align: center; border-top: 1px solid #ddd; padding-top: 20px;">
                    <button onclick="goBackToStep1()" style="padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; margin: 0 5px;">‚Üê Ïù¥Ï†Ñ</button>
                    <button onclick="finalizeSubjectAddition()" style="padding: 10px 20px; border: none; background: #28a745; color: white; border-radius: 4px; cursor: pointer; margin: 0 5px;">‚úì Í≥ºÎ™© Ï∂îÍ∞Ä</button>
                    <button onclick="closeSubjectAddModal()" style="padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; margin: 0 5px;">Ï∑®ÏÜå</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÏàòÌñâÏòÅÏó≠ ÏûêÎèô Ï∂îÍ∞Ä Î™®Îã¨ -->
    <div id="autoAreaModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; width: 500px; max-width: 90%; max-height: 90vh; overflow-y: auto;">
            <h3 style="margin: 0 0 20px 0; color: #007bff;">üéØ ÏàòÌñâÏòÅÏó≠ ÏûêÎèô Ï∂îÍ∞Ä</h3>
            <div id="autoAreaInfo">
                <!-- ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±ÎêòÎäî Í≥ºÎ™© Ï†ïÎ≥¥ -->
            </div>

            <div style="text-align: center; margin-top: 30px; border-top: 1px solid #ddd; padding-top: 20px;">
                <button onclick="confirmAutoAreaAddition()" id="confirmAutoBtn" style="padding: 10px 20px; border: none; background: #28a745; color: white; border-radius: 4px; cursor: pointer; margin: 0 5px;">‚úì ÏûêÎèô Ï∂îÍ∞Ä</button>
                <button onclick="addSubjectWithoutAreas()" id="addWithoutAreasBtn" style="padding: 10px 20px; border: none; background: #007bff; color: white; border-radius: 4px; cursor: pointer; margin: 0 5px;">üìù ÏßÅÏ†ë ÏûÖÎ†•</button>
                <button onclick="closeAutoAreaModal()" style="padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; margin: 0 5px;">Ï∑®ÏÜå</button>
            </div>
        </div>
    </div>

    <!-- Firebase ÏÑ§Ï†ï Î™®Îã¨ -->
    <div id="firebaseSettingsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; width: 450px; max-width: 90%;">
            <h3 style="margin: 0 0 20px 0; color: #007bff;">üîß Firebase ÏÑ§Ï†ï</h3>

            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; line-height: 1.6;">
                <strong>üìñ ÏÑ§Ï†ï Î∞©Î≤ï:</strong><br>
                1. <a href="https://console.firebase.google.com/" target="_blank" style="color: #3b82f6;">Firebase Console</a>ÏóêÏÑú ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ±<br>
                2. Realtime Database ÌôúÏÑ±Ìôî (Asia Southeast1 - Ïã±Í∞ÄÌè¨Î•¥)<br>
                3. ÌîÑÎ°úÏ†ùÌä∏ ÏÑ§Ï†ï ‚Üí Ïõπ Ïï± Ï∂îÍ∞Ä ‚Üí Íµ¨ÏÑ± Ï†ïÎ≥¥ÏóêÏÑú Î≥µÏÇ¨
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">API Key:</label>
                <input type="text" id="firebaseApiKey" placeholder="AIzaSyC..."
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Project ID:</label>
                <input type="text" id="firebaseProjectId" placeholder="your-project-id"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
            </div>

            <div id="connectionStatus" style="margin: 15px 0; padding: 10px; border-radius: 4px; display: none;"></div>

            <div style="margin-bottom: 15px; padding: 15px; background: #e8f4f8; border-radius: 6px; border: 1px solid #bee5eb;">
                <h4 style="margin: 0 0 10px 0; color: #0c5460;">üéì ÌïôÏÉùÏö© ÎßÅÌÅ¨ ÏÉùÏÑ±</h4>
                <p style="margin: 0 0 10px 0; font-size: 14px; color: #666;">Firebase ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•Îêú ÌõÑ ÌïôÏÉùÎì§Ïù¥ ÏÇ¨Ïö©Ìï† Ïàò ÏûàÎäî ÎßÅÌÅ¨Î•º ÏÉùÏÑ±Ìï† Ïàò ÏûàÏäµÎãàÎã§.</p>
                <button onclick="generateStudentLink()" style="padding: 8px 16px; border: none; background: #17a2b8; color: white; border-radius: 4px; cursor: pointer; font-size: 14px;">üîó ÌïôÏÉùÏö© ÎßÅÌÅ¨ ÏÉùÏÑ±</button>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeFirebaseModal()" style="padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">Ï∑®ÏÜå</button>
                <button onclick="testFirebaseConnection()" style="padding: 10px 20px; border: none; background: #28a745; color: white; border-radius: 4px; cursor: pointer;">üîç Ïó∞Í≤∞ ÌÖåÏä§Ìä∏</button>
                <button onclick="saveUserFirebaseConfig()" style="padding: 10px 20px; border: none; background: #007bff; color: white; border-radius: 4px; cursor: pointer;">üíæ Ï†ÄÏû•</button>
            </div>
        </div>
    </div>

    <!-- QR ÏΩîÎìú Î™®Îã¨ -->
    <div id="qrModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 12px; width: 400px; max-width: 90%; text-align: center;">
            <h3 style="margin: 0 0 20px 0; color: #007bff;">üì± ÌïôÏÉù Ï†ëÏÜçÏö© QR ÏΩîÎìú</h3>

            <p style="color: #666; margin-bottom: 20px;">ÌïôÏÉùÎì§ÏóêÍ≤å Ïù¥ QR ÏΩîÎìúÎ•º Î≥¥Ïó¨Ï£ºÏñ¥ Ï†êÏàò Ï°∞Ìöå ÏãúÏä§ÌÖúÏóê Ï†ëÏÜçÌïòÍ≤å ÌïòÏÑ∏Ïöî.</p>

            <div id="qr-container" style="margin: 20px 0; min-height: 250px; display: flex; align-items: center; justify-content: center; border: 2px dashed #ddd; border-radius: 8px;">
                <div style="color: #999;">QR ÏΩîÎìú ÏÉùÏÑ± Ï§ë...</div>
            </div>

            <div style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                <p style="margin: 0 0 5px 0; font-size: 12px; color: #666;">ÏßÅÏ†ë Ï†ëÏÜç ÎßÅÌÅ¨:</p>
                <a id="qr-url" href="#" target="_blank" style="color: #007bff; font-size: 12px; word-break: break-all;"></a>
            </div>

            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button onclick="closeQRModal()" style="padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">Îã´Í∏∞</button>
                <button onclick="copyQRLink()" style="padding: 10px 20px; border: none; background: #28a745; color: white; border-radius: 4px; cursor: pointer;">üìã ÎßÅÌÅ¨ Î≥µÏÇ¨</button>
            </div>
        </div>
    </div>


    <script>
        // Ï†ÑÏó≠ Îç∞Ïù¥ÌÑ∞
        let students = {}; // ÌïôÎ≤à: {name: "Ïù¥Î¶Ñ", grade: 3, class: 1, number: 1}
        let subjects = {}; // "ÌïôÎÖÑ-Í≥ºÎ™©" ÌòïÌÉú: {"3-ÏÇ¨Ìöå": {areas: [{name: "ÏòÅÏó≠Î™Ö", maxScore: 20}]}}
        let scores = {}; // "ÌïôÎÖÑ-Í≥ºÎ™©" ÌòïÌÉú: {"3-ÏÇ¨Ìöå": {ÌïôÎ≤à: {ÏòÅÏó≠Î™Ö: Ï†êÏàò}}}
        let publishedSubjects = {}; // "ÌïôÎÖÑ-Í≥ºÎ™©" ÌòïÌÉú: {"3-ÏÇ¨Ìöå": true/false} - Ï†êÏàò Í≥µÍ∞ú Ïó¨Î∂Ä (UI ÌëúÏãúÏö©)
        let studentChecked = {}; // "ÌïôÎÖÑ-Í≥ºÎ™©" ÌòïÌÉú: {"3-ÏÇ¨Ìöå": {ÌïôÎ≤à: {ÏòÅÏó≠Î™Ö: true/false}}} - ÌïôÏÉù ÌôïÏù∏ ÏÉÅÌÉú
        let studentQuestions = {}; // "ÌïôÎÖÑ-Í≥ºÎ™©" ÌòïÌÉú: {"3-ÏÇ¨Ìöå": {ÌïôÎ≤à: {ÏòÅÏó≠Î™Ö: true/false}}} - ÌïôÏÉù Î¨∏Ïùò ÏÉÅÌÉú
        let currentGrade = 3;
        let currentEditingStudent = null;
        let currentSubject = '';
        let currentScoreSubject = '';

        // Firebase Ïã§ÏãúÍ∞Ñ Î¶¨Ïä§ÎÑàÎì§ÏùÑ Ï†ÄÏû•Ìï† Î≥ÄÏàò
        let firebaseListeners = {};

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        window.onload = async function() {
            await loadStudents();
            await loadSubjects();
            await loadScores();
            loadPublishedSubjects();
            await loadStudentChecked();
            await loadStudentQuestions();

            // Î™®Îì† Í≥ºÎ™©Ïùò Í∏∞Î≥∏Í∞íÏùÑ ÌóàÏö©ÏúºÎ°ú ÏÑ§Ï†ï
            setDefaultPublishStatus();

            setupDragAndDrop();
            setupStudentUploadDragAndDrop();
            updateMatrix();
            updateSubjectSelectors();

            // Firebase ÏûêÎèô Ï¥àÍ∏∞Ìôî ÏãúÎèÑ
            await autoInitializeFirebase();
        };

        // Î™®Îì† Í≥ºÎ™©Ïùò Î∞úÌñâ ÏÉÅÌÉúÎ•º Í∏∞Î≥∏Í∞í(ÌóàÏö©)ÏúºÎ°ú ÏÑ§Ï†ï
        function setDefaultPublishStatus() {
            // Ïù¥ÎØ∏ Ï¥àÍ∏∞ÌôîÌñàÎäîÏßÄ ÌôïÏù∏
            const hasInitialized = localStorage.getItem('publishStatusInitialized');
            if (hasInitialized) return;

            Object.keys(subjects).forEach(subjectKey => {
                // undefinedÏù∏ Í≥ºÎ™©Îßå ÎπÑÌóàÏö©ÏúºÎ°ú ÏÑ§Ï†ï
                if (publishedSubjects[subjectKey] === undefined) {
                    publishedSubjects[subjectKey] = false;
                }
            });

            // Ï¥àÍ∏∞Ìôî ÏôÑÎ£å ÌëúÏãú
            localStorage.setItem('publishStatusInitialized', 'true');
            savePublishedSubjects();
        }

        // Firebase ÏûêÎèô Ï¥àÍ∏∞Ìôî
        async function autoInitializeFirebase() {
            const savedURL = localStorage.getItem('userDatabaseURL');

            if (savedURL) {
                showConnectionStatus('üîó Firebase Ïó∞Í≤∞ Ï§ë...', 'warning');

                const success = await window.initializeFirebase();

                if (success) {
                    showConnectionStatus('üü¢ Firebase Ïó∞Í≤∞Îê®', 'success');
                    setupFirebaseListeners();

                    // Firebase Ïó∞Í≤∞ ÌõÑ Îç∞Ïù¥ÌÑ∞ Îã§Ïãú Î∂àÎü¨Ïò§Í∏∞
                    await loadStudents();
                    await loadSubjects();
                    await loadScores();
                    await loadStudentChecked();
                    await loadStudentQuestions();
                } else {
                    showConnectionStatus('‚ùå Firebase Ïó∞Í≤∞ Ïã§Ìå®', 'error');
                }
            } else {
                showConnectionStatus('‚öôÔ∏è Firebase ÏÑ§Ï†ï ÌïÑÏöî', 'warning');
            }
        }

        // ÌÉ≠ Ï†ÑÌôò
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tab + '-content').classList.add('active');

            if (tab === 'subjects') {
                updateSubjectSelectors();
            }
        }

        // ÌïôÎÖÑ Ï†ÑÌôò
        function switchGrade(grade) {
            currentGrade = grade;

            document.querySelectorAll('.grade-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`grade${grade}-tab`).classList.add('active');

            updateMatrix();
        }

        // ÌïôÎ≤à ÌååÏã± Ìï®Ïàò
        function parseStudentNumber(studentNumber) {
            const str = String(studentNumber);
            if (str.length !== 5) return null;

            const grade = parseInt(str.substring(0, 1));
            const classNum = parseInt(str.substring(1, 3));
            const number = parseInt(str.substring(3, 5));

            if (grade < 1 || grade > 3 || classNum < 1 || classNum > 20 || number < 1 || number > 40) {
                return null;
            }

            return { grade, class: classNum, number };
        }

        // ===== ÌïôÏÉù Í¥ÄÎ¶¨ Í∏∞Îä• =====

        // ÌïôÏÉù Ï∂îÍ∞Ä
        function addStudent() {
            const numberInput = document.getElementById('studentNumber');
            const nameInput = document.getElementById('studentName');

            const studentNumber = numberInput.value.trim();
            const name = nameInput.value.trim();

            if (!studentNumber || !name) {
                alert('ÌïôÎ≤àÍ≥º Ïù¥Î¶ÑÏùÑ Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            const parsed = parseStudentNumber(studentNumber);
            if (!parsed) {
                alert('Ïò¨Î∞îÎ•∏ ÌïôÎ≤à ÌòïÏãùÏù¥ ÏïÑÎãôÎãàÎã§. (Ïòà: 30101)');
                return;
            }

            if (students[studentNumber]) {
                alert('Ïù¥ÎØ∏ Îì±Î°ùÎêú ÌïôÎ≤àÏûÖÎãàÎã§.');
                return;
            }

            students[studentNumber] = {
                name: name,
                grade: parsed.grade,
                class: parsed.class,
                number: parsed.number,
                password: generateDefaultPassword(studentNumber) // Í∏∞Î≥∏ ÎπÑÎ∞ÄÎ≤àÌò∏ ÏÉùÏÑ±
            };

            numberInput.value = '';
            nameInput.value = '';

            updateStats();
            updateMatrix();
            saveStudents();
            updateTemplateButton();
        }

        // ÌïôÏÉù Ï†ïÎ≥¥ ÏàòÏ†ï/ÏÇ≠Ï†ú Î™®Îã¨ Ïó¥Í∏∞
        function openStudentModal(studentNumber) {
            if (!students[studentNumber]) return;

            currentEditingStudent = studentNumber;
            const student = students[studentNumber];
            const parsed = parseStudentNumber(studentNumber);

            document.getElementById('modalStudentInfo').textContent =
                `${parsed.grade}ÌïôÎÖÑ ${parsed.class}Î∞ò ${parsed.number}Î≤à (${studentNumber})`;
            document.getElementById('modalStudentName').value = student.name;

            // ÎπÑÎ∞ÄÎ≤àÌò∏ ÌëúÏãú
            const password = student.password || generateDefaultPassword(studentNumber);
            document.getElementById('modalStudentPassword').value = password;

            // ÎπÑÎ∞ÄÎ≤àÌò∏ ÌïÑÎìúÎ•º Ï≤òÏùåÏóêÎäî Ïà®ÍπÄ ÏÉÅÌÉúÎ°ú
            document.getElementById('modalStudentPassword').type = 'password';
            document.getElementById('togglePasswordBtn').textContent = 'üëÅÔ∏è';

            document.getElementById('studentModal').style.display = 'block';
        }

        // ÌïôÏÉù Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
        function updateStudent() {
            if (!currentEditingStudent) return;

            const newName = document.getElementById('modalStudentName').value.trim();
            if (!newName) {
                alert('Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            students[currentEditingStudent].name = newName;
            closeModal();
            updateMatrix();
            saveStudents();
        }

        // ÌïôÏÉù ÏÇ≠Ï†ú
        function deleteStudent() {
            if (!currentEditingStudent) return;

            const student = students[currentEditingStudent];
            if (!confirm(`${student.name} ÌïôÏÉùÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return;

            delete students[currentEditingStudent];

            // Î™®Îì† Í≥ºÎ™©Ïùò Ï†êÏàòÏóêÏÑú Ìï¥Îãπ ÌïôÏÉù ÏÇ≠Ï†ú
            Object.keys(scores).forEach(subject => {
                delete scores[subject][currentEditingStudent];
            });

            closeModal();
            updateStats();
            updateMatrix();
            saveStudents();
            saveScores();
        }

        // Î™®Îã¨ Îã´Í∏∞
        function closeModal() {
            document.getElementById('studentModal').style.display = 'none';
            currentEditingStudent = null;
        }

        // ÌïôÍ∏â Îß§Ìä∏Î¶≠Ïä§ ÏóÖÎç∞Ïù¥Ìä∏
        function updateMatrix() {
            const container = document.getElementById('matrixContainer');

            // ÌòÑÏû¨ ÌïôÎÖÑÏùò ÌïôÏÉùÎì§ ÌïÑÌÑ∞ÎßÅ
            const gradeStudents = Object.entries(students).filter(([num, student]) =>
                student.grade === currentGrade
            );

            if (gradeStudents.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h4>${currentGrade}ÌïôÎÖÑÏóê Îì±Î°ùÎêú ÌïôÏÉùÏù¥ ÏóÜÏäµÎãàÎã§</h4>
                        <p>ÏúÑÏùò ÌïôÏÉù Îì±Î°ù Í∏∞Îä•ÏùÑ Ïù¥Ïö©Ìï¥ ÌïôÏÉùÏùÑ Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî.</p>
                    </div>
                `;
                return;
            }

            // ÏµúÎåÄ Î∞ò ÏàòÏôÄ Î≤àÌò∏ Ïàò Í≥ÑÏÇ∞
            const maxClass = Math.max(...gradeStudents.map(([num, student]) => student.class));
            const maxNumber = Math.max(...gradeStudents.map(([num, student]) => student.number));

            // ÌÖåÏù¥Î∏î ÏÉùÏÑ±
            let html = '<table class="matrix-table"><thead><tr>';
            html += '<th class="row-header">Î≤àÌò∏</th>';

            for (let c = 1; c <= maxClass; c++) {
                html += `<th>${c}Î∞ò</th>`;
            }
            html += '</tr></thead><tbody>';

            for (let n = 1; n <= maxNumber; n++) {
                html += `<tr><td class="row-header">${n}Î≤à</td>`;

                for (let c = 1; c <= maxClass; c++) {
                    const studentNumber = `${currentGrade}${c.toString().padStart(2, '0')}${n.toString().padStart(2, '0')}`;
                    const student = students[studentNumber];

                    if (student) {
                        html += `<td class="student-cell filled" onclick="openStudentModal('${studentNumber}')" title="ÌÅ¥Î¶≠ÌïòÏó¨ ÏàòÏ†ï">${student.name}</td>`;
                    } else {
                        html += `<td class="student-cell empty">-</td>`;
                    }
                }
                html += '</tr>';
            }

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        function updateStats() {
            const totalCount = Object.keys(students).length;

            const gradeStats = {};
            Object.values(students).forEach(student => {
                if (!gradeStats[student.grade]) gradeStats[student.grade] = 0;
                gradeStats[student.grade]++;
            });

            // ÌïôÎÖÑÎ≥Ñ ÌÉ≠Ïóê ÌïôÏÉù Ïàò ÌëúÏãú
            [1, 2, 3].forEach(grade => {
                const tab = document.getElementById(`grade${grade}-tab`);
                const count = gradeStats[grade] || 0;
                if (count > 0) {
                    tab.textContent = `${grade}ÌïôÎÖÑ(${count}Î™Ö)`;
                } else {
                    tab.textContent = `${grade}ÌïôÎÖÑ`;
                }
            });
        }

        // ===== Í≥ºÎ™© Í¥ÄÎ¶¨ Í∏∞Îä• =====

        // Ï†ÑÏó≠ Î≥ÄÏàòÎ°ú ÌòÑÏû¨ Ï∂îÍ∞ÄÌïòÎ†§Îäî Í≥ºÎ™© Ï†ïÎ≥¥ Ï†ÄÏû•
        let pendingSubject = null;

        // 2025ÌïôÎÖÑÎèÑ 2ÌïôÍ∏∞ ÌèâÍ∞ÄÍ≥ÑÌöç Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ (Ï†ÑÏó≠ Î≥ÄÏàò)
        const evaluationPlan = {
                // 1ÌïôÎÖÑ Í≥ºÎ™©Îì§ (Ïã§Ï†ú PDF Îç∞Ïù¥ÌÑ∞)
                '1-Íµ≠Ïñ¥': [
                    { name: 'ÏÑúÌèâ Ïì∞Í∏∞', maxScore: 30 },
                    { name: 'Îã®Ïñ¥Ïùò ÏÑ∏Í≥Ñ ÌÉêÍµ¨ÌïòÍ∏∞', maxScore: 20 }
                ],
                '1-ÎèÑÎçï': [
                    { name: 'ÏπúÍµ¨ Í∞ÑÏóê ÎØøÏùå ÏåìÏïÑ Í∞ÄÍ∏∞', maxScore: 20 },
                    { name: 'Í∞ÄÏÉÅ Í≥µÍ∞Ñ ÏÜç ÎèÑÎçï Î¨∏Ï†úÏùò Ìï¥Í≤∞ Î∞©Ïïà Î™®ÏÉâÌïòÍ∏∞', maxScore: 20 },
                    { name: 'ÎîúÎ†àÎßà ÌÜ†Î°†', maxScore: 20 },
                    { name: 'Î≥¥Ìé∏Ï†Å Ïù∏Í∂åÍ≥º Î¨∏Ìôî¬∑Ï¢ÖÍµêÏùò Ï°∞ÌôîÎ•º Ïù¥Î£®Ïñ¥ Í∞ÄÍ∏∞', maxScore: 20 },
                    { name: 'ÌÉÄÏù∏Í≥ºÏùò Í¥ÄÍ≥Ñ ÏÇ¨ÌöåÍ≥µÎèôÏ≤¥ ÌïôÏäµÏûêÎ£å Ìè¨Ìä∏Ìè¥Î¶¨Ïò§', maxScore: 20 }
                ],
                '1-ÏÇ¨Ìöå': [
                    { name: 'Î™®ÏùòÏû¨Ìåê', maxScore: 30 },
                    { name: 'ÎÖ∏ÎèôÏù∏Í∂å ÎèÖÏÑúÎÖºÏà†', maxScore: 20 },
                    { name: 'ÏÑ∏Í≥ÑÏãúÎØº ÌîÑÎ°úÏ†ùÌä∏', maxScore: 30 },
                    { name: 'ÏÇ¨ÌöåÎ∞∞ÏõÄÏùºÍ∏∞', maxScore: 20 }
                ],
                '1-ÏàòÌïô': [
                    { name: 'Í∏∞Î≥∏ ÎèÑÌòï ÌÉêÍµ¨ÌïòÍ∏∞', maxScore: 30 },
                    { name: 'ÏàòÌïôÎ¨∏Ï†úÌï¥Í≤∞ Í≥ºÏ†ïÌèâÍ∞Ä', maxScore: 20 }
                ],
                '1-Í≥ºÌïô': [
                    { name: 'Ïò®ÎèÑÏôÄ Ïó¥ÌèâÌòï ÌÉêÍµ¨ÌïòÍ∏∞', maxScore: 20 },
                    { name: 'Í∏∞Ï≤¥Ïùò ÏïïÎ†•Í≥º Î∂ÄÌîº Í¥ÄÍ≥Ñ ÌÉêÍµ¨ÌïòÍ∏∞', maxScore: 20 },
                    { name: 'Í≥ºÌïôÎ¨∏Ï†úÌï¥Í≤∞Í≥ºÏ†ïÌèâÍ∞Ä', maxScore: 10 }
                ],
                '1-Í∏∞Ïà†Í∞ÄÏ†ï': [
                    { name: 'Ï≤≠ÏÜåÎÖÑÍ∏∞ ÏòÅÏñëÌîÑÎ°úÏ†ùÌä∏', maxScore: 40 },
                    { name: 'ÏòÅÏñëÏÜå ÌÉÄÏù¥Ìè¨Í∑∏ÎûòÌîº', maxScore: 20 },
                    { name: 'ÏÉùÌôú ÏÜç Î¨∏Ï†úÌï¥Í≤∞ Î∞úÎ™ÖÌïòÍ∏∞', maxScore: 40 }
                ],
                '1-Ï≤¥Ïú°': [
                    { name: 'ÌîåÎùºÏûâÎîîÏä§ÌÅ¨', maxScore: 30 },
                    { name: 'Î∞∞ÎìúÎØºÌÑ¥', maxScore: 20 },
                    { name: 'Ï≤¥Î†• Ï¶ùÏßÑ', maxScore: 20 },
                    { name: 'ÌÉÅÍµ¨', maxScore: 30 }
                ],
                '1-ÏùåÏïÖ': [
                    { name: 'Î¶¨Îì¨ ÏãúÏ∞ΩÍ≥º ÏÑ†Ïú® Ï≤≠Ïùå', maxScore: 25 },
                    { name: 'ÏªµÌÉÄ Ïó∞Ï£ºÌïòÍ∏∞', maxScore: 30 },
                    { name: 'ÏùåÏïÖ Í∞êÏÉÅÎ¨∏ ÏûëÏÑ±ÌïòÍ∏∞', maxScore: 30 },
                    { name: 'ÏùåÏïÖÌïôÏäµ Í≥ºÏ†ïÌèâÍ∞Ä', maxScore: 15 }
                ],
                '1-ÎØ∏Ïà†': [
                    { name: 'Ïù¥Î™®Ìã∞ÏΩò ÎîîÏûêÏù∏', maxScore: 30 },
                    { name: 'ÍµøÏ¶à Ï†úÏûë', maxScore: 30 },
                    { name: 'ÌôïÏû•Ìòï ÎìúÎ°úÏûâ', maxScore: 20 },
                    { name: 'ÎØ∏Ïà† Í∞êÏÉÅ', maxScore: 20 }
                ],
                '1-ÏòÅÏñ¥': [
                    { name: 'Îì£Í∏∞', maxScore: 10 },
                    { name: 'ÏÉÅÌô©Ïóê Îî∞Î•∏ ÎßêÌïòÍ∏∞', maxScore: 20 },
                    { name: 'ÏùòÎØ∏Ïóê ÎßûÍ≤å ÏòÅÏûëÌïòÍ∏∞', maxScore: 20 }
                ],
                '1-Ï†ïÎ≥¥': [
                    { name: 'ÌîÑÎ°úÍ∑∏ÎûòÎ∞ç', maxScore: 25 },
                    { name: 'Ïù∏Í≥µÏßÄÎä• Í∏∞Îä• ÌÉêÍµ¨ÌïòÍ∏∞', maxScore: 25 },
                    { name: 'Ïù∏Í≥µÏßÄÎä• Îç∞Ïù¥ÌÑ∞ ÌôúÏö©Ïùò Ïú§Î¶¨Ï†Å ÏüÅÏ†ê Îã§Î£®Í∏∞', maxScore: 25 },
                    { name: 'ÌîºÏßÄÏª¨ Ïª¥Ìì®ÌåÖ ÌÉêÍµ¨', maxScore: 25 }
                ],

                // 2ÌïôÎÖÑ Í≥ºÎ™©Îì§
                '2-Íµ≠Ïñ¥': [
                    { name: 'ÏÑúÌèâÏì∞Í∏∞', maxScore: 20 },
                    { name: 'ÏÑ§Î™ÖÌïòÎäî Í∏ÄÏì∞Í∏∞', maxScore: 15 },
                    { name: 'Íµ≠Ïñ¥Ïó≠ÎüâÍ≥ºÏ†ïÌèâÍ∞Ä', maxScore: 15 }
                ],
                '2-ÎèÑÎçï': [
                    { name: 'ÌôòÍ≤ΩÎ≥¥Í≥†ÏÑú ÏûëÏÑ±ÌïòÍ∏∞', maxScore: 20 },
                    { name: 'ÏùòÎØ∏ÏûàÎäî ÏÇ∂ÏùÑ ÏúÑÌïú Ï±Ö ÏÜåÍ∞úÌïòÍ∏∞', maxScore: 20 },
                    { name: 'ÏÉùÍ∞ÅÎÇòÎàî Ìè¨Ìä∏Ìè¥Î¶¨Ïò§', maxScore: 10 }
                ],
                '2-ÏàòÌïô': [
                    { name: 'ÏÇºÍ∞ÅÌòïÏùò ÏÑ±Ïßà ÌÉêÍµ¨ÌïòÍ∏∞', maxScore: 20 },
                    { name: 'ÎèÑÌòïÏùò ÎãÆÏùå ÌôúÏö©ÌïòÍ∏∞', maxScore: 20 },
                    { name: 'ÏàòÌïôÎ¨∏Ï†úÌï¥Í≤∞ Í≥ºÏ†ïÌèâÍ∞Ä', maxScore: 10 }
                ],
                '2-Í≥ºÌïô': [
                    { name: 'Í¥ëÌï©ÏÑ±Ïùò Í≥ºÏ†ï ÌÉêÍµ¨ÌïòÍ∏∞ Ïã§Ìóò', maxScore: 20 },
                    { name: 'ÏÜåÌôîÏôÄ ÏàúÌôòÏùò Í≥ºÏ†ï Ïù¥Ìï¥ÌïòÍ∏∞', maxScore: 30 }
                ],
                '2-Í∏∞Ïà†Í∞ÄÏ†ï': [
                    { name: 'Ï†ÑÍ∏∞ÏûêÎèôÏ∞® ÎßåÎì§Í∏∞', maxScore: 30 },
                    { name: 'ÏÉùÌôú ÏÜç Ïã†Ïû¨ÏÑ±ÏóêÎÑàÏßÄ ÌÉêÍµ¨ÌïòÍ∏∞', maxScore: 20 },
                    { name: 'ÌÉÑÏÜåÏ§ëÎ¶Ω Ïñ¥ÎÑ§ÏßÄ ÏûêÎ¶Ω Ï£ºÌÉù Î™®Ìòï ÎßåÎì§Í∏∞', maxScore: 30 },
                    { name: 'ÏÉùÎ™ÖÍ∏∞Ïà†Ïùò Í∏çÏ†ïÏ†ÅÏù∏ ÏòÅÌñ•Í≥º Î∂ÄÏ†ïÏ†ÅÏù∏ ÏòÅÌñ• ÌÉêÏÉâÌïòÍ∏∞', maxScore: 20 }
                ],
                '2-Ï≤¥Ïú°': [
                    { name: 'Ï†úÏûêÎ¶¨ Î©ÄÎ¶¨Îõ∞Í∏∞', maxScore: 20 },
                    { name: 'Î∞∞ÎìúÎØºÌÑ¥ Ïä§Ìä∏Î°úÌÅ¨ÌïòÍ∏∞', maxScore: 30 },
                    { name: 'Ìã∞Î≥º ÎçòÏßÄÍ∏∞', maxScore: 30 },
                    { name: 'Î∞∞ÎìúÎØºÌÑ¥ Í≤ΩÍ∏∞ÌïòÍ∏∞', maxScore: 20 }
                ],
                '2-ÎØ∏Ïà†': [
                    { name: 'ÏÑúÏñëÎØ∏Ïà† Ïû¨Ìï¥ÏÑù', maxScore: 20 },
                    { name: 'ÌÑ∞ÎÑêÎ∂Å Ï†úÏûë', maxScore: 30 },
                    { name: 'Ïù∏ÏÑ±Î°úÍ≥† ÏïÑÏù¥ÎîîÏñ¥Ïä§ÏºÄÏπò', maxScore: 20 },
                    { name: 'Ïù∏ÏÑ±Î°úÍ≥† ÌåêÌôîÏ†úÏûë', maxScore: 30 }
                ],
                '2-ÏòÅÏñ¥': [
                    { name: 'Îì£Í∏∞', maxScore: 10 },
                    { name: 'ÎßêÌïòÍ∏∞', maxScore: 10 },
                    { name: 'Î∞úÎ™ÖÌíà ÏÜåÍ∞úÌïòÍ∏∞', maxScore: 20 }
                ],
                '2-Ïó≠ÏÇ¨': [
                    { name: 'Í∑∏Î¶¨Ïä§, Î°úÎßà ÌåúÌîåÎ†õ Ï†úÏûëÌïòÍ∏∞', maxScore: 20 },
                    { name: 'Ïã†Ìï≠Î°ú Í∞úÏ≤ôÏóê ÎåÄÌïú ÎÖºÏà†ÌïòÍ∏∞', maxScore: 15 },
                    { name: 'Ïó≠ÏÇ¨ Î∞∞ÏõÄ Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ ÏûëÏÑ±ÌïòÍ∏∞', maxScore: 15 }
                ],
                '2-ÌïúÎ¨∏': [
                    { name: 'Í≥†ÏÇ¨ÏÑ±Ïñ¥ Î∞úÌëúÌïòÍ∏∞', maxScore: 10 },
                    { name: 'ÌïúÏûê ÏùΩÍ∏∞', maxScore: 10 },
                    { name: 'Ìò∏ÎèÑÏû• ÎßåÎì§Í∏∞', maxScore: 20 },
                    { name: 'ÌïúÏûê Ïì∞Í∏∞', maxScore: 10 }
                ],

                // 3ÌïôÎÖÑ Í≥ºÎ™©Îì§
                '3-Íµ≠Ïñ¥': [
                    { name: 'Ïö∞Î¶¨Îßê ÌÉêÍµ¨', maxScore: 20 },
                    { name: 'ÏÑúÌèâÏì∞Í∏∞', maxScore: 20 },
                    { name: 'Íµ≠Ïñ¥Ïó≠ÎüâÍ≥ºÏ†ïÌèâÍ∞Ä', maxScore: 10 }
                ],
                '3-ÏÇ¨Ìöå': [
                    { name: 'Ïù∏Íµ¨ ÌäπÏßïÍ≥º Ïù∏Íµ¨ Î¨∏Ï†ú Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ ÏûëÏÑ±', maxScore: 30 },
                    { name: 'ÏÑ∏Í≥Ñ ÎèÑÏãúÏôÄ ÎèÑÏãúÌôî Î¨∏Ï†ú Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ ÏûëÏÑ±', maxScore: 30 }
                ],
                '3-ÏàòÌïô': [
                    { name: 'ÏÇºÍ∞ÅÎπÑ ÌôúÏö©ÌïòÍ∏∞', maxScore: 20 },
                    { name: 'ÏõêÏ£ºÍ∞Å ÌÉêÍµ¨ÌïòÍ∏∞', maxScore: 20 },
                    { name: 'ÏàòÌïôÎ¨∏Ï†úÌï¥Í≤∞ Í≥ºÏ†ïÌèâÍ∞Ä', maxScore: 10 }
                ],
                '3-Í≥ºÌïô': [
                    { name: 'Ï≤¥ÏÑ∏Ìè¨Î∂ÑÏó¥Í≥º Í∞êÏàòÎ∂ÑÏó¥ Í≥ºÏ†ï Î∂ÑÏÑùÌïòÍ∏∞', maxScore: 30 },
                    { name: 'Î©òÎç∏Ïùò Ïú†Ï†Ñ ÏõêÎ¶¨ Ïù¥Ìï¥ÌïòÍ∏∞', maxScore: 20 }
                ],
                '3-Í∏∞Ïà†Í∞ÄÏ†ï': [
                    { name: 'Ï£ºÏÉùÌôú ÌîÑÎ°úÏ†ùÌä∏', maxScore: 15 },
                    { name: 'ÌôàÏ¶à Íµ¨Ìï¥Î≥¥Í∏∞', maxScore: 40 },
                    { name: 'ÏâêÏñ¥ÌïòÏö∞Ïä§ ÎîîÏûêÏù∏ÌïòÍ∏∞', maxScore: 25 },
                    { name: 'Ï£ºÍ±∞Ìä∏Î†åÎìú Ïã†Î¨∏ ÎßåÎì§Í∏∞', maxScore: 20 }
                ],
                '3-Ï≤¥Ïú°': [
                    { name: 'ÌÉÅÍµ¨ ÏÑúÎ∏å', maxScore: 30 },
                    { name: 'Ï§ÑÎÑòÍ∏∞', maxScore: 20 },
                    { name: 'ÌÉÅÍµ¨ Ìè¨Ìï∏Îìú Ïä§Ìä∏Î°úÌÅ¨', maxScore: 30 },
                    { name: 'ÏïàÏ†ÑÌôúÎèô', maxScore: 20 }
                ],
                '3-ÏùåÏïÖ': [
                    { name: 'Ïû•Íµ¨ Ïó∞Ï£ºÌïòÍ∏∞', maxScore: 30 },
                    { name: 'ÌåêÏÜåÎ¶¨ Î∂ÄÎ•¥Í∏∞', maxScore: 30 },
                    { name: 'Îã§ÏñëÌïú Ïû•Î•¥Ïùò Íµ≠ÏïÖ Í∞êÏÉÅÌïòÍ∏∞', maxScore: 25 },
                    { name: 'ÏùåÏïÖÌïôÏäµ Í≥ºÏ†ïÌèâÍ∞Ä', maxScore: 15 }
                ],
                '3-ÏòÅÏñ¥': [
                    { name: 'Îì£Í∏∞', maxScore: 10 },
                    { name: 'Ï£ºÏ†ú Í∏ÄÏì∞Í∏∞', maxScore: 20 },
                    { name: 'ÎßêÌïòÍ∏∞', maxScore: 20 }
                ],
                '3-Ïó≠ÏÇ¨': [
                    { name: 'Ïó≠ÏÇ¨ ÎèÖÏÑú ÏùºÏßÄ Ïì∞Í∏∞', maxScore: 20 },
                    { name: 'Ïó≠ÏÇ¨ ÏÑúÌèâ Ïì∞Í∏∞', maxScore: 20 },
                    { name: 'Í∏∞Î°ùÎ¨∏ÌôîÏ≤¥Ìóò', maxScore: 10 }
                ],
                '3-ÏÉùÌôúÏùºÎ≥∏Ïñ¥': [
                    { name: 'ÏùºÎ≥∏Ïñ¥ ÏûëÎ¨∏ÌïòÍ∏∞', maxScore: 40 },
                    { name: 'ÏùºÎ≥∏Ïñ¥Î°ú ÎßêÌïòÍ∏∞', maxScore: 20 },
                    { name: 'ÌïúÏùºÎ¨∏Ìôî ÎπÑÍµêÌÉêÍµ¨', maxScore: 20 },
                    { name: 'ÏùºÎ≥∏Ïñ¥ ÌôúÏö© Ìè¨Ìä∏Ìè¥Î¶¨Ïò§', maxScore: 20 }
                ],
                '3-ÏÉùÌôúÏ§ëÍµ≠Ïñ¥': [
                    { name: 'ÎÇòÏùò ÌïòÎ£® ÎîîÏûêÏù∏ÌïòÍ∏∞', maxScore: 30 },
                    { name: 'Ï§ëÍµ≠Ïñ¥Î°ú ÎßåÎÇòÎäî ÎÇò Ïä§ÌÜ†Î¶¨ÌÖîÎßÅ', maxScore: 30 },
                    { name: 'ÏùòÏÇ¨ÏÜåÌÜµÍ∏∞Î≥∏ÌëúÌòÑ ÎßêÌïòÍ∏∞', maxScore: 30 },
                    { name: 'ÌïôÏäµÌôúÎèôÌèâÍ∞Ä', maxScore: 10 }
                ]
            };


        // Í≥ºÎ™© Ï∂îÍ∞Ä Í¥ÄÎ†® Ï†ÑÏó≠ Î≥ÄÏàò
        let currentSubjectData = {};
        let selectedClassesForSubject = [];

        // Í≥ºÎ™© Ï∂îÍ∞Ä Îã®Í≥ÑÎ≥Ñ Î™®Îã¨ Ïó¥Í∏∞ (1Îã®Í≥Ñ: Î∞ò ÏÑ†ÌÉù)
        function openSubjectAddModal(grade, name, teacher) {
            currentSubjectData = { grade, name, teacher };

            // Í≥ºÎ™© Ï†ïÎ≥¥ ÌëúÏãú
            const infoDiv = document.getElementById('subjectInfoDisplay');
            const teacherText = teacher ? ` (${teacher})` : '';
            infoDiv.innerHTML = `
                <h5 style="margin: 0 0 5px 0; color: #007bff;">${grade}ÌïôÎÖÑ ${name}${teacherText}</h5>
                <p style="margin: 0; color: #666; font-size: 14px;">Îã¥Îãπ Î∞òÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.</p>
            `;

            // Ìï¥Îãπ ÌïôÎÖÑÏùò Î∞ò Î™©Î°ù Ï∂îÏ∂ú
            const classesInGrade = new Set();
            Object.entries(students).forEach(([studentNum, student]) => {
                if (student.grade === parseInt(grade)) {
                    classesInGrade.add(student.class);
                }
            });

            // Î∞ò Î™©Î°ùÏùÑ Ï†ïÎ†¨
            const sortedClasses = Array.from(classesInGrade).sort((a, b) => a - b);

            const contentDiv = document.getElementById('classSelectionContent');
            contentDiv.innerHTML = '';

            if (sortedClasses.length > 0) {
                sortedClasses.forEach(classNum => {
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `modalClass${classNum}`;
                    checkbox.value = classNum;
                    checkbox.style.marginRight = '8px';

                    const label = document.createElement('label');
                    label.htmlFor = `modalClass${classNum}`;
                    label.textContent = `${classNum}Î∞ò`;
                    label.style.cursor = 'pointer';

                    const wrapper = document.createElement('div');
                    wrapper.style.display = 'flex';
                    wrapper.style.alignItems = 'center';
                    wrapper.style.marginBottom = '10px';
                    wrapper.appendChild(checkbox);
                    wrapper.appendChild(label);

                    contentDiv.appendChild(wrapper);
                });
            } else {
                contentDiv.innerHTML = '<p style="color: #666; text-align: center;">Ìï¥Îãπ ÌïôÎÖÑÏóê Îì±Î°ùÎêú ÌïôÏÉùÏù¥ ÏóÜÏäµÎãàÎã§.</p>';
            }

            // 1Îã®Í≥Ñ ÌëúÏãú, 2Îã®Í≥Ñ Ïà®ÍπÄ
            document.getElementById('step1ClassSelection').style.display = 'block';
            document.getElementById('step2AreaSetup').style.display = 'none';

            document.getElementById('subjectAddModal').style.display = 'block';
        }

        // 2Îã®Í≥ÑÎ°ú Ïù¥Îèô (ÏàòÌñâÏòÅÏó≠ ÏÑ§Ï†ï)
        function goToStep2() {
            const checkboxes = document.querySelectorAll('#classSelectionContent input[type="checkbox"]:checked');
            selectedClassesForSubject = Array.from(checkboxes).map(cb => cb.value);

            if (selectedClassesForSubject.length === 0) {
                alert('ÏµúÏÜå ÌïòÎÇòÏùò Î∞òÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            // Í≥ºÎ™©ÌÇ§ ÏÉùÏÑ±
            const { grade, name, teacher } = currentSubjectData;
            const teacherPart = teacher ? `-${teacher}` : '';
            const classPart = selectedClassesForSubject.sort((a, b) => a - b).join(',');
            const subjectKey = `${grade}-${name}${teacherPart}-${classPart}`;

            if (subjects[subjectKey]) {
                alert('Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî Í≥ºÎ™©ÏûÖÎãàÎã§.');
                return;
            }

            // ÌèâÍ∞ÄÍ≥ÑÌöç Í≤ÄÏÉâ
            const basePlanKey = `${grade}-${name}`;
            let foundPlan = evaluationPlan[basePlanKey];

            if (!foundPlan) {
                for (const planKey in evaluationPlan) {
                    const basePlanSubject = planKey.split('-')[1];
                    if (name.includes(basePlanSubject) || name.startsWith(basePlanSubject)) {
                        foundPlan = evaluationPlan[planKey];
                        break;
                    }
                }
            }

            // 2Îã®Í≥Ñ ÎÇ¥Ïö© ÏÑ§Ï†ï
            const areaContent = document.getElementById('areaSetupContent');
            if (foundPlan) {
                const classText = selectedClassesForSubject.sort((a, b) => a - b).map(c => `${c}Î∞ò`).join(', ');
                const areasText = foundPlan.map(area => `‚Ä¢ ${area.name} (${area.maxScore}Ï†ê)`).join('<br>');
                const totalScore = foundPlan.reduce((sum, area) => sum + area.maxScore, 0);

                areaContent.innerHTML = `
                    <div style="background-color: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                        <h5 style="margin: 0 0 10px 0; color: #007bff;">${grade}ÌïôÎÖÑ ${name}${teacherPart} (${classText})</h5>
                        <p style="margin: 0 0 15px 0; color: #666;">2025ÌïôÎÖÑÎèÑ ÌèâÍ∞ÄÍ≥ÑÌöçÏóêÏÑú Îã§Ïùå ÏàòÌñâÏòÅÏó≠ÏùÑ Ï∞æÏïòÏäµÎãàÎã§:</p>
                        <div style="margin-bottom: 15px; line-height: 1.6;">
                            ${areasText}
                        </div>
                        <div style="font-weight: bold; color: #28a745;">
                            Ï¥ù ${totalScore}Ï†ê (${foundPlan.length}Í∞ú ÏòÅÏó≠)
                        </div>
                    </div>
                    <p style="color: #666; margin: 0;">ÏûêÎèôÏúºÎ°ú ÏàòÌñâÏòÅÏó≠ÏùÑ Ï∂îÍ∞ÄÌïòÏãúÍ≤†ÏäµÎãàÍπå?</p>
                `;
                currentSubjectData.planAreas = foundPlan;
                currentSubjectData.subjectKey = subjectKey;
            } else {
                const classText = selectedClassesForSubject.sort((a, b) => a - b).map(c => `${c}Î∞ò`).join(', ');
                areaContent.innerHTML = `
                    <div style="background-color: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                        <h5 style="margin: 0 0 10px 0; color: #007bff;">${grade}ÌïôÎÖÑ ${name}${teacherPart} (${classText})</h5>
                        <p style="margin: 0; color: #666;">ÌèâÍ∞ÄÍ≥ÑÌöçÏóê Îì±Î°ùÎêú ÏàòÌñâÏòÅÏó≠Ïù¥ ÏóÜÏäµÎãàÎã§.</p>
                    </div>
                    <p style="color: #666; margin: 0;">ÏàòÌñâÏòÅÏó≠ ÏóÜÏù¥ Í≥ºÎ™©Îßå Ï∂îÍ∞ÄÎê©ÎãàÎã§.</p>
                `;
                currentSubjectData.planAreas = null;
                currentSubjectData.subjectKey = subjectKey;
            }

            // 1Îã®Í≥Ñ Ïà®ÍπÄ, 2Îã®Í≥Ñ ÌëúÏãú
            document.getElementById('step1ClassSelection').style.display = 'none';
            document.getElementById('step2AreaSetup').style.display = 'block';
        }

        // 1Îã®Í≥ÑÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
        function goBackToStep1() {
            document.getElementById('step1ClassSelection').style.display = 'block';
            document.getElementById('step2AreaSetup').style.display = 'none';
        }

        // ÏµúÏ¢Ö Í≥ºÎ™© Ï∂îÍ∞Ä
        function finalizeSubjectAddition() {
            const { grade, name, teacher, planAreas, subjectKey } = currentSubjectData;

            if (planAreas) {
                // ÏûêÎèô ÏòÅÏó≠ Ï∂îÍ∞Ä
                subjects[subjectKey] = {
                    grade: parseInt(grade),
                    name: name,
                    areas: [...planAreas]
                };
            } else {
                // ÏòÅÏó≠ ÏóÜÏù¥ Í≥ºÎ™©Îßå Ï∂îÍ∞Ä
                subjects[subjectKey] = {
                    grade: parseInt(grade),
                    name: name,
                    areas: []
                };
            }

            scores[subjectKey] = {};

            // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
            clearSubjectForm();

            updateSubjectList();
            updateSubjectSelectors();
            saveSubjects();

            closeSubjectAddModal();

            const planText = planAreas ? `${planAreas.length}Í∞úÏùò ÏàòÌñâÏòÅÏó≠Ïù¥ ÏûêÎèôÏúºÎ°ú ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§.` : 'ÏàòÌñâÏòÅÏó≠ ÏóÜÏù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.';
            alert(`${grade}ÌïôÎÖÑ ${name} Í≥ºÎ™©Ïù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.\n${planText}`);
        }

        // Î™®Îã¨ Îã´Í∏∞
        function closeSubjectAddModal() {
            document.getElementById('subjectAddModal').style.display = 'none';
            currentSubjectData = {};
            selectedClassesForSubject = [];
        }

        // Í≥ºÎ™© ÏûÖÎ†• Ìèº Ï¥àÍ∏∞Ìôî
        function clearSubjectForm() {
            document.getElementById('subjectName').value = '';
            document.getElementById('teacherName').value = '';
        }

        // Í≥ºÎ™© Ï∂îÍ∞Ä
        function addSubject() {
            const gradeSelect = document.getElementById('subjectGrade');
            const nameInput = document.getElementById('subjectName');
            const teacherInput = document.getElementById('teacherName');

            const grade = gradeSelect.value;
            const name = nameInput.value.trim();
            const teacher = teacherInput.value.trim();

            if (!name) {
                alert('Í≥ºÎ™©Î™ÖÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            // Îã®Í≥ÑÎ≥Ñ Î™®Îã¨ Ïó¥Í∏∞
            openSubjectAddModal(grade, name, teacher);
        }



        // Í≥ºÎ™© Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏ (ÌïôÎÖÑÎ≥ÑÎ°ú Í∞ÄÎ°ú 3Îì±Î∂ÑÌïòÏó¨ ÌëúÏãú)
        function updateSubjectList() {
            const container = document.getElementById('subjectList');
            container.innerHTML = '';

            // ÌïôÎÖÑÎ≥ÑÎ°ú Í∑∏Î£πÌïëÌï¥ÏÑú Ï†ïÎ†¨
            const groupedSubjects = {};
            Object.keys(subjects).forEach(subjectKey => {
                const subject = subjects[subjectKey];
                if (!groupedSubjects[subject.grade]) {
                    groupedSubjects[subject.grade] = [];
                }
                groupedSubjects[subject.grade].push({key: subjectKey, data: subject});
            });

            // Í∞ÄÎ°ú 3Îì±Î∂Ñ Î†àÏù¥ÏïÑÏõÉÏúºÎ°ú ÌïôÎÖÑÎ≥Ñ ÌëúÏãú
            const gradeRow = document.createElement('div');
            gradeRow.className = 'grade-row';

            [3, 2, 1].forEach(grade => {
                const gradeColumn = document.createElement('div');
                gradeColumn.className = `grade-column grade-${grade}`;

                const gradeTitle = document.createElement('h5');
                gradeTitle.innerHTML = `${grade}ÌïôÎÖÑ (${groupedSubjects[grade] ? groupedSubjects[grade].length : 0}Í∞ú Í≥ºÎ™©)`;
                gradeColumn.appendChild(gradeTitle);

                const subjectContainer = document.createElement('div');

                if (groupedSubjects[grade] && groupedSubjects[grade].length > 0) {
                    groupedSubjects[grade].forEach(({key, data}) => {
                        // Í≥ºÎ™©ÌÇ§ÏóêÏÑú ÍµêÏÇ¨Ïù¥Î¶ÑÍ≥º Î∞ò Ï†ïÎ≥¥ Ï∂îÏ∂ú
                        const keyParts = key.split('-');
                        const subjectName = data.name;

                        // Í≥ºÎ™©ÌÇ§ ÌòïÌÉú: "ÌïôÎÖÑ-Í≥ºÎ™©Î™Ö-ÍµêÏÇ¨Î™Ö-Î∞òÎ™©Î°ù" ÎòêÎäî "ÌïôÎÖÑ-Í≥ºÎ™©Î™Ö-Î∞òÎ™©Î°ù"
                        let displayName = subjectName;
                        let teacherName = '';
                        let classInfo = '';

                        if (keyParts.length >= 4) {
                            // ÍµêÏÇ¨Î™ÖÏù¥ ÏûàÎäî Í≤ΩÏö∞: "3-Í≥ºÌïô-ÌôçÍ∏∏Îèô-1,2"
                            teacherName = keyParts[2];
                            classInfo = keyParts[3];
                            displayName = `${subjectName}(${teacherName})`;
                        } else if (keyParts.length === 3) {
                            // ÍµêÏÇ¨Î™ÖÏù¥ ÏóÜÎäî Í≤ΩÏö∞: "3-ÏÇ¨Ìöå-1,2,3"
                            classInfo = keyParts[2];
                        }

                        const subjectItem = document.createElement('div');
                        subjectItem.className = 'subject-item';
                        subjectItem.setAttribute('data-subject-key', key);
                        subjectItem.innerHTML = `
                            <span onclick="selectSubjectForArea('${key}')" style="flex: 1;">${displayName} (${data.areas.length}Í∞ú ÏòÅÏó≠)</span>
                            <span class="delete-btn" onclick="event.stopPropagation(); removeSubject('${key}')" title="Í≥ºÎ™© ÏÇ≠Ï†ú">√ó</span>
                        `;
                        subjectItem.style.display = 'flex';
                        subjectItem.style.alignItems = 'center';
                        subjectItem.style.justifyContent = 'space-between';
                        subjectContainer.appendChild(subjectItem);
                    });
                } else {
                    const emptyMsg = document.createElement('p');
                    emptyMsg.style.color = '#999';
                    emptyMsg.style.fontSize = '12px';
                    emptyMsg.style.textAlign = 'center';
                    emptyMsg.style.margin = '10px 0';
                    emptyMsg.textContent = 'Îì±Î°ùÎêú Í≥ºÎ™© ÏóÜÏùå';
                    subjectContainer.appendChild(emptyMsg);
                }

                gradeColumn.appendChild(subjectContainer);
                gradeRow.appendChild(gradeColumn);
            });

            container.appendChild(gradeRow);
        }

        // Í≥ºÎ™© ÏÇ≠Ï†ú
        function removeSubject(subjectKey) {
            const subject = subjects[subjectKey];

            // Í≥ºÎ™©ÌÇ§ÏóêÏÑú ÍµêÏÇ¨Ïù¥Î¶Ñ Ï∂îÏ∂úÌï¥ÏÑú ÌëúÏãúÎ™Ö ÏÉùÏÑ±
            const keyParts = subjectKey.split('-');
            let displayName = `${subject.grade}ÌïôÎÖÑ ${subject.name}`;

            if (keyParts.length >= 4) {
                // ÍµêÏÇ¨Î™ÖÏù¥ ÏûàÎäî Í≤ΩÏö∞
                const teacherName = keyParts[2];
                displayName = `${subject.grade}ÌïôÎÖÑ ${subject.name}(${teacherName})`;
            }

            if (!confirm(`${displayName} Í≥ºÎ™©ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? (Í¥ÄÎ†® Ï†êÏàòÎèÑ Î™®Îëê ÏÇ≠Ï†úÎê©ÎãàÎã§)`)) return;

            delete subjects[subjectKey];
            delete scores[subjectKey];

            updateSubjectList();
            updateSubjectSelectors();
            saveSubjects();
            saveScores();

            // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Í≥ºÎ™©Ïù¥ ÏÇ≠Ï†úÎêú Í≤ΩÏö∞ Ï¥àÍ∏∞Ìôî
            if (currentSubject === subjectKey) {
                resetAreaManagement();
            }
        }

        // Í≥ºÎ™© ÏÑ†ÌÉùÏûê ÏóÖÎç∞Ïù¥Ìä∏ (Ï†êÏàòÍ¥ÄÎ¶¨Ïö© Í≥ºÎ™© Î™©Î°ù ÌëúÏãú)
        function updateSubjectSelectors() {
            updateScoreSubjectList();
            updateTemplateButton();
        }

        // Ï†êÏàòÍ¥ÄÎ¶¨Ïö© Í≥ºÎ™© Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏ (ÌïôÎÖÑÎ≥ÑÎ°ú Í∞ÄÎ°ú 3Îì±Î∂ÑÌïòÏó¨ ÌëúÏãú)
        function updateScoreSubjectList() {
            const container = document.getElementById('scoreSubjectList');
            container.innerHTML = '';

            // ÌïôÎÖÑÎ≥ÑÎ°ú Í∑∏Î£πÌïëÌï¥ÏÑú Ï†ïÎ†¨
            const groupedSubjects = {};
            Object.keys(subjects).forEach(subjectKey => {
                const subject = subjects[subjectKey];
                if (!groupedSubjects[subject.grade]) {
                    groupedSubjects[subject.grade] = [];
                }
                groupedSubjects[subject.grade].push({key: subjectKey, data: subject});
            });

            // Í∞ÄÎ°ú 3Îì±Î∂Ñ Î†àÏù¥ÏïÑÏõÉÏúºÎ°ú ÌïôÎÖÑÎ≥Ñ ÌëúÏãú
            const gradeRow = document.createElement('div');
            gradeRow.className = 'grade-row';

            [3, 2, 1].forEach(grade => {
                const gradeColumn = document.createElement('div');
                gradeColumn.className = `grade-column grade-${grade}`;

                const gradeTitle = document.createElement('h5');
                gradeTitle.innerHTML = `${grade}ÌïôÎÖÑ (${groupedSubjects[grade] ? groupedSubjects[grade].length : 0}Í∞ú Í≥ºÎ™©)`;
                gradeColumn.appendChild(gradeTitle);

                const subjectContainer = document.createElement('div');

                if (groupedSubjects[grade] && groupedSubjects[grade].length > 0) {
                    groupedSubjects[grade].forEach(({key, data}) => {
                        // Í≥ºÎ™©ÌÇ§ÏóêÏÑú ÍµêÏÇ¨Ïù¥Î¶Ñ Ï∂îÏ∂ú
                        const keyParts = key.split('-');
                        const subjectName = data.name;

                        // Í≥ºÎ™©ÌÇ§ ÌòïÌÉú: "ÌïôÎÖÑ-Í≥ºÎ™©Î™Ö-ÍµêÏÇ¨Î™Ö-Î∞òÎ™©Î°ù" ÎòêÎäî "ÌïôÎÖÑ-Í≥ºÎ™©Î™Ö-Î∞òÎ™©Î°ù"
                        let displayName = subjectName;

                        if (keyParts.length >= 4) {
                            // ÍµêÏÇ¨Î™ÖÏù¥ ÏûàÎäî Í≤ΩÏö∞: "3-Í≥ºÌïô-ÌôçÍ∏∏Îèô-1,2"
                            const teacherName = keyParts[2];
                            displayName = `${subjectName}(${teacherName})`;
                        }

                        const subjectItem = document.createElement('div');
                        subjectItem.className = 'score-subject-item';
                        subjectItem.setAttribute('data-subject-key', key);
                        subjectItem.innerHTML = `${displayName} (${data.areas.length}Í∞ú ÏòÅÏó≠)`;
                        subjectItem.onclick = () => selectSubjectForScore(key);
                        subjectContainer.appendChild(subjectItem);
                    });
                } else {
                    const emptyMsg = document.createElement('p');
                    emptyMsg.style.color = '#999';
                    emptyMsg.style.fontSize = '12px';
                    emptyMsg.style.textAlign = 'center';
                    emptyMsg.style.margin = '10px 0';
                    emptyMsg.textContent = 'Îì±Î°ùÎêú Í≥ºÎ™© ÏóÜÏùå';
                    subjectContainer.appendChild(emptyMsg);
                }

                gradeColumn.appendChild(subjectContainer);
                gradeRow.appendChild(gradeColumn);
            });

            container.appendChild(gradeRow);
        }

        // Ï†êÏàòÍ¥ÄÎ¶¨Ïö© Í≥ºÎ™©ÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ Ï†êÏàò Í¥ÄÎ¶¨ Ïù∏ÌÑ∞ÌéòÏù¥Ïä§Î°ú Ïù¥Îèô
        function selectSubjectForScore(subjectKey) {
            // Î™®Îì† Ï†êÏàòÍ¥ÄÎ¶¨Ïö© Í≥ºÎ™© ÏïÑÏù¥ÌÖúÏóêÏÑú selected ÌÅ¥ÎûòÏä§ Ï†úÍ±∞
            document.querySelectorAll('.score-subject-item').forEach(item => {
                item.classList.remove('selected');
            });

            // ÌÅ¥Î¶≠Îêú Í≥ºÎ™©Ïóê selected ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
            const clickedItem = document.querySelector(`#scoreSubjectList [data-subject-key="${subjectKey}"]`);
            if (clickedItem) {
                clickedItem.classList.add('selected');
            }

            // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Ï†êÏàòÍ¥ÄÎ¶¨ Í≥ºÎ™© ÏÑ§Ï†ï
            currentScoreSubject = subjectKey;

            // Ï†êÏàò Í¥ÄÎ¶¨ Ïù∏ÌÑ∞ÌéòÏù¥Ïä§ ÏóÖÎç∞Ïù¥Ìä∏
            updateScoreInterface();

            // Ï†êÏàò ÏóÖÎ°úÎìú ÏÑπÏÖòÏúºÎ°ú Ïä§ÌÅ¨Î°§
            document.getElementById('scoreUploadSection').scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }

        // Í≥ºÎ™©ÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÏàòÌñâÏòÅÏó≠ ÏÑ§Ï†ïÏúºÎ°ú Î∞îÎ°ú Ïù¥Îèô
        function selectSubjectForArea(subjectKey) {
            // Î™®Îì† Í≥ºÎ™© ÏïÑÏù¥ÌÖúÏóêÏÑú selected ÌÅ¥ÎûòÏä§ Ï†úÍ±∞
            document.querySelectorAll('.subject-item').forEach(item => {
                item.classList.remove('selected');
            });

            // ÌÅ¥Î¶≠Îêú Í≥ºÎ™©Ïóê selected ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
            const clickedItem = document.querySelector(`[data-subject-key="${subjectKey}"]`);
            if (clickedItem) {
                clickedItem.classList.add('selected');
            }

            // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Í≥ºÎ™© ÏÑ§Ï†ï
            currentSubject = subjectKey;

            // ÏàòÌñâÏòÅÏó≠ ÏÑ§Ï†ï ÏòÅÏó≠ ÌôúÏÑ±Ìôî
            document.getElementById('areaManagement').style.display = 'block';

            // Ìï¥Îãπ Í≥ºÎ™©Ïùò ÏòÅÏó≠ Î°úÎìú
            updateCurrentSubjectAreas();

            // ÏàòÌñâÏòÅÏó≠ ÏÑ§Ï†ï Î∂ÄÎ∂ÑÏúºÎ°ú Ïä§ÌÅ¨Î°§
            document.getElementById('areaManagement').scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }

        // Í≥ºÎ™© ÏÇ≠Ï†ú Ïãú ÏàòÌñâÏòÅÏó≠ ÏÑ§Ï†ï Ï¥àÍ∏∞Ìôî
        function resetAreaManagement() {
            document.getElementById('areaManagement').style.display = 'none';
            currentSubject = '';

            // Î™®Îì† Í≥ºÎ™© ÏïÑÏù¥ÌÖúÏóêÏÑú selected ÌÅ¥ÎûòÏä§ Ï†úÍ±∞
            document.querySelectorAll('.subject-item').forEach(item => {
                item.classList.remove('selected');
            });
        }

        // ÌòÑÏû¨ Í≥ºÎ™©Ïùò ÏòÅÏó≠ ÏóÖÎç∞Ïù¥Ìä∏
        function updateCurrentSubjectAreas() {
            const container = document.getElementById('currentSubjectAreas');

            if (!currentSubject || !subjects[currentSubject]) {
                container.innerHTML = '';
                return;
            }

            const subject = subjects[currentSubject];
            const areas = subject.areas;

            if (areas.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center;">Îì±Î°ùÎêú ÏàòÌñâÏòÅÏó≠Ïù¥ ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }

            const displayName = `${subject.grade}ÌïôÎÖÑ-${subject.name}`;
            let html = `<h5>${displayName} ÏàòÌñâÏòÅÏó≠ Î™©Î°ù</h5><div class="list-container">`;

            areas.forEach((area, index) => {
                html += `
                    <div class="area-tag tag">
                        <span>${area.name} (${area.maxScore}Ï†ê)</span>
                        <button class="remove-btn" onclick="removeArea(${index})">√ó</button>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;

            updateTemplateButton();
        }

        // ÏàòÌñâÏòÅÏó≠ Ï∂îÍ∞Ä
        function addArea() {
            if (!currentSubject) {
                alert('Î®ºÏ†Ä Í≥ºÎ™©ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            const nameInput = document.getElementById('areaName');
            const scoreInput = document.getElementById('areaMaxScore');

            const name = nameInput.value.trim();
            const maxScore = parseInt(scoreInput.value);

            if (!name) {
                alert('ÏòÅÏó≠Î™ÖÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            if (!maxScore || maxScore <= 0) {
                alert('Ïò¨Î∞îÎ•∏ ÎßåÏ†êÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            // Í∞ôÏùÄ Í≥ºÎ™© ÎÇ¥ÏóêÏÑú Ï§ëÎ≥µ ÏòÅÏó≠Î™Ö Ï≤¥ÌÅ¨
            if (subjects[currentSubject].areas.some(area => area.name === name)) {
                alert('Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî ÏòÅÏó≠Î™ÖÏûÖÎãàÎã§.');
                return;
            }

            subjects[currentSubject].areas.push({ name, maxScore });
            nameInput.value = '';
            scoreInput.value = '';

            updateCurrentSubjectAreas();
            saveSubjects();
        }

        // ÏòÅÏó≠ ÏÇ≠Ï†ú
        function removeArea(index) {
            if (!currentSubject) return;

            const area = subjects[currentSubject].areas[index];
            if (!confirm(`${area.name} ÏòÅÏó≠ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return;

            subjects[currentSubject].areas.splice(index, 1);

            // Ìï¥Îãπ ÏòÅÏó≠Ïùò Î™®Îì† Ï†êÏàò ÏÇ≠Ï†ú
            Object.keys(scores[currentSubject] || {}).forEach(studentNum => {
                delete scores[currentSubject][studentNum][area.name];
            });

            updateCurrentSubjectAreas();
            saveSubjects();
            saveScores();
        }


        // ===== Ï†êÏàò Í¥ÄÎ¶¨ =====

        // Ï†êÏàò Í¥ÄÎ¶¨ Ïù∏ÌÑ∞ÌéòÏù¥Ïä§ ÏóÖÎç∞Ïù¥Ìä∏
        function updateScoreInterface() {
            const uploadSection = document.getElementById('scoreUploadSection');

            if (!currentScoreSubject) {
                uploadSection.style.display = 'none';
                return;
            }
            uploadSection.style.display = 'block';

            // ÌòÑÏû¨ Í≥ºÎ™©Ïùò Îì±Î°ù ÏÉÅÌÉú ÌëúÏãú
            updatePublishStatus();
            generateScoreTable();
        }

        // Îì±Î°ù ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        function updatePublishStatus() {
            // Ï†êÏàòÌëúÍ∞Ä ÏÉùÏÑ±Îê† Îïå Ï≤¥ÌÅ¨Î∞ïÏä§ ÏÉÅÌÉúÍ∞Ä ÏûêÎèôÏúºÎ°ú ÏÑ§Ï†ïÎê®
            // Îçî Ïù¥ÏÉÅ Î≥ÑÎèÑ UI ÏóÖÎç∞Ïù¥Ìä∏ Î∂àÌïÑÏöî
        }

        // Îì±Î°ù ÏÉÅÌÉú ÌÜ†Í∏Ä
        function togglePublishStatus() {
            if (!currentScoreSubject) return;

            const checkbox = document.getElementById('publishCheckbox');
            publishedSubjects[currentScoreSubject] = checkbox.checked;

            updatePublishStatus();
            savePublishedSubjects();

            const subject = subjects[currentScoreSubject];
            const displayName = `${subject.grade}ÌïôÎÖÑ-${subject.name}`;

            if (checkbox.checked) {
                alert(`‚úÖ ${displayName}\nÌïôÏÉùÎì§Ïù¥ Ïù¥ Í≥ºÎ™©Ïùò Ï†êÏàòÎ•º Ï°∞ÌöåÌï† Ïàò ÏûàÏäµÎãàÎã§.`);
            } else {
                alert(`‚õî ${displayName}\nÌïôÏÉùÎì§Ïù¥ Ïù¥ Í≥ºÎ™©Ïùò Ï†êÏàòÎ•º Ï°∞ÌöåÌï† Ïàò ÏóÜÏäµÎãàÎã§.`);
            }
        }

        // ÌÖúÌîåÎ¶ø ÏÉùÏÑ±
        function generateTemplate() {
            const selectedSubjectKey = currentSubject;

            if (!selectedSubjectKey) {
                alert('Î®ºÏ†Ä Í≥ºÎ™©ÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            if (!subjects[selectedSubjectKey] || subjects[selectedSubjectKey].areas.length === 0) {
                alert('Î®ºÏ†Ä ÏàòÌñâÏòÅÏó≠ÏùÑ Îì±Î°ùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            if (Object.keys(students).length === 0) {
                alert('Î®ºÏ†Ä ÌïôÏÉùÏùÑ Îì±Î°ùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            const wb = XLSX.utils.book_new();
            const subject = subjects[selectedSubjectKey];
            const areas = subject.areas;

            // Ìó§Îçî ÏÉùÏÑ±
            const headers = ['ÌïôÎ≤à', 'Ïù¥Î¶Ñ'];
            areas.forEach(area => {
                headers.push(`${area.name}(${area.maxScore})`);
            });

            // Îç∞Ïù¥ÌÑ∞ Î∞∞Ïó¥ ÏÉùÏÑ±
            const data = [headers];

            // Ìï¥Îãπ Í≥ºÎ™©Ïùò Îã¥Îãπ Î∞ò ÌïôÏÉùÎì§Îßå ÌïÑÌÑ∞ÎßÅ
            // Í≥ºÎ™©ÌÇ§ÏóêÏÑú Îã¥Îãπ Î∞ò Ï†ïÎ≥¥ Ï∂îÏ∂ú: "ÌïôÎÖÑ-Í≥ºÎ™©Î™Ö-ÍµêÏÇ¨Î™Ö-Î∞òÎ™©Î°ù"
            const keyParts = selectedSubjectKey.split('-');
            const subjectGrade = parseInt(keyParts[0]);
            const classesStr = keyParts[keyParts.length - 1]; // ÎßàÏßÄÎßâ Î∂ÄÎ∂ÑÏù¥ Î∞ò Î™©Î°ù
            const assignedClasses = classesStr.split(',').map(c => parseInt(c));

            // Ìï¥Îãπ ÌïôÎÖÑÏùò Îã¥Îãπ Î∞ò ÌïôÏÉùÎì§Îßå ÌïÑÌÑ∞ÎßÅ
            const filteredStudents = Object.entries(students).filter(([num, student]) => {
                return student.grade === subjectGrade && assignedClasses.includes(student.class);
            });

            // ÌïôÎ≤à ÏàúÏúºÎ°ú Ï†ïÎ†¨ÌïòÏó¨ ÌïôÏÉù Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
            const sortedNumbers = filteredStudents.map(([num]) => num).sort();
            sortedNumbers.forEach(num => {
                const row = [num, students[num].name];
                areas.forEach(() => row.push('')); // Îπà Ï†êÏàò Ïπ∏
                data.push(row);
            });

            const ws = XLSX.utils.aoa_to_sheet(data);

            // Ïó¥ ÎÑàÎπÑ ÏÑ§Ï†ï
            const colWidths = [
                { wch: 8 },  // ÌïôÎ≤à
                { wch: 12 }, // Ïù¥Î¶Ñ
                ...areas.map(() => ({ wch: 15 }))
            ];
            ws['!cols'] = colWidths;

            const sheetName = `${subject.grade}ÌïôÎÖÑ_${subject.name}`;
            XLSX.utils.book_append_sheet(wb, ws, sheetName);

            const today = new Date().toISOString().split('T')[0];
            const fileName = `${subject.grade}ÌïôÎÖÑ_${subject.name}_ÏàòÌñâÌèâÍ∞Ä_${today}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        // ÌÖúÌîåÎ¶ø Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        function updateTemplateButton() {
            const templateBtn = document.getElementById('templateBtn');
            const hasSubjectsWithAreas = Object.values(subjects).some(subject => subject.areas.length > 0);
            const hasStudents = Object.keys(students).length > 0;

            templateBtn.disabled = !hasSubjectsWithAreas || !hasStudents;
        }

        // Ï†êÏàòÌëú ÏÉùÏÑ±
        function generateScoreTable() {
            const container = document.getElementById('scoreTableContainer');

            if (!currentScoreSubject || !subjects[currentScoreSubject] || subjects[currentScoreSubject].areas.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">ÏàòÌñâÏòÅÏó≠ÏùÑ Î®ºÏ†Ä ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.</p>';
                return;
            }

            if (Object.keys(students).length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">ÌïôÏÉùÏùÑ Î®ºÏ†Ä Îì±Î°ùÌï¥Ï£ºÏÑ∏Ïöî.</p>';
                return;
            }

            const subject = subjects[currentScoreSubject];
            const areas = subject.areas;
            const subjectScores = scores[currentScoreSubject] || {};

            // Í≥ºÎ™©ÌÇ§ÏóêÏÑú ÍµêÏÇ¨Ïù¥Î¶ÑÍ≥º Îã¥Îãπ Î∞ò Ï†ïÎ≥¥ Ï∂îÏ∂ú
            const keyParts = currentScoreSubject.split('-');
            let displayName = `${subject.grade}ÌïôÎÖÑ ${subject.name}`;

            if (keyParts.length >= 4) {
                // ÍµêÏÇ¨Î™ÖÏù¥ ÏûàÎäî Í≤ΩÏö∞
                const teacherName = keyParts[2];
                displayName = `${subject.grade}ÌïôÎÖÑ ${subject.name}(${teacherName})`;
            }

            // Î™ÖÏãúÏ†ÅÏúºÎ°ú trueÏù∏ Í≤ΩÏö∞Îßå ÌóàÏö©, Í∏∞Î≥∏Í∞íÏùÄ ÎπÑÌóàÏö©
            const isPublished = publishedSubjects[currentScoreSubject] === true;

            let tableHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="margin: 0;">üìä ${displayName} Ï†êÏàòÌëú</h4>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px;">
                            <input type="checkbox" id="publishCheckbox" onchange="togglePublishStatus()"
                                   ${isPublished ? 'checked' : ''}
                                   title="ÌïôÏÉù Ï°∞Ìöå ÌóàÏö© Ïó¨Î∂ÄÎ•º ÏÑ§Ï†ïÌï©ÎãàÎã§"
                                   aria-label="ÌïôÏÉù Ï†êÏàò Ï°∞Ìöå ÌóàÏö© ÏÑ§Ï†ï">
                            <span style="color: ${isPublished ? '#28a745' : '#6c757d'};">
                                ${displayName} - ÌïôÏÉù Ï°∞Ìöå ${isPublished ? 'ÌóàÏö© ‚úì' : 'ÌóàÏö©'}
                            </span>
                        </label>
                        <button class="btn danger" onclick="clearScores()" style="padding: 5px 10px; font-size: 12px;">üóëÔ∏è Ï†êÏàò Ï¥àÍ∏∞Ìôî</button>
                    </div>
                </div>
                <table class="score-table">
                    <thead>
                        <tr>
                            <th>ÌïôÎ≤à</th>
                            <th>Ïù¥Î¶Ñ</th>
                            ${areas.map(area => `<th>${area.name}<br>(${area.maxScore}Ï†ê)</th>`).join('')}
                            <th>Ï¥ùÏ†ê</th>
                            <th>ÌôïÏù∏Ïó¨Î∂Ä</th>
                            <th>Î¨∏ÏùòÏó¨Î∂Ä</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Ìï¥Îãπ Í≥ºÎ™©Ïùò Îã¥Îãπ Î∞ò ÌïôÏÉùÎì§Îßå ÌïÑÌÑ∞ÎßÅ (ÏúÑÏóêÏÑú ÏÑ†Ïñ∏Ìïú keyParts Ïû¨ÏÇ¨Ïö©)
            const subjectGrade = parseInt(keyParts[0]);
            const classesStr = keyParts[keyParts.length - 1]; // ÎßàÏßÄÎßâ Î∂ÄÎ∂ÑÏù¥ Î∞ò Î™©Î°ù
            const assignedClasses = classesStr.split(',').map(c => parseInt(c));

            // Ìï¥Îãπ ÌïôÎÖÑÏùò Îã¥Îãπ Î∞ò ÌïôÏÉùÎì§Îßå ÌïÑÌÑ∞ÎßÅ
            const filteredStudents = Object.entries(students).filter(([num, student]) => {
                return student.grade === subjectGrade && assignedClasses.includes(student.class);
            });

            const sortedNumbers = filteredStudents.map(([num]) => num).sort();
            sortedNumbers.forEach(num => {
                const student = students[num];
                const studentScores = subjectScores[num] || {};
                let total = 0;

                // ÌïôÏÉùÏùò ÌôïÏù∏ Ïó¨Î∂Ä Ï≤¥ÌÅ¨ (ÏòÅÏó≠Î≥Ñ)
                const subject = subjects[currentScoreSubject];
                let checkedAreas = 0;
                let totalAreas = subject.areas.length;

                if (studentChecked[currentScoreSubject] &&
                    studentChecked[currentScoreSubject][num] &&
                    typeof studentChecked[currentScoreSubject][num] === 'object') {
                    subject.areas.forEach(area => {
                        const areaStatus = studentChecked[currentScoreSubject][num][area.name];
                        if (areaStatus === true) {
                            checkedAreas++;
                        }
                    });
                }

                // ÎîîÎ≤ÑÍπÖÏö© Î°úÍ∑∏ (ÏûÑÏãú)
                console.log(`ÌïôÏÉù ${num}: ÌôïÏù∏ Îç∞Ïù¥ÌÑ∞`, studentChecked[currentScoreSubject]?.[num], `=> ${checkedAreas}/${totalAreas}`);


                let checkStatus = '';
                let checkColor = '';

                if (checkedAreas === 0) {
                    checkStatus = `‚≠ï ÎØ∏ÌôïÏù∏(${checkedAreas}/${totalAreas})`;
                    checkColor = '#6c757d';
                } else if (checkedAreas === totalAreas) {
                    checkStatus = `‚úÖ ÏôÑÎ£å(${checkedAreas}/${totalAreas})`;
                    checkColor = '#28a745';
                } else {
                    checkStatus = `‚è≥ ÏßÑÌñâÏ§ë(${checkedAreas}/${totalAreas})`;
                    checkColor = '#ffc107';
                }

                // ÌïôÏÉùÏùò Î¨∏Ïùò Ïó¨Î∂Ä Ï≤¥ÌÅ¨ (ÏòÅÏó≠Î≥Ñ)
                let questionAreas = 0;
                if (studentQuestions[currentScoreSubject] && studentQuestions[currentScoreSubject][num]) {
                    subject.areas.forEach(area => {
                        if (studentQuestions[currentScoreSubject][num][area.name] === true) {
                            questionAreas++;
                        }
                    });
                }

                let questionStatus = '';
                let questionColor = '';
                if (questionAreas > 0) {
                    questionStatus = `‚ùì Î¨∏Ïùò(${questionAreas}Í∞ú)`;
                    questionColor = '#dc3545';
                } else {
                    questionStatus = `-`;
                    questionColor = '#6c757d';
                }

                tableHTML += `<tr><td>${num}</td><td>${student.name}</td>`;

                areas.forEach(area => {
                    const score = studentScores[area.name] || 0;
                    total += score;
                    tableHTML += `<td>${score}</td>`;
                });

                tableHTML += `<td><strong>${total}</strong></td><td style="color: ${checkColor}; font-weight: bold;">${checkStatus}</td><td style="color: ${questionColor}; font-weight: bold;">${questionStatus}</td></tr>`;
            });

            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }


        // ===== ÌååÏùº Ï≤òÎ¶¨ =====

        // ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠ ÏÑ§Ï†ï
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            });
        }

        // ÌïôÏÉù Î™ÖÎã® ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠ ÏÑ§Ï†ï
        function setupStudentUploadDragAndDrop() {
            const studentUploadArea = document.getElementById('studentUploadArea');

            studentUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                studentUploadArea.classList.add('dragover');
                studentUploadArea.style.backgroundColor = '#e3f2fd';
                studentUploadArea.style.borderColor = '#2196f3';
            });

            studentUploadArea.addEventListener('dragleave', (e) => {
                // ÏûêÏãù ÏöîÏÜåÎ°ú Ïù∏Ìïú ÏûòÎ™ªÎêú dragleave Î∞©ÏßÄ
                if (!studentUploadArea.contains(e.relatedTarget)) {
                    studentUploadArea.classList.remove('dragover');
                    studentUploadArea.style.backgroundColor = '';
                    studentUploadArea.style.borderColor = '';
                }
            });

            studentUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                studentUploadArea.classList.remove('dragover');
                studentUploadArea.style.backgroundColor = '';
                studentUploadArea.style.borderColor = '';

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    // ÌååÏùº ÌòïÏãù Í≤ÄÏÇ¨
                    if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                        uploadStudentFile({ target: { files: [file] } });
                    } else {
                        alert('ÏóëÏÖÄ ÌååÏùº(.xlsx, .xls)Îßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.');
                    }
                }
            });
        }

        // ÌïôÏÉù Î™ÖÎã® ÏóÖÎ°úÎìú Ï≤òÎ¶¨
        function uploadStudentFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});

                    parseStudentData(jsonData);
                } catch (error) {
                    alert('ÌååÏùºÏùÑ ÏùΩÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Ï†êÏàò ÌååÏùº ÏóÖÎ°úÎìú Ï≤òÎ¶¨
        function uploadFile(event) {
            const file = event.target.files[0];
            if (file) {
                handleFileUpload(file);
            }
        }

        function handleFileUpload(file) {
            if (!currentScoreSubject) {
                alert('Î®ºÏ†Ä Í≥ºÎ™©ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            if (!subjects[currentScoreSubject] || subjects[currentScoreSubject].areas.length === 0) {
                alert('Î®ºÏ†Ä ÏàòÌñâÏòÅÏó≠ÏùÑ ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            if (Object.keys(students).length === 0) {
                alert('Î®ºÏ†Ä ÌïôÏÉùÏùÑ Îì±Î°ùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});

                    parseUploadedScoreData(jsonData);
                } catch (error) {
                    alert('ÌååÏùºÏùÑ ÏùΩÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // ÌïôÏÉù Îç∞Ïù¥ÌÑ∞ ÌååÏã±
        function parseStudentData(data) {
            let addedCount = 0;
            let skippedCount = 0;
            let errorCount = 0;

            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                if (row.length >= 2) {
                    const studentNumber = String(row[0]).trim();
                    const name = String(row[1]).trim();

                    if (studentNumber && name) {
                        const parsed = parseStudentNumber(studentNumber);
                        if (parsed) {
                            if (!students[studentNumber]) {
                                students[studentNumber] = {
                                    name: name,
                                    grade: parsed.grade,
                                    class: parsed.class,
                                    number: parsed.number,
                                    password: generateDefaultPassword(studentNumber) // Í∏∞Î≥∏ ÎπÑÎ∞ÄÎ≤àÌò∏ ÏÉùÏÑ±
                                };
                                addedCount++;
                            } else {
                                skippedCount++;
                            }
                        } else {
                            errorCount++;
                        }
                    }
                }
            }

            updateStats();
            updateMatrix();
            updateTemplateButton();
            saveStudents();

            let message = `ÌïôÏÉù ${addedCount}Î™ÖÏù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.`;
            if (skippedCount > 0) message += `\nÏ§ëÎ≥µÎêú ÌïôÎ≤à ${skippedCount}Î™ÖÏùÄ Í±¥ÎÑàÎõ∞ÏóàÏäµÎãàÎã§.`;
            if (errorCount > 0) message += `\nÏûòÎ™ªÎêú ÌïôÎ≤à ÌòïÏãù ${errorCount}Î™ÖÏùÄ Ï†úÏô∏ÎêòÏóàÏäµÎãàÎã§.`;

            alert(message);
        }

        // Ï†êÏàò Îç∞Ïù¥ÌÑ∞ ÌååÏã±
        function parseUploadedScoreData(data) {
            if (data.length < 2) {
                alert('Ïò¨Î∞îÎ•∏ ÌòïÏãùÏùò ÌååÏùºÏù¥ ÏïÑÎãôÎãàÎã§.');
                return;
            }

            const headers = data[0];
            const areas = subjects[currentScoreSubject].areas;

            if (!scores[currentScoreSubject]) {
                scores[currentScoreSubject] = {};
            }

            let errorMessages = [];

            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                const studentNum = String(row[0]).trim();
                const studentName = String(row[1]).trim();

                if (studentNum && students[studentNum]) {
                    // Ïù¥Î¶Ñ Í≤ÄÏ¶ù
                    if (students[studentNum].name !== studentName) {
                        errorMessages.push(`${studentNum}Î≤à: Ïù¥Î¶Ñ Î∂àÏùºÏπò (Îì±Î°ù: ${students[studentNum].name}, ÌååÏùº: ${studentName})`);
                    }

                    scores[currentScoreSubject][studentNum] = {};

                    for (let j = 2; j < headers.length && j < row.length; j++) {
                        const areaIndex = j - 2;
                        if (areaIndex < areas.length) {
                            const score = row[j];
                            if (score !== undefined && score !== '') {
                                scores[currentScoreSubject][studentNum][areas[areaIndex].name] = parseInt(score) || 0;
                            }
                        }
                    }
                } else if (studentNum) {
                    errorMessages.push(`${studentNum}Î≤à: Îì±Î°ùÎêòÏßÄ ÏïäÏùÄ ÌïôÏÉù`);
                }
            }

            if (errorMessages.length > 0) {
                alert('Ïò§Î•ò Î∞úÍ≤¨:\n' + errorMessages.join('\n') + '\n\nÍ≥ÑÏÜç ÏßÑÌñâÌïòÏãúÍ≤†ÏäµÎãàÍπå?');
            }

            generateScoreTable();
            saveScores();
            alert(`${currentScoreSubject} Ï†êÏàò ÌååÏùºÏù¥ ÏóÖÎ°úÎìúÎêòÏóàÏäµÎãàÎã§.`);
        }




        // ===== Ïú†Ìã∏Î¶¨Ìã∞ Ìï®Ïàò =====

        // ÌïôÏÉù Î™ÖÎã® ÏñëÏãù Îã§Ïö¥Î°úÎìú
        function downloadStudentTemplate() {
            const wb = XLSX.utils.book_new();
            const data = [
                ['ÌïôÎ≤à', 'Ïù¥Î¶Ñ'],
                ['30101', 'ÍπÄÏ≤†Ïàò'],
                ['30102', 'Ïù¥ÏòÅÌù¨'],
                ['30201', 'Î∞ïÎØºÏàò'],
                ['30202', 'ÏµúÌïòÎÇò']
            ];

            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{ wch: 10 }, { wch: 15 }];

            XLSX.utils.book_append_sheet(wb, ws, 'ÌïôÏÉùÎ™ÖÎã®');
            const today = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `ÌïôÏÉùÎ™ÖÎã®_ÏñëÏãù_${today}.xlsx`);
        }

        // Î™®Îì† ÌïôÏÉù ÏÇ≠Ï†ú
        function clearAllStudents() {
            if (!confirm('Î™®Îì† ÌïôÏÉùÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? (Ï†êÏàò Îç∞Ïù¥ÌÑ∞ÎèÑ Ìï®Íªò ÏÇ≠Ï†úÎê©ÎãàÎã§)')) return;

            students = {};
            // Î™®Îì† Í≥ºÎ™©Ïùò Ï†êÏàò Ï¥àÍ∏∞Ìôî
            Object.keys(scores).forEach(subject => {
                scores[subject] = {};
            });

            updateStats();
            updateMatrix();
            updateTemplateButton();
            saveStudents();
            saveScores();
        }

        // Ï†êÏàò Ï¥àÍ∏∞Ìôî
        function clearScores() {
            if (!currentScoreSubject) return;
            if (!confirm(`${currentScoreSubject} Í≥ºÎ™©Ïùò Î™®Îì† Ï†êÏàòÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return;

            // Ï†êÏàò Ï¥àÍ∏∞Ìôî
            scores[currentScoreSubject] = {};

            // Ìï¥Îãπ Í≥ºÎ™©Ïùò ÌôïÏù∏ ÏÉÅÌÉúÎèÑ Ï¥àÍ∏∞Ìôî
            if (studentChecked[currentScoreSubject]) {
                studentChecked[currentScoreSubject] = {};
                saveStudentChecked();
            }



            generateScoreTable();
            saveScores();
        }

        // ===== Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•/Î°úÎìú =====

        function saveStudents() {
            localStorage.setItem('students', JSON.stringify(students));
            // FirebaseÏóêÎèÑ ÎèôÍ∏∞Ìôî (ÎπÑÎ∞ÄÎ≤àÌò∏ Ìè¨Ìï®)
            syncToFirebase('students', students);
        }

        async function loadStudents() {
            // Î®ºÏ†Ä localStorageÏóêÏÑú Î∂àÎü¨Ïò§Í∏∞
            const saved = localStorage.getItem('students');
            if (saved) {
                students = JSON.parse(saved);
                updateStats();
                updateMatrix();
            }

            // FirebaseÏóêÏÑúÎèÑ Î∂àÎü¨Ïò§Í∏∞ (ÏûàÏúºÎ©¥ ÎçÆÏñ¥Ïì∞Í∏∞)
            if (window.firebase && window.firebaseInitialized) {
                try {
                    const studentsRef = window.firebase.ref(window.firebase.database, 'students');
                    const snapshot = await new Promise((resolve, reject) => {
                        window.firebase.onValue(studentsRef, resolve, reject, { onlyOnce: true });
                    });

                    if (snapshot.exists()) {
                        const firebaseStudents = snapshot.val();
                        students = firebaseStudents;

                        // localStorageÏóêÎèÑ Î∞±ÏóÖ Ï†ÄÏû•
                        localStorage.setItem('students', JSON.stringify(students));

                        updateStats();
                        updateMatrix();
                        console.log('FirebaseÏóêÏÑú ÌïôÏÉù Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨ÏôîÏäµÎãàÎã§:', Object.keys(students).length + 'Î™Ö');
                    }
                } catch (error) {
                    console.error('FirebaseÏóêÏÑú ÌïôÏÉù Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®:', error);
                }
            }
        }

        function saveSubjects() {
            localStorage.setItem('subjects', JSON.stringify(subjects));
            // FirebaseÏóêÎèÑ ÎèôÍ∏∞Ìôî
            syncToFirebase('subjects', subjects);
        }

        async function loadSubjects() {
            // Î®ºÏ†Ä localStorageÏóêÏÑú Î∂àÎü¨Ïò§Í∏∞
            const saved = localStorage.getItem('subjects');
            if (saved) {
                subjects = JSON.parse(saved);
                updateSubjectList();
            }

            // FirebaseÏóêÏÑúÎèÑ Î∂àÎü¨Ïò§Í∏∞ (ÏûàÏúºÎ©¥ ÎçÆÏñ¥Ïì∞Í∏∞)
            if (window.firebase && window.firebaseInitialized) {
                try {
                    const subjectsRef = window.firebase.ref(window.firebase.database, 'subjects');
                    const snapshot = await new Promise((resolve, reject) => {
                        window.firebase.onValue(subjectsRef, resolve, reject, { onlyOnce: true });
                    });

                    if (snapshot.exists()) {
                        const firebaseSubjects = snapshot.val();
                        subjects = firebaseSubjects;

                        // localStorageÏóêÎèÑ Î∞±ÏóÖ Ï†ÄÏû•
                        localStorage.setItem('subjects', JSON.stringify(subjects));

                        updateSubjectList();
                        console.log('FirebaseÏóêÏÑú Í≥ºÎ™© Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨ÏôîÏäµÎãàÎã§:', Object.keys(subjects).length + 'Í∞ú Í≥ºÎ™©');
                    }
                } catch (error) {
                    console.error('FirebaseÏóêÏÑú Í≥ºÎ™© Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®:', error);
                }
            }
        }

        function saveScores() {
            localStorage.setItem('scores', JSON.stringify(scores));
            // FirebaseÏóêÎèÑ ÎèôÍ∏∞Ìôî
            syncToFirebase('scores', scores);
        }

        async function loadScores() {
            // Î®ºÏ†Ä localStorageÏóêÏÑú Î∂àÎü¨Ïò§Í∏∞
            const saved = localStorage.getItem('scores');
            if (saved) {
                scores = JSON.parse(saved);
            }

            // FirebaseÏóêÏÑúÎèÑ Î∂àÎü¨Ïò§Í∏∞ (ÏûàÏúºÎ©¥ ÎçÆÏñ¥Ïì∞Í∏∞)
            if (window.firebase && window.firebaseInitialized) {
                try {
                    const scoresRef = window.firebase.ref(window.firebase.database, 'scores');
                    const snapshot = await new Promise((resolve, reject) => {
                        window.firebase.onValue(scoresRef, resolve, reject, { onlyOnce: true });
                    });

                    if (snapshot.exists()) {
                        const firebaseScores = snapshot.val();
                        scores = firebaseScores;

                        // localStorageÏóêÎèÑ Î∞±ÏóÖ Ï†ÄÏû•
                        localStorage.setItem('scores', JSON.stringify(scores));

                        console.log('FirebaseÏóêÏÑú Ï†êÏàò Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨ÏôîÏäµÎãàÎã§:', Object.keys(scores).length + 'Í∞ú Í≥ºÎ™©');
                    }
                } catch (error) {
                    console.error('FirebaseÏóêÏÑú Ï†êÏàò Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®:', error);
                }
            }
        }

        function savePublishedSubjects() {
            localStorage.setItem('publishedSubjects', JSON.stringify(publishedSubjects));
            // FirebaseÏóêÎèÑ ÎèôÍ∏∞Ìôî
            syncToFirebase('publishedSubjects', publishedSubjects);
        }

        function loadPublishedSubjects() {
            const saved = localStorage.getItem('publishedSubjects');
            if (saved) {
                publishedSubjects = JSON.parse(saved);
            }
        }

        function saveStudentChecked() {
            localStorage.setItem('studentChecked', JSON.stringify(studentChecked));
            // FirebaseÏóêÎèÑ ÎèôÍ∏∞Ìôî
            syncToFirebase('studentChecked', studentChecked);
        }

        async function loadStudentChecked() {
            // Î®ºÏ†Ä localStorageÏóêÏÑú Î∂àÎü¨Ïò§Í∏∞
            const saved = localStorage.getItem('studentChecked');
            if (saved) {
                studentChecked = JSON.parse(saved);
            }

            // FirebaseÏóêÏÑúÎèÑ Î∂àÎü¨Ïò§Í∏∞ (ÏûàÏúºÎ©¥ ÎçÆÏñ¥Ïì∞Í∏∞)
            if (window.firebase && window.firebaseInitialized) {
                try {
                    const checkedRef = window.firebase.ref(window.firebase.database, 'studentChecked');
                    const snapshot = await new Promise((resolve, reject) => {
                        window.firebase.onValue(checkedRef, resolve, reject, { onlyOnce: true });
                    });

                    if (snapshot.exists()) {
                        const firebaseChecked = snapshot.val();
                        studentChecked = firebaseChecked;

                        // localStorageÏóêÎèÑ Î∞±ÏóÖ Ï†ÄÏû•
                        localStorage.setItem('studentChecked', JSON.stringify(studentChecked));

                        console.log('FirebaseÏóêÏÑú ÌôïÏù∏ ÏÉÅÌÉú Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨ÏôîÏäµÎãàÎã§.');
                    }
                } catch (error) {
                    console.error('FirebaseÏóêÏÑú ÌôïÏù∏ ÏÉÅÌÉú Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®:', error);
                }
            }
        }

        async function loadStudentQuestions() {
            // Î®ºÏ†Ä localStorageÏóêÏÑú Î∂àÎü¨Ïò§Í∏∞
            const saved = localStorage.getItem('studentQuestions');
            if (saved) {
                studentQuestions = JSON.parse(saved);
            }

            // FirebaseÏóêÏÑúÎèÑ Î∂àÎü¨Ïò§Í∏∞ (ÏûàÏúºÎ©¥ ÎçÆÏñ¥Ïì∞Í∏∞)
            if (window.firebase && window.firebaseInitialized) {
                try {
                    const questionsRef = window.firebase.ref(window.firebase.database, 'studentQuestions');
                    const snapshot = await new Promise((resolve, reject) => {
                        window.firebase.onValue(questionsRef, resolve, reject, { onlyOnce: true });
                    });

                    if (snapshot.exists()) {
                        const firebaseQuestions = snapshot.val();
                        studentQuestions = firebaseQuestions;

                        // localStorageÏóêÎèÑ Î∞±ÏóÖ Ï†ÄÏû•
                        localStorage.setItem('studentQuestions', JSON.stringify(studentQuestions));

                        console.log('FirebaseÏóêÏÑú Î¨∏Ïùò ÏÉÅÌÉú Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨ÏôîÏäµÎãàÎã§.');
                    }
                } catch (error) {
                    console.error('FirebaseÏóêÏÑú Î¨∏Ïùò ÏÉÅÌÉú Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®:', error);
                }
            }
        }





        // ===== Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà =====

        // Enter ÌÇ§ Ïù¥Î≤§Ìä∏
        document.addEventListener('DOMContentLoaded', function() {
            // ÌïôÏÉù Ï∂îÍ∞Ä
            document.getElementById('studentNumber').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') document.getElementById('studentName').focus();
            });

            document.getElementById('studentName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addStudent();
            });

            // Í≥ºÎ™© Ï∂îÍ∞Ä
            document.getElementById('subjectName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addSubject();
            });

            // ÏòÅÏó≠ Ï∂îÍ∞Ä
            document.getElementById('areaName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') document.getElementById('areaMaxScore').focus();
            });

            document.getElementById('areaMaxScore').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addArea();
            });


            // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠Ïãú Îã´Í∏∞
            document.getElementById('studentModal').addEventListener('click', function(e) {
                if (e.target === this) closeModal();
            });

            document.getElementById('subjectAddModal').addEventListener('click', function(e) {
                if (e.target === this) closeSubjectAddModal();
            });

        });

        // ===== Firebase ÌÜµÌï© Í∏∞Îä• =====

        // Firebase Ïó∞Í≤∞ ÏÉÅÌÉú ÌëúÏãú
        function showConnectionStatus(message, type) {
            // ÏÉÅÌÉú ÌëúÏãú ÏòÅÏó≠Ïù¥ ÏóÜÏúºÎ©¥ ÏÉùÏÑ±
            let statusDiv = document.getElementById('connectionStatus');
            if (!statusDiv) {
                statusDiv = document.createElement('div');
                statusDiv.id = 'connectionStatus';
                statusDiv.style.cssText = `
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    padding: 8px 15px;
                    border-radius: 4px;
                    font-size: 12px;
                    font-weight: bold;
                    z-index: 1000;
                    max-width: 200px;
                `;
                document.body.appendChild(statusDiv);
            }

            statusDiv.textContent = message;

            if (type === 'success') {
                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.style.border = '1px solid #c3e6cb';
            } else if (type === 'error') {
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.style.border = '1px solid #f5c6cb';
            } else {
                statusDiv.style.backgroundColor = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.style.border = '1px solid #ffeaa7';
            }
        }

        // FirebaseÏóê Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî
        function syncToFirebase(path, data) {
            if (!window.firebase || !window.firebaseInitialized) {
                console.log(`FirebaseÍ∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïÑ ${path} ÎèôÍ∏∞ÌôîÎ•º Í±¥ÎÑàÎúÅÎãàÎã§.`);
                return;
            }

            try {
                const dataRef = window.firebase.ref(window.firebase.database, path);
                window.firebase.set(dataRef, data).then(() => {
                    console.log(`${path} Îç∞Ïù¥ÌÑ∞Í∞Ä FirebaseÏóê Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.`);
                }).catch(error => {
                    console.error(`${path} Firebase Ï†ÄÏû• Ïò§Î•ò:`, error);
                    showConnectionStatus('‚ö†Ô∏è Firebase Ï†ÄÏû• Ïò§Î•ò', 'error');
                });
            } catch (error) {
                console.error(`${path} Firebase ÎèôÍ∏∞Ìôî Ïò§Î•ò:`, error);
                showConnectionStatus('‚ö†Ô∏è Firebase ÎèôÍ∏∞Ìôî Ïò§Î•ò', 'error');
            }
        }

        // Firebase Ïã§ÏãúÍ∞Ñ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
        function setupFirebaseListeners() {
            if (!window.firebase || !window.firebaseInitialized) {
                console.log('FirebaseÍ∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïÑ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ïÏùÑ Í±¥ÎÑàÎúÅÎãàÎã§.');
                return;
            }

            // ÌïôÏÉù ÌôïÏù∏ ÏÉÅÌÉú Î¶¨Ïä§ÎÑà
            const checkedRef = window.firebase.ref(window.firebase.database, 'studentChecked');
            firebaseListeners.studentChecked = window.firebase.onValue(checkedRef, (snapshot) => {
                const data = snapshot.val();
                // Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÎì† ÏóÜÎì† Ìï≠ÏÉÅ ÏóÖÎç∞Ïù¥Ìä∏ (ÏÇ≠Ï†úÎêú Í≤ΩÏö∞ Îπà Í∞ùÏ≤¥Î°ú ÏÑ§Ï†ï)
                studentChecked = data || {};
                localStorage.setItem('studentChecked', JSON.stringify(studentChecked));
                console.log('Firebase ÌôïÏù∏ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏:', studentChecked);
                // ÌòÑÏû¨ Ï†êÏàò Í¥ÄÎ¶¨ ÌÉ≠Ïù¥ Ïó¥Î†§ÏûàÎã§Î©¥ ÌÖåÏù¥Î∏î ÏÉàÎ°úÍ≥†Ïπ®
                if (currentScoreSubject && document.getElementById('admin-content').classList.contains('active')) {
                    generateScoreTable();
                }
            });

            // ÌïôÏÉù Î¨∏Ïùò ÏÉÅÌÉú Î¶¨Ïä§ÎÑà
            const questionsRef = window.firebase.ref(window.firebase.database, 'studentQuestions');
            firebaseListeners.studentQuestions = window.firebase.onValue(questionsRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    studentQuestions = data;
                    localStorage.setItem('studentQuestions', JSON.stringify(studentQuestions));
                    // ÌòÑÏû¨ Ï†êÏàò Í¥ÄÎ¶¨ ÌÉ≠Ïù¥ Ïó¥Î†§ÏûàÎã§Î©¥ ÌÖåÏù¥Î∏î ÏÉàÎ°úÍ≥†Ïπ®
                    if (currentScoreSubject && document.getElementById('admin-content').classList.contains('active')) {
                        generateScoreTable();
                    }
                }
            });




            console.log('Firebase Ïã§ÏãúÍ∞Ñ Î¶¨Ïä§ÎÑàÍ∞Ä ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§.');
        }


        // Í∏∞Î≥∏ ÎπÑÎ∞ÄÎ≤àÌò∏ ÏÉùÏÑ± Ìï®Ïàò
        function generateDefaultPassword(studentNumber) {
            return '123456'; // Î™®Îì† ÌïôÏÉùÏùò Ï¥àÍ∏∞ ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 123456
        }

        // ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥¥Í∏∞/Ïà®Í∏∞Í∏∞ ÌÜ†Í∏Ä
        function togglePasswordVisibility() {
            const passwordField = document.getElementById('modalStudentPassword');
            const toggleBtn = document.getElementById('togglePasswordBtn');

            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                toggleBtn.textContent = 'üôà';
            } else {
                passwordField.type = 'password';
                toggleBtn.textContent = 'üëÅÔ∏è';
            }
        }

        // ÎπÑÎ∞ÄÎ≤àÌò∏ Ï¥àÍ∏∞Ìôî
        function resetPassword() {
            if (!currentEditingStudent) return;

            const student = students[currentEditingStudent];
            const confirmMsg = `${student.name} ÌïôÏÉùÏùò ÎπÑÎ∞ÄÎ≤àÌò∏Î•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n` +
                              `‚Ä¢ ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä 123456ÏúºÎ°ú Ïû¨ÏÑ§Ï†ïÎê©ÎãàÎã§\n` +
                              `‚Ä¢ ÌïôÏÉùÏùÄ Îã§Ïùå Î°úÍ∑∏Ïù∏ Ïãú ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏÑ§Ï†ïÌï¥Ïïº Ìï©ÎãàÎã§\n` +
                              `‚Ä¢ Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§`;

            if (!confirm(confirmMsg)) return;

            // ÎπÑÎ∞ÄÎ≤àÌò∏Î•º 123456ÏúºÎ°ú Ï¥àÍ∏∞Ìôî
            students[currentEditingStudent].password = '123456';

            // Î™®Îã¨Ïùò ÎπÑÎ∞ÄÎ≤àÌò∏ ÌïÑÎìú ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('modalStudentPassword').value = '123456';

            // Ï†ÄÏû•
            saveStudents();

            alert(`${student.name} ÌïôÏÉùÏùò ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä 123456ÏúºÎ°ú Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.\nÌïôÏÉùÏóêÍ≤å Ï≤´ Î°úÍ∑∏Ïù∏ Ïãú ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏÑ§Ï†ïÌïòÎèÑÎ°ù ÏïàÎÇ¥Ìï¥Ï£ºÏÑ∏Ïöî.`);
        }

        // Firebase ÏÑ§Ï†ï Î™®Îã¨ Í¥ÄÎ†® Ìï®ÏàòÎì§
        function openFirebaseSettings() {
            const modal = document.getElementById('firebaseSettingsModal');

            // Ï†ÄÏû•Îêú ÏÑ§Ï†ïÏù¥ ÏûàÏúºÎ©¥ ÌëúÏãú
            const apiKey = localStorage.getItem('firebaseApiKey');
            const projectId = localStorage.getItem('firebaseProjectId');

            if (apiKey) document.getElementById('firebaseApiKey').value = apiKey;
            if (projectId) document.getElementById('firebaseProjectId').value = projectId;

            modal.style.display = 'block';
        }

        function closeFirebaseModal() {
            document.getElementById('firebaseSettingsModal').style.display = 'none';
        }

        // QR ÏΩîÎìú Î™®Îã¨ Ïó¥Í∏∞
        function openQRModal() {
            const apiKey = localStorage.getItem('firebaseApiKey');
            const projectId = localStorage.getItem('firebaseProjectId');

            if (!apiKey || !projectId) {
                alert('Î®ºÏ†Ä Firebase ÏÑ§Ï†ïÏùÑ ÏôÑÎ£åÌï¥Ï£ºÏÑ∏Ïöî.');
                openFirebaseSettings();
                return;
            }

            // ÌïôÏÉùÏö© ÌéòÏù¥ÏßÄ URL ÏÉùÏÑ± (ÏÉà ÌååÏùºÎ™Ö)
            const studentUrl = `https://bali-lover.github.io/performance_evaluation/student?apiKey=${encodeURIComponent(apiKey)}&projectId=${encodeURIComponent(projectId)}`;

            // QR ÏΩîÎìú Î™®Îã¨ ÌëúÏãú
            const qrModal = document.getElementById('qrModal');
            const qrContainer = document.getElementById('qr-container');
            const qrUrlElement = document.getElementById('qr-url');

            // URL ÌëúÏãú
            qrUrlElement.textContent = studentUrl;
            qrUrlElement.href = studentUrl;

            // QR ÏΩîÎìú ÏÉùÏÑ±
            generateQRCode(studentUrl);

            qrModal.style.display = 'block';
        }

        // QR ÏΩîÎìú ÏÉùÏÑ±
        function generateQRCode(url) {
            const qrContainer = document.getElementById('qr-container');
            qrContainer.innerHTML = '';

            try {
                // QR.js API ÏÇ¨Ïö©
                const qrSize = 250;
                const encodedUrl = encodeURIComponent(url);
                const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${qrSize}x${qrSize}&data=${encodedUrl}`;

                const qrImg = document.createElement('img');
                qrImg.src = qrApiUrl;
                qrImg.style.width = qrSize + 'px';
                qrImg.style.height = qrSize + 'px';
                qrImg.style.borderRadius = '8px';
                qrImg.alt = 'QR Code';

                qrImg.onerror = function() {
                    // API Ïã§Ìå®Ïãú ÌÖçÏä§Ìä∏ ÎßÅÌÅ¨Î°ú ÎåÄÏ≤¥
                    qrContainer.innerHTML = `
                        <div style="padding: 50px; color: #999;">
                            <p>QR ÏΩîÎìú ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.</p>
                            <p>ÏßÅÏ†ë ÎßÅÌÅ¨Î•º ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî.</p>
                        </div>
                    `;
                };

                qrContainer.appendChild(qrImg);

            } catch (error) {
                console.error('QR ÏΩîÎìú ÏÉùÏÑ± Ïò§Î•ò:', error);
                qrContainer.innerHTML = `
                    <div style="padding: 50px; color: #999;">
                        <p>QR ÏΩîÎìú ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.</p>
                    </div>
                `;
            }
        }

        // QR ÏΩîÎìú Î™®Îã¨ Îã´Í∏∞
        function closeQRModal() {
            document.getElementById('qrModal').style.display = 'none';
        }

        // QR ÎßÅÌÅ¨ Î≥µÏÇ¨
        function copyQRLink() {
            const qrUrl = document.getElementById('qr-url').href;

            navigator.clipboard.writeText(qrUrl).then(() => {
                alert('ÎßÅÌÅ¨Í∞Ä ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!');
            }).catch(() => {
                // Î≥µÏÇ¨ Ïã§Ìå®Ïãú ÏÑ†ÌÉùÌïòÏó¨ Î≥µÏÇ¨ÌïòÎèÑÎ°ù ÏïàÎÇ¥
                const textArea = document.createElement('textarea');
                textArea.value = qrUrl;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('ÎßÅÌÅ¨Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!');
            });
        }

        async function testFirebaseConnection() {
            const apiKey = document.getElementById('firebaseApiKey').value.trim();
            const projectId = document.getElementById('firebaseProjectId').value.trim();

            if (!apiKey || !projectId) {
                showConnectionStatus('API KeyÏôÄ Project IDÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }

            showConnectionStatus('üîç Firebase Ïó∞Í≤∞ÏùÑ ÌÖåÏä§Ìä∏ÌïòÎäî Ï§ë...', 'info');

            try {
                // ÏÑ§Ï†ï Ï†ÄÏû•
                localStorage.setItem('firebaseApiKey', apiKey);
                localStorage.setItem('firebaseProjectId', projectId);

                // ÎÇòÎ®∏ÏßÄ Í∞íÎì§ ÏûêÎèô ÏÉùÏÑ±
                const authDomain = `${projectId}.firebaseapp.com`;
                const databaseURL = `https://${projectId}-default-rtdb.asia-southeast1.firebasedatabase.app/`;
                const storageBucket = `${projectId}.appspot.com`;

                localStorage.setItem('firebaseAuthDomain', authDomain);
                localStorage.setItem('userDatabaseURL', databaseURL);
                localStorage.setItem('firebaseStorageBucket', storageBucket);

                // Firebase Ï¥àÍ∏∞Ìôî ÏãúÎèÑ
                const success = await window.initializeFirebase();

                if (success) {
                    // Í∞ÑÎã®Ìïú ÌÖåÏä§Ìä∏ Ïì∞Í∏∞/ÏùΩÍ∏∞
                    const testRef = window.firebase.ref(window.firebase.database, 'test');
                    await window.firebase.set(testRef, { timestamp: Date.now() });
                    showConnectionStatus('‚úÖ Firebase Ïó∞Í≤∞ Î∞è ÏùΩÍ∏∞/Ïì∞Í∏∞ ÏÑ±Í≥µ!', 'success');
                } else {
                    throw new Error('Firebase Ï¥àÍ∏∞Ìôî Ïã§Ìå®');
                }

            } catch (error) {
                console.error('Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ Ïò§Î•ò:', error);
                showConnectionStatus(`‚ùå Ïó∞Í≤∞ Ïò§Î•ò: ${error.message}`, 'error');
            }
        }

        function showConnectionStatus(message, type) {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;

            if (type === 'success') {
                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.style.border = '1px solid #c3e6cb';
            } else if (type === 'error') {
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.style.border = '1px solid #f5c6cb';
            } else if (type === 'info') {
                statusDiv.style.backgroundColor = '#d1ecf1';
                statusDiv.style.color = '#0c5460';
                statusDiv.style.border = '1px solid #bee5eb';
            }
        }

        async function saveUserFirebaseConfig() {
            const apiKey = document.getElementById('firebaseApiKey').value.trim();
            const projectId = document.getElementById('firebaseProjectId').value.trim();

            // ÌïÑÏàò ÌïÑÎìú Í≤ÄÏ¶ù
            if (!apiKey || !projectId) {
                alert('API KeyÏôÄ Project IDÎäî ÌïÑÏàò ÏûÖÎ†• Ìï≠Î™©ÏûÖÎãàÎã§.');
                return;
            }

            if (!apiKey.startsWith('AIza')) {
                alert('Ïò¨Î∞îÎ•∏ Firebase API KeyÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî. (AIzaÎ°ú ÏãúÏûë)');
                return;
            }

            // localStorageÏóê ÏÑ§Ï†ï Ï†ÄÏû•
            localStorage.setItem('firebaseApiKey', apiKey);
            localStorage.setItem('firebaseProjectId', projectId);

            // ÎÇòÎ®∏ÏßÄ Í∞íÎì§ÏùÄ Project IDÎ•º Í∏∞Î∞òÏúºÎ°ú ÏûêÎèô ÏÉùÏÑ±
            const authDomain = `${projectId}.firebaseapp.com`;
            const databaseURL = `https://${projectId}-default-rtdb.asia-southeast1.firebasedatabase.app/`;
            const storageBucket = `${projectId}.appspot.com`;

            localStorage.setItem('firebaseAuthDomain', authDomain);
            localStorage.setItem('userDatabaseURL', databaseURL);
            localStorage.setItem('firebaseStorageBucket', storageBucket);

            // Firebase Ï¥àÍ∏∞Ìôî ÏãúÎèÑ
            try {
                const success = await window.initializeFirebase();
                if (success) {
                    // Firebase Ïó∞Í≤∞ ÌõÑ Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞
                    await loadStudents();
                    await loadSubjects();
                    await loadScores();
                    await loadStudentChecked();
                    await loadStudentQuestions();
                    alert('Firebase ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÍ≥† Ïó∞Í≤∞ÎêòÏóàÏäµÎãàÎã§!\n\n‚Ä¢ API Key: ' + apiKey.substring(0, 20) + '...\n‚Ä¢ Project ID: ' + projectId + '\n‚Ä¢ ÏßÄÏó≠: Ïã±Í∞ÄÌè¨Î•¥ (asia-southeast1)\n\nÎ™®Îì† Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞Î•º FirebaseÏóêÏÑú Î∂àÎü¨ÏôîÏäµÎãàÎã§.');
                } else {
                    alert('Firebase ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏßÄÎßå Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.\n\nÏÑ§Ï†ïÏùÑ ÌôïÏù∏ÌïòÍ≥† Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                }
            } catch (error) {
                console.error('Firebase Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', error);
                alert('Firebase ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏßÄÎßå Ï¥àÍ∏∞Ìôî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }

            closeFirebaseModal();
        }

        // ÌïôÏÉùÏö© ÎßÅÌÅ¨ ÏÉùÏÑ±
        function generateStudentLink() {
            const apiKey = localStorage.getItem('firebaseApiKey');
            const projectId = localStorage.getItem('firebaseProjectId');

            if (!apiKey || !projectId) {
                alert('Î®ºÏ†Ä Firebase ÏÑ§Ï†ïÏùÑ Ï†ÄÏû•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            // ÌïôÏÉùÏö© ÎßÅÌÅ¨ ÏÉùÏÑ± (URL ÌååÎùºÎØ∏ÌÑ∞Î°ú Firebase ÏÑ§Ï†ï Ï†ÑÎã¨)
            const baseUrl = 'https://bali-lover.github.io/performance_evaluation/student';
            const studentUrl = `${baseUrl}?apiKey=${encodeURIComponent(apiKey)}&projectId=${encodeURIComponent(projectId)}`;

            // ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨
            navigator.clipboard.writeText(studentUrl).then(() => {
                alert(`ÌïôÏÉùÏö© ÎßÅÌÅ¨Í∞Ä ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!\n\nüìã Î≥µÏÇ¨Îêú ÎßÅÌÅ¨:\n${studentUrl}\n\nÌïôÏÉùÎì§ÏóêÍ≤å Ïù¥ ÎßÅÌÅ¨Î•º Í≥µÏú†ÌïòÏÑ∏Ïöî.`);
            }).catch(() => {
                // ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨ Ïã§Ìå® Ïãú ÌÖçÏä§Ìä∏Î°ú ÌëúÏãú
                prompt('ÌïôÏÉùÏö© ÎßÅÌÅ¨ÏûÖÎãàÎã§. Î≥µÏÇ¨Ìï¥ÏÑú ÌïôÏÉùÎì§ÏóêÍ≤å Í≥µÏú†ÌïòÏÑ∏Ïöî:', studentUrl);
            });
        }

        // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠Ïãú Îã´Í∏∞
        document.getElementById('firebaseSettingsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeFirebaseModal();
            }
        });

        document.getElementById('qrModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeQRModal();
            }
        });

        document.getElementById('studentModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        document.getElementById('autoAreaModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAutoAreaModal();
            }
        });


        // Firebase Î¶¨Ïä§ÎÑà Ï†ïÎ¶¨ (ÌéòÏù¥ÏßÄ Ïñ∏Î°úÎìú Ïãú)
        window.addEventListener('beforeunload', () => {
            Object.values(firebaseListeners).forEach(unsubscribe => {
                if (typeof unsubscribe === 'function') {
                    unsubscribe();
                }
            });
        });
    </script>
</body>
</html>
