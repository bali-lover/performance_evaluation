<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìˆ˜í–‰í‰ê°€ ì ìˆ˜ í™•ì¸ ì‹œìŠ¤í…œ v1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getDatabase, ref, set, onValue, update, remove } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';

        // Firebase ì´ˆê¸°í™”ëŠ” ì‚¬ìš©ì ì„¤ì • í›„ì— ì§„í–‰
        let firebaseInitialized = false;

        // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
        window.firebase = null;

        // Firebase ì´ˆê¸°í™” í•¨ìˆ˜
        async function initializeFirebase(databaseURL) {
            try {
                const firebaseConfig = {
                    databaseURL: databaseURL
                };

                const app = initializeApp(firebaseConfig);
                const database = getDatabase(app);

                // ì „ì—­ ë³€ìˆ˜ë¡œ ì„¤ì •
                window.firebase = {
                    database,
                    ref,
                    set,
                    onValue,
                    update,
                    remove,
                    app
                };

                firebaseInitialized = true;
                return true;
            } catch (error) {
                console.error('Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                window.firebase = null;
                firebaseInitialized = false;
                return false;
            }
        }
    </script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            overflow-x: hidden;
            zoom: 0.8;
            margin: 5px;
            padding: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        .header {
            background-color: white;
            color: #333;
            padding: 6px 15px;
            border-radius: 6px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
            margin-bottom: 2px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            margin: 0;
            font-size: 18px;
            color: #333;
            display: flex;
            align-items: center;
        }

        .header h1::before {
            content: "ğŸ“Š";
            margin-right: 10px;
            font-size: 24px;
        }

        .header-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }

        .connection-status {
            background-color: #ffc107;
            color: #212529;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 14px;
            white-space: nowrap;
            min-width: 120px;
        }

        .tab.active {
            background: white;
            border-bottom: 3px solid #007bff;
        }

        .tab-content {
            display: none;
            padding: 20px;
        }

        .tab-content.active {
            display: block;
        }

        .subject-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
        }

        .section {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .subject-section {
            background-color: #f0f8ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .subject-management-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .subject-input-section {
            flex: 0 0 300px;
            background-color: #e8f5e8;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            padding: 20px;
        }

        .subject-list-section {
            flex: 1;
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 20px;
        }

        .grade-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .grade-column {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            background-color: #f8f9fa;
        }

        .grade-column h5 {
            margin: 0 0 10px 0;
            color: #007bff;
            font-size: 14px;
            text-align: center;
            border-bottom: 2px solid #007bff;
            padding-bottom: 8px;
        }

        .grade-column.grade-3 {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }

        .grade-column.grade-2 {
            background-color: #e8f5e9;
            border-color: #4caf50;
        }

        .grade-column.grade-1 {
            background-color: #fff3e0;
            border-color: #ff9800;
        }

        /* ì ìˆ˜ ê´€ë¦¬ìš© ê³¼ëª© ì„ íƒ ìŠ¤íƒ€ì¼ */
        .score-subject-section {
            background-color: #f0f8ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .score-subject-item {
            display: block;
            background: #fff3e0;
            color: #e65100;
            padding: 8px 12px;
            border-radius: 8px;
            margin: 5px 0;
            font-size: 12px;
            border: 1px solid #ffcc02;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .score-subject-item:hover {
            background: #e65100;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .score-subject-item.selected {
            background: #e65100;
            color: white;
            border-color: #bf360c;
        }

        .grade-subject-group {
            margin-bottom: 15px;
        }

        .grade-subject-group h5 {
            margin: 0 0 10px 0;
            color: #007bff;
            font-size: 14px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        .subject-item {
            display: block;
            background: #e3f2fd;
            color: #1976d2;
            padding: 8px 12px;
            border-radius: 8px;
            margin: 5px 0;
            font-size: 12px;
            border: 1px solid #bbdefb;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .subject-item:hover {
            background: #1976d2;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .subject-item.selected {
            background: #1976d2;
            color: white;
            border-color: #0d47a1;
        }

        .subject-item .delete-btn {
            margin-left: 8px;
            color: #f44336;
            cursor: pointer;
            font-weight: bold;
        }

        .subject-item .delete-btn:hover {
            color: #d32f2f;
        }

        /* ë“±ë¡ ì„¹ì…˜ ê°œì„ ëœ ë ˆì´ì•„ì›ƒ */
        .registration-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .registration-item {
            flex: 1;
            background-color: #e8f5e8;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            padding: 20px;
        }

        .registration-item h4 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #155724;
        }

        /* ë°˜ì‘í˜• ë””ìì¸: ëª¨ë°”ì¼ì—ì„œëŠ” ì„¸ë¡œ ì •ë ¬ */
        @media (max-width: 768px) {
            .registration-row {
                flex-direction: column;
                gap: 15px;
            }
        }

        .grade-tabs {
            display: flex;
            border-bottom: 1px solid #ccc;
            margin-bottom: 20px;
            background-color: #f8f9fa;
            border-radius: 4px 4px 0 0;
        }

        .grade-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            background: #e9ecef;
            border: none;
            font-size: 14px;
            border-right: 1px solid #ccc;
        }

        .grade-tab:last-child {
            border-right: none;
        }

        .grade-tab.active {
            background: white;
            border-bottom: 2px solid #007bff;
            font-weight: bold;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .input-field {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .select-field {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }

        .score-input {
            width: 60px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }

        .btn {
            padding: 8px 14px;
            margin: 3px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
            background-color: #007bff;
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn.success {
            background-color: #28a745;
        }

        .btn.success:hover {
            background-color: #218838;
        }

        .btn.danger {
            background-color: #dc3545;
        }

        .btn.danger:hover {
            background-color: #c82333;
        }

        .btn.warning {
            background-color: #ffc107;
            color: #212529;
        }

        .btn.warning:hover {
            background-color: #e0a800;
        }

        .btn.info {
            background-color: #17a2b8;
        }

        .btn.info:hover {
            background-color: #138496;
        }

        .tag {
            border-radius: 20px;
            padding: 5px 15px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin: 2px;
        }

        .area-tag {
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
        }

        .subject-tag {
            background-color: #f0f8ff;
            border: 1px solid #4169e1;
        }

        .tag .remove-btn {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .list-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .subject-areas {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .class-matrix {
            overflow-x: auto;
            margin: 20px 0;
        }

        .matrix-table {
            border-collapse: collapse;
            min-width: 100%;
            background: white;
        }

        .matrix-table th {
            background-color: #007bff;
            color: white;
            padding: 8px 4px;
            text-align: center;
            font-size: 12px;
            min-width: 80px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .matrix-table th.row-header {
            background-color: #28a745;
            position: sticky;
            left: 0;
            z-index: 11;
            min-width: 40px;
        }

        .matrix-table td {
            border: 1px solid #ddd;
            padding: 4px;
            text-align: center;
            font-size: 11px;
            min-width: 80px;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            height: 35px;
            vertical-align: middle;
        }

        .matrix-table td.row-header {
            background-color: #e8f5e8;
            font-weight: bold;
            position: sticky;
            left: 0;
            z-index: 9;
            min-width: 40px;
            max-width: 40px;
        }

        .matrix-table td.student-cell {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .matrix-table td.student-cell:hover {
            background-color: #e3f2fd;
        }

        .matrix-table td.student-cell.empty {
            background-color: #f8f9fa;
            color: #999;
        }

        .matrix-table td.student-cell.filled {
            background-color: #e8f5e8;
            color: #333;
            font-weight: bold;
        }

        .score-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            overflow-x: auto;
            display: block;
            white-space: nowrap;
        }

        .score-table thead, .score-table tbody {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        .score-table th, .score-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            min-width: 80px;
        }

        .score-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            position: sticky;
            top: 0;
        }

        .student-login {
            text-align: center;
            padding: 40px;
        }

        .login-input {
            padding: 12px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px;
            width: 120px;
            text-align: center;
        }

        .result-box {
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 4px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 4px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .upload-area:hover {
            border-color: #007bff;
        }

        .upload-area.dragover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }

        .stats-box {
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 4px;
            padding: 15px;
            text-align: center;
            margin: 10px 0;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .modal-content {
            background-color: white;
            margin: 0;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            text-align: left;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
            box-sizing: border-box;
            overflow: hidden;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 20px 30px;
            text-align: center;
            border-bottom: none;
        }

        .modal-header h4 {
            margin: 0 0 10px 0;
            font-size: 20px;
        }

        .student-info-text {
            margin: 0;
            font-weight: bold;
            opacity: 0.9;
            font-size: 16px;
        }

        .modal-body {
            padding: 30px;
        }

        .modal-footer {
            padding: 20px 30px;
            background-color: #f8f9fa;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: nowrap;
        }

        .modal-footer .btn {
            flex: 1;
            font-size: 13px;
            padding: 10px 8px;
            min-width: 0;
            white-space: nowrap;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .password-field {
            background-color: #f8f9fa !important;
        }

        .password-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .password-toggle-btn {
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .password-toggle-btn:hover {
            background-color: #f8f9fa;
            border-color: #007bff;
        }

        .info-box {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
            font-size: 14px;
            color: #856404;
            line-height: 1.5;
        }

        .btn.secondary {
            background-color: #6c757d;
        }

        .btn.secondary:hover {
            background-color: #545b62;
        }

        /* Firebase ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0,0,0,0.8);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 0;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
            position: relative;
            z-index: 10000;
        }

        .modal-title {
            margin: 0;
            font-size: 18px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: #333;
        }

        .modal-step {
            padding: 20px;
        }

        .modal-buttons {
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .subject-selector {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #e3f2fd;
            border-radius: 4px;
        }

        .hidden {
            display: none !important;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f8f9fa;
            transition: background-color 0.2s;
        }

        .checkbox-item:hover {
            background-color: #e9ecef;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 12px;
            transform: scale(1.2);
        }

        .checkbox-item label {
            flex: 1;
            cursor: pointer;
            margin: 0;
        }

        .checkbox-item .subject-info {
            color: #666;
            font-size: 12px;
            margin-left: 8px;
        }

        .grade-section {
            margin-bottom: 25px;
            border: 1px solid #007bff;
            border-radius: 4px;
            overflow: hidden;
        }

        .grade-header {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .grade-content {
            padding: 15px;
        }

        .select-all-grade {
            background: none;
            border: 1px solid white;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
        }

        .select-all-grade:hover {
            background-color: rgba(255,255,255,0.2);
        }

        @media (max-width: 768px) {
            .input-group {
                flex-direction: column;
            }

            .tabs {
                font-size: 12px;
            }

            .tab {
                min-width: 100px;
                padding: 10px;
            }

            .matrix-table th, .matrix-table td {
                min-width: 60px;
                max-width: 60px;
                font-size: 10px;
            }

            .modal {
                padding: 10px 0;
            }

            .modal-content {
                margin: 20px auto;
                width: 95%;
                max-width: none;
            }

            .modal-header {
                padding: 15px 20px;
            }

            .modal-body {
                padding: 20px;
            }

            .modal-footer {
                padding: 15px 20px;
                flex-direction: column;
                gap: 8px;
            }

            .modal-footer .btn {
                width: 100%;
                flex: none;
                font-size: 14px;
                padding: 12px;
            }

            .password-input-group {
                flex-direction: column;
                gap: 8px;
            }

            .password-toggle-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ìˆ˜í–‰í‰ê°€ ì ìˆ˜ í™•ì¸ ì‹œìŠ¤í…œ v1</h1>
            <div class="header-buttons">
                <div class="connection-status" id="connectionStatus">
                    ğŸ”„ ì—°ê²° ì¤‘...
                </div>
                <button class="btn btn-secondary" onclick="openFirebaseSettings()" id="firebaseSettingsBtn">
                    âš™ï¸ Firebase ì„¤ì •
                </button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('students')">ğŸ‘¥ í•™ìƒê´€ë¦¬</button>
            <button class="tab" onclick="switchTab('subjects')">ğŸ“š ê³¼ëª©/ì˜ì—­ì„¤ì •</button>
            <button class="tab" onclick="switchTab('admin')">ğŸ¯ ì ìˆ˜ê´€ë¦¬</button>
            <button class="tab" onclick="switchTab('student')">ğŸ“ í•™ìƒì¡°íšŒ</button>
        </div>

        <!-- í•™ìƒê´€ë¦¬ íƒ­ -->
        <div id="students-content" class="tab-content active">

            <!-- ê°œë³„ë“±ë¡ê³¼ ì¼ê´„ë“±ë¡ì„ ë‚˜ë€íˆ ë°°ì¹˜ -->
            <div class="registration-row">
                <div class="registration-item">
                    <h4>ğŸ“ í•™ìƒ ê°œë³„ ë“±ë¡</h4>
                    <div class="input-group">
                        <input type="text" class="input-field" id="studentNumber" placeholder="í•™ë²ˆ (ì˜ˆ: 30101)" style="width: 100px;"
                               title="í•™ìƒì˜ í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš” (5ìë¦¬ ìˆ«ì)"
                               aria-label="í•™ìƒ í•™ë²ˆ ì…ë ¥">
                        <input type="text" class="input-field" id="studentName" placeholder="í•™ìƒ ì´ë¦„" style="flex: 1;"
                               title="í•™ìƒì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
                               aria-label="í•™ìƒ ì´ë¦„ ì…ë ¥">
                        <button class="btn" onclick="addStudent()">â• í•™ìƒ ì¶”ê°€</button>
                    </div>
                </div>
                <div class="registration-item">
                    <h4>ğŸ“¤ ëª…ë‹¨ ì¼ê´„ ë“±ë¡</h4>
                    <div class="upload-area" onclick="document.getElementById('studentFileInput').click()">
                        <p>ì—‘ì…€ íŒŒì¼ë¡œ í•™ìƒ ëª…ë‹¨ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
                        <p style="font-size: 12px; color: #666;">í˜•ì‹: Aì—´-í•™ë²ˆ(30101), Bì—´-ì´ë¦„</p>
                        <input type="file" id="studentFileInput" accept=".xlsx,.xls" style="display: none;" onchange="uploadStudentFile(event)"
                               title="í•™ìƒ ëª…ë‹¨ ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”"
                               aria-label="í•™ìƒ ëª…ë‹¨ íŒŒì¼ ì„ íƒ">
                    </div>
                </div>
            </div>

            <!-- í•™ë…„ë³„ íƒ­ -->
            <div class="grade-tabs">
                <button class="grade-tab active" onclick="switchGrade(3)" id="grade3-tab">3í•™ë…„</button>
                <button class="grade-tab" onclick="switchGrade(2)" id="grade2-tab">2í•™ë…„</button>
                <button class="grade-tab" onclick="switchGrade(1)" id="grade1-tab">1í•™ë…„</button>
            </div>

            <div id="matrixContainer" class="class-matrix">
                <!-- í•™ê¸‰ ë§¤íŠ¸ë¦­ìŠ¤ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn warning" onclick="downloadStudentTemplate()">ğŸ“¥ ëª…ë‹¨ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
                <button class="btn danger" onclick="clearAllStudents()">ğŸ—‘ï¸ ëª¨ë“  í•™ìƒ ì‚­ì œ</button>
            </div>
        </div>

        <!-- ê³¼ëª©/ì˜ì—­ì„¤ì • íƒ­ -->
        <div id="subjects-content" class="tab-content">

            <!-- ê³¼ëª© ê´€ë¦¬ë¥¼ ì¢Œìš°ë¡œ ë°°ì¹˜ -->
            <div class="subject-management-row">
                <div class="subject-input-section">
                    <h4>ğŸ“– ê³¼ëª© ì¶”ê°€</h4>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <select class="select-field" id="subjectGrade"
                                title="ê³¼ëª©ì„ ì¶”ê°€í•  í•™ë…„ì„ ì„ íƒí•˜ì„¸ìš”"
                                aria-label="í•™ë…„ ì„ íƒ">
                            <option value="1">1í•™ë…„</option>
                            <option value="2">2í•™ë…„</option>
                            <option value="3" selected>3í•™ë…„</option>
                        </select>
                        <input type="text" class="input-field" id="subjectName" placeholder="ê³¼ëª©ëª… (ì˜ˆ: êµ­ì–´, ìˆ˜í•™, ì‚¬íšŒ)"
                               title="ì¶”ê°€í•  ê³¼ëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
                               aria-label="ê³¼ëª©ëª… ì…ë ¥">
                        <button class="btn info" onclick="addSubject()">â• ê³¼ëª© ì¶”ê°€</button>
                    </div>
                </div>
                <div class="subject-list-section">
                    <h4>ğŸ“š ë“±ë¡ëœ ê³¼ëª© ë° ìˆ˜í–‰ì˜ì—­ ì„¤ì • <span style="font-size: 12px; color: #666; font-weight: normal;">(ë“±ë¡ëœ ê³¼ëª©ì„ í´ë¦­í•˜ì—¬ ìˆ˜í–‰ì˜ì—­ì„ ì„¤ì •í•˜ì„¸ìš”)</span></h4>
                    <div id="subjectList" class="subject-list-by-grade">
                        <!-- í•™ë…„ë³„ë¡œ êµ¬ë¶„ëœ ê³¼ëª©ë“¤ì´ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>

            <div class="section">

                <div id="areaManagement" style="display: none;">
                    <div class="input-group">
                        <input type="text" class="input-field" id="areaName" placeholder="ìˆ˜í–‰ì˜ì—­ëª… (ì˜ˆ: í† ë¡ ì°¸ì—¬, ë°œí‘œ)" style="flex: 1;"
                               title="ìˆ˜í–‰ì˜ì—­ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
                               aria-label="ìˆ˜í–‰ì˜ì—­ëª… ì…ë ¥">
                        <input type="number" class="score-input" id="areaMaxScore" placeholder="ë§Œì " min="1" max="100"
                               title="í•´ë‹¹ ìˆ˜í–‰ì˜ì—­ì˜ ë§Œì ì„ ì…ë ¥í•˜ì„¸ìš”"
                               aria-label="ë§Œì  ì…ë ¥">
                        <button class="btn" onclick="addArea()">â• ì˜ì—­ ì¶”ê°€</button>
                    </div>

                    <div id="currentSubjectAreas" class="subject-areas">
                        <!-- ì„ íƒëœ ê³¼ëª©ì˜ ìˆ˜í–‰ì˜ì—­ë“¤ì´ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn success" onclick="generateTemplate()" id="templateBtn" disabled>ğŸ“¥ ì ìˆ˜í‘œ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ</button>
                    <button class="btn danger" onclick="clearAllSubjects()">ğŸ—‘ï¸ ëª¨ë“  ê³¼ëª© ì‚­ì œ</button>
                </div>
            </div>
        </div>

        <!-- ì ìˆ˜ê´€ë¦¬ íƒ­ -->
        <div id="admin-content" class="tab-content">
            <div class="score-subject-section">
                <h4>ğŸ“š ì ìˆ˜ ê´€ë¦¬í•  ê³¼ëª© ì„ íƒ <span style="font-size: 12px; color: #666; font-weight: normal;">(ê³¼ëª©ì„ í´ë¦­í•˜ì—¬ ì ìˆ˜ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”)</span></h4>
                <div id="scoreSubjectList" class="score-subject-list-by-grade">
                    <!-- í•™ë…„ë³„ë¡œ êµ¬ë¶„ëœ ì ìˆ˜ ê´€ë¦¬ìš© ê³¼ëª©ë“¤ì´ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>

            <div id="scoreUploadSection" style="display: none;">
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <h4>ğŸ“¤ ì ìˆ˜í‘œ ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</h4>
                    <p>ì™„ì„±ëœ ì ìˆ˜í‘œ ì—‘ì…€ íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</p>
                    <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;" onchange="uploadFile(event)"
                           title="ì ìˆ˜í‘œ ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”"
                           aria-label="ì ìˆ˜í‘œ íŒŒì¼ ì„ íƒ">
                </div>

                <div id="scoreTableContainer">
                    <!-- ë™ì ìœ¼ë¡œ ìƒì„±ëœ ì ìˆ˜í‘œê°€ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="saveScores()">ğŸ’¾ ì ìˆ˜ ì €ì¥</button>
                    <button class="btn danger" onclick="clearScores()">ğŸ—‘ï¸ ì ìˆ˜ ì´ˆê¸°í™”</button>
                </div>

            </div>
        </div>

        <!-- í•™ìƒì¡°íšŒ íƒ­ -->
        <div id="student-content" class="tab-content">
            <div class="student-login">
                <h3>ğŸ“ í•™ìƒ ì ìˆ˜ ì¡°íšŒ</h3>
                <p>ë³¸ì¸ì˜ í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”</p>
                <input type="text" class="login-input" id="studentLoginNumber" placeholder="í•™ë²ˆ(30101)"
                       title="ë³¸ì¸ì˜ í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 30101)"
                       aria-label="í•™ìƒ í•™ë²ˆ ì…ë ¥">
                <br>
                <button class="btn" onclick="checkScore()">ğŸ“Š ì ìˆ˜ í™•ì¸</button>
            </div>

            <div id="studentResult" style="display: none;">
                <!-- ì¡°íšŒ ê²°ê³¼ê°€ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>

    <!-- í•™ìƒ ì •ë³´ ìˆ˜ì • ëª¨ë‹¬ -->
    <!-- í•™ìƒ ì •ë³´ ëª¨ë‹¬ -->
    <div id="studentModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; width: 500px; max-width: 90%; max-height: 90vh; overflow-y: auto;">
            <h3 style="margin: 0 0 20px 0; color: #007bff;">ğŸ‘¤ í•™ìƒ ì •ë³´ ê´€ë¦¬</h3>
            <p id="modalStudentInfo" style="margin: 0 0 20px 0; font-size: 14px; color: #666;"></p>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">í•™ìƒ ì´ë¦„:</label>
                <input type="text" id="modalStudentName" placeholder="í•™ìƒ ì´ë¦„"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;"
                       title="í•™ìƒì˜ ì´ë¦„ì„ ìˆ˜ì •í•˜ì„¸ìš”" aria-label="í•™ìƒ ì´ë¦„ ìˆ˜ì •">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸:</label>
                <div style="display: flex; gap: 5px;">
                    <input type="password" id="modalStudentPassword" readonly
                           style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;"
                           title="í•™ìƒì˜ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤" aria-label="í•™ìƒ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸">
                    <button type="button" id="togglePasswordBtn" onclick="togglePasswordVisibility()"
                            style="padding: 10px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;"
                            title="ë¹„ë°€ë²ˆí˜¸ í‘œì‹œ/ìˆ¨ê¸°ê¸° ì „í™˜" aria-label="ë¹„ë°€ë²ˆí˜¸ í‘œì‹œ ì „í™˜ ë²„íŠ¼">ğŸ‘ï¸</button>
                </div>
            </div>

            <div style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 4px; padding: 15px; margin-bottom: 20px; font-size: 14px;">
                <strong>ğŸ’¡ ë¹„ë°€ë²ˆí˜¸ ê´€ë¦¬:</strong><br>
                â€¢ í•™ìƒì´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ìŠì—ˆì„ ë•Œ í™•ì¸ìš©<br>
                â€¢ ì´ˆê¸°í™” ë²„íŠ¼ìœ¼ë¡œ ë¹„ë°€ë²ˆí˜¸ë¥¼ 0123ìœ¼ë¡œ ì¬ì„¤ì •<br>
                â€¢ í•™ìƒì€ ë‹¤ìŒ ë¡œê·¸ì¸ ì‹œ ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì„¤ì • í•„ìš”
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="updateStudent()" style="padding: 10px 20px; border: none; background: #007bff; color: white; border-radius: 4px; cursor: pointer;">ì €ì¥</button>
                <button onclick="resetPassword()" style="padding: 10px 20px; border: none; background: #ffc107; color: black; border-radius: 4px; cursor: pointer;">ì´ˆê¸°í™”</button>
                <button onclick="deleteStudent()" style="padding: 10px 20px; border: none; background: #dc3545; color: white; border-radius: 4px; cursor: pointer;">ì‚­ì œ</button>
                <button onclick="closeModal()" style="padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ìˆ˜í–‰ì˜ì—­ ìë™ ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="autoAreaModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; width: 500px; max-width: 90%; max-height: 90vh; overflow-y: auto;">
            <h3 style="margin: 0 0 20px 0; color: #007bff;">ğŸ¯ ìˆ˜í–‰ì˜ì—­ ìë™ ì¶”ê°€</h3>
            <div id="autoAreaInfo">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë˜ëŠ” ê³¼ëª© ì •ë³´ -->
            </div>

            <div style="text-align: center; margin-top: 30px; border-top: 1px solid #ddd; padding-top: 20px;">
                <button onclick="confirmAutoAreaAddition()" id="confirmAutoBtn" style="padding: 10px 20px; border: none; background: #28a745; color: white; border-radius: 4px; cursor: pointer; margin: 0 5px;">âœ“ ìë™ ì¶”ê°€</button>
                <button onclick="addSubjectWithoutAreas()" id="addWithoutAreasBtn" style="padding: 10px 20px; border: none; background: #007bff; color: white; border-radius: 4px; cursor: pointer; margin: 0 5px;">ğŸ“ ì§ì ‘ ì…ë ¥</button>
                <button onclick="closeAutoAreaModal()" style="padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; margin: 0 5px;">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <!-- Firebase ì„¤ì • ëª¨ë‹¬ -->
    <div id="firebaseSettingsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; width: 450px; max-width: 90%;">
            <h3 style="margin: 0 0 20px 0; color: #007bff;">ğŸ”§ Firebase ì„¤ì •</h3>

            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; line-height: 1.6;">
                <strong>ğŸ“– ì„¤ì • ë°©ë²•:</strong><br>
                1. <a href="https://console.firebase.google.com/" target="_blank" style="color: #3b82f6;">Firebase Console</a>ì—ì„œ í”„ë¡œì íŠ¸ ìƒì„±<br>
                2. Realtime Database í™œì„±í™” (Asia Southeast1 - ì‹±ê°€í¬ë¥´)<br>
                3. í”„ë¡œì íŠ¸ ì„¤ì • â†’ ì›¹ ì•± ì¶”ê°€ â†’ êµ¬ì„± ì •ë³´ì—ì„œ ë³µì‚¬
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">API Key:</label>
                <input type="text" id="firebaseApiKey" placeholder="AIzaSyC..."
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Project ID:</label>
                <input type="text" id="firebaseProjectId" placeholder="your-project-id"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeFirebaseModal()" style="padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">ì·¨ì†Œ</button>
                <button onclick="saveUserFirebaseConfig()" style="padding: 10px 20px; border: none; background: #007bff; color: white; border-radius: 4px; cursor: pointer;">ğŸ’¾ ì €ì¥</button>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë°ì´í„°
        let students = {}; // í•™ë²ˆ: {name: "ì´ë¦„", grade: 3, class: 1, number: 1}
        let subjects = {}; // "í•™ë…„-ê³¼ëª©" í˜•íƒœ: {"3-ì‚¬íšŒ": {areas: [{name: "ì˜ì—­ëª…", maxScore: 20}]}}
        let scores = {}; // "í•™ë…„-ê³¼ëª©" í˜•íƒœ: {"3-ì‚¬íšŒ": {í•™ë²ˆ: {ì˜ì—­ëª…: ì ìˆ˜}}}
        let publishedSubjects = {}; // "í•™ë…„-ê³¼ëª©" í˜•íƒœ: {"3-ì‚¬íšŒ": true/false} - í•™ìƒ ì¡°íšŒ í—ˆìš© ì—¬ë¶€
        let studentChecked = {}; // "í•™ë…„-ê³¼ëª©": {í•™ë²ˆ: {ì˜ì—­ëª…: true/false}} - í•™ìƒì´ ì˜ì—­ë³„ë¡œ í™•ì¸í–ˆëŠ”ì§€ ì—¬ë¶€
        let studentQuestions = {}; // "í•™ë…„-ê³¼ëª©": {í•™ë²ˆ: {ì˜ì—­ëª…: "ì˜ë¬¸ë‚´ìš©"}} - í•™ìƒì´ ì œê¸°í•œ ì˜ë¬¸ì‚¬í•­
        let currentGrade = 3;
        let currentEditingStudent = null;
        let currentSubject = '';
        let currentScoreSubject = '';

        // Firebase ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆë“¤ì„ ì €ì¥í•  ë³€ìˆ˜
        let firebaseListeners = {};

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = async function() {
            loadStudents();
            loadSubjects();
            loadScores();
            loadPublishedSubjects();
            loadStudentChecked();
            loadStudentQuestions();

            // ëª¨ë“  ê³¼ëª©ì˜ ê¸°ë³¸ê°’ì„ í—ˆìš©ìœ¼ë¡œ ì„¤ì •
            setDefaultPublishStatus();

            setupDragAndDrop();
            updateMatrix();
            updateSubjectSelectors();

            // Firebase ìë™ ì´ˆê¸°í™” ì‹œë„
            await autoInitializeFirebase();
        };

        // ëª¨ë“  ê³¼ëª©ì˜ ë°œí–‰ ìƒíƒœë¥¼ ê¸°ë³¸ê°’(í—ˆìš©)ìœ¼ë¡œ ì„¤ì •
        function setDefaultPublishStatus() {
            // ì´ë¯¸ ì´ˆê¸°í™”í–ˆëŠ”ì§€ í™•ì¸
            const hasInitialized = localStorage.getItem('publishStatusInitialized');
            if (hasInitialized) return;

            Object.keys(subjects).forEach(subjectKey => {
                // undefinedì¸ ê³¼ëª©ë§Œ í—ˆìš©ìœ¼ë¡œ ì„¤ì •
                if (publishedSubjects[subjectKey] === undefined) {
                    publishedSubjects[subjectKey] = true;
                }
            });

            // ì´ˆê¸°í™” ì™„ë£Œ í‘œì‹œ
            localStorage.setItem('publishStatusInitialized', 'true');
            savePublishedSubjects();
        }

        // Firebase ìë™ ì´ˆê¸°í™”
        async function autoInitializeFirebase() {
            const savedURL = localStorage.getItem('userDatabaseURL');

            if (savedURL) {
                showConnectionStatus('ğŸ”— Firebase ì—°ê²° ì¤‘...', 'warning');

                const success = await initializeFirebase(savedURL);

                if (success) {
                    showConnectionStatus('ğŸŸ¢ Firebase ì—°ê²°ë¨', 'success');
                    setupFirebaseListeners();
                } else {
                    showConnectionStatus('âŒ Firebase ì—°ê²° ì‹¤íŒ¨', 'error');
                }
            } else {
                showConnectionStatus('âš™ï¸ Firebase ì„¤ì • í•„ìš”', 'warning');
            }
        }

        // íƒ­ ì „í™˜
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tab + '-content').classList.add('active');

            if (tab === 'subjects') {
                updateSubjectSelectors();
            }
        }

        // í•™ë…„ ì „í™˜
        function switchGrade(grade) {
            currentGrade = grade;

            document.querySelectorAll('.grade-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`grade${grade}-tab`).classList.add('active');

            updateMatrix();
        }

        // í•™ë²ˆ íŒŒì‹± í•¨ìˆ˜
        function parseStudentNumber(studentNumber) {
            const str = String(studentNumber);
            if (str.length !== 5) return null;

            const grade = parseInt(str.substring(0, 1));
            const classNum = parseInt(str.substring(1, 3));
            const number = parseInt(str.substring(3, 5));

            if (grade < 1 || grade > 3 || classNum < 1 || classNum > 20 || number < 1 || number > 40) {
                return null;
            }

            return { grade, class: classNum, number };
        }

        // ===== í•™ìƒ ê´€ë¦¬ ê¸°ëŠ¥ =====

        // í•™ìƒ ì¶”ê°€
        function addStudent() {
            const numberInput = document.getElementById('studentNumber');
            const nameInput = document.getElementById('studentName');

            const studentNumber = numberInput.value.trim();
            const name = nameInput.value.trim();

            if (!studentNumber || !name) {
                alert('í•™ë²ˆê³¼ ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const parsed = parseStudentNumber(studentNumber);
            if (!parsed) {
                alert('ì˜¬ë°”ë¥¸ í•™ë²ˆ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. (ì˜ˆ: 30101)');
                return;
            }

            if (students[studentNumber]) {
                alert('ì´ë¯¸ ë“±ë¡ëœ í•™ë²ˆì…ë‹ˆë‹¤.');
                return;
            }

            students[studentNumber] = {
                name: name,
                grade: parsed.grade,
                class: parsed.class,
                number: parsed.number,
                password: generateDefaultPassword(studentNumber) // ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸ ìƒì„±
            };

            numberInput.value = '';
            nameInput.value = '';

            updateStats();
            updateMatrix();
            saveStudents();
            updateTemplateButton();
        }

        // í•™ìƒ ì •ë³´ ìˆ˜ì •/ì‚­ì œ ëª¨ë‹¬ ì—´ê¸°
        function openStudentModal(studentNumber) {
            if (!students[studentNumber]) return;

            currentEditingStudent = studentNumber;
            const student = students[studentNumber];
            const parsed = parseStudentNumber(studentNumber);

            document.getElementById('modalStudentInfo').textContent =
                `${parsed.grade}í•™ë…„ ${parsed.class}ë°˜ ${parsed.number}ë²ˆ (${studentNumber})`;
            document.getElementById('modalStudentName').value = student.name;

            // ë¹„ë°€ë²ˆí˜¸ í‘œì‹œ
            const password = student.password || generateDefaultPassword(studentNumber);
            document.getElementById('modalStudentPassword').value = password;

            // ë¹„ë°€ë²ˆí˜¸ í•„ë“œë¥¼ ì²˜ìŒì—ëŠ” ìˆ¨ê¹€ ìƒíƒœë¡œ
            document.getElementById('modalStudentPassword').type = 'password';
            document.getElementById('togglePasswordBtn').textContent = 'ğŸ‘ï¸';

            document.getElementById('studentModal').style.display = 'block';
        }

        // í•™ìƒ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateStudent() {
            if (!currentEditingStudent) return;

            const newName = document.getElementById('modalStudentName').value.trim();
            if (!newName) {
                alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            students[currentEditingStudent].name = newName;
            closeModal();
            updateMatrix();
            saveStudents();
        }

        // í•™ìƒ ì‚­ì œ
        function deleteStudent() {
            if (!currentEditingStudent) return;

            const student = students[currentEditingStudent];
            if (!confirm(`${student.name} í•™ìƒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            delete students[currentEditingStudent];

            // ëª¨ë“  ê³¼ëª©ì˜ ì ìˆ˜ì—ì„œ í•´ë‹¹ í•™ìƒ ì‚­ì œ
            Object.keys(scores).forEach(subject => {
                delete scores[subject][currentEditingStudent];
            });

            closeModal();
            updateStats();
            updateMatrix();
            saveStudents();
            saveScores();
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal() {
            document.getElementById('studentModal').style.display = 'none';
            currentEditingStudent = null;
        }

        // í•™ê¸‰ ë§¤íŠ¸ë¦­ìŠ¤ ì—…ë°ì´íŠ¸
        function updateMatrix() {
            const container = document.getElementById('matrixContainer');

            // í˜„ì¬ í•™ë…„ì˜ í•™ìƒë“¤ í•„í„°ë§
            const gradeStudents = Object.entries(students).filter(([num, student]) =>
                student.grade === currentGrade
            );

            if (gradeStudents.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h4>${currentGrade}í•™ë…„ì— ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤</h4>
                        <p>ìœ„ì˜ í•™ìƒ ë“±ë¡ ê¸°ëŠ¥ì„ ì´ìš©í•´ í•™ìƒì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.</p>
                    </div>
                `;
                return;
            }

            // ìµœëŒ€ ë°˜ ìˆ˜ì™€ ë²ˆí˜¸ ìˆ˜ ê³„ì‚°
            const maxClass = Math.max(...gradeStudents.map(([num, student]) => student.class));
            const maxNumber = Math.max(...gradeStudents.map(([num, student]) => student.number));

            // í…Œì´ë¸” ìƒì„±
            let html = '<table class="matrix-table"><thead><tr>';
            html += '<th class="row-header">ë²ˆí˜¸</th>';

            for (let c = 1; c <= maxClass; c++) {
                html += `<th>${c}ë°˜</th>`;
            }
            html += '</tr></thead><tbody>';

            for (let n = 1; n <= maxNumber; n++) {
                html += `<tr><td class="row-header">${n}ë²ˆ</td>`;

                for (let c = 1; c <= maxClass; c++) {
                    const studentNumber = `${currentGrade}${c.toString().padStart(2, '0')}${n.toString().padStart(2, '0')}`;
                    const student = students[studentNumber];

                    if (student) {
                        html += `<td class="student-cell filled" onclick="openStudentModal('${studentNumber}')" title="í´ë¦­í•˜ì—¬ ìˆ˜ì •">${student.name}</td>`;
                    } else {
                        html += `<td class="student-cell empty">-</td>`;
                    }
                }
                html += '</tr>';
            }

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats() {
            const totalCount = Object.keys(students).length;

            const gradeStats = {};
            Object.values(students).forEach(student => {
                if (!gradeStats[student.grade]) gradeStats[student.grade] = 0;
                gradeStats[student.grade]++;
            });

            // í•™ë…„ë³„ íƒ­ì— í•™ìƒ ìˆ˜ í‘œì‹œ
            [1, 2, 3].forEach(grade => {
                const tab = document.getElementById(`grade${grade}-tab`);
                const count = gradeStats[grade] || 0;
                if (count > 0) {
                    tab.textContent = `${grade}í•™ë…„(${count}ëª…)`;
                } else {
                    tab.textContent = `${grade}í•™ë…„`;
                }
            });
        }

        // ===== ê³¼ëª© ê´€ë¦¬ ê¸°ëŠ¥ =====

        // ì „ì—­ ë³€ìˆ˜ë¡œ í˜„ì¬ ì¶”ê°€í•˜ë ¤ëŠ” ê³¼ëª© ì •ë³´ ì €ì¥
        let pendingSubject = null;

        // 2025í•™ë…„ë„ 2í•™ê¸° í‰ê°€ê³„íš ì‹¤ì œ ë°ì´í„° (ì „ì—­ ë³€ìˆ˜)
        const evaluationPlan = {
                // 1í•™ë…„ ê³¼ëª©ë“¤ (ì‹¤ì œ PDF ë°ì´í„°)
                '1-êµ­ì–´': [
                    { name: 'ì„œí‰ ì“°ê¸°', maxScore: 30 },
                    { name: 'ë‹¨ì–´ì˜ ì„¸ê³„ íƒêµ¬í•˜ê¸°', maxScore: 20 }
                ],
                '1-ë„ë•': [
                    { name: 'ì¹œêµ¬ ê°„ì— ë¯¿ìŒ ìŒ“ì•„ ê°€ê¸°', maxScore: 20 },
                    { name: 'ê°€ìƒ ê³µê°„ ì† ë„ë• ë¬¸ì œì˜ í•´ê²° ë°©ì•ˆ ëª¨ìƒ‰í•˜ê¸°', maxScore: 20 },
                    { name: 'ë”œë ˆë§ˆ í† ë¡ ', maxScore: 20 },
                    { name: 'ë³´í¸ì  ì¸ê¶Œê³¼ ë¬¸í™”Â·ì¢…êµì˜ ì¡°í™”ë¥¼ ì´ë£¨ì–´ ê°€ê¸°', maxScore: 20 },
                    { name: 'íƒ€ì¸ê³¼ì˜ ê´€ê³„ ì‚¬íšŒê³µë™ì²´ í•™ìŠµìë£Œ í¬íŠ¸í´ë¦¬ì˜¤', maxScore: 20 }
                ],
                '1-ì‚¬íšŒ': [
                    { name: 'ëª¨ì˜ì¬íŒ', maxScore: 30 },
                    { name: 'ë…¸ë™ì¸ê¶Œ ë…ì„œë…¼ìˆ ', maxScore: 20 },
                    { name: 'ì„¸ê³„ì‹œë¯¼ í”„ë¡œì íŠ¸', maxScore: 30 },
                    { name: 'ì‚¬íšŒë°°ì›€ì¼ê¸°', maxScore: 20 }
                ],
                '1-ìˆ˜í•™': [
                    { name: 'ê¸°ë³¸ ë„í˜• íƒêµ¬í•˜ê¸°', maxScore: 30 },
                    { name: 'ìˆ˜í•™ë¬¸ì œí•´ê²° ê³¼ì •í‰ê°€', maxScore: 20 }
                ],
                '1-ê³¼í•™': [
                    { name: 'ì˜¨ë„ì™€ ì—´í‰í˜• íƒêµ¬í•˜ê¸°', maxScore: 20 },
                    { name: 'ê¸°ì²´ì˜ ì••ë ¥ê³¼ ë¶€í”¼ ê´€ê³„ íƒêµ¬í•˜ê¸°', maxScore: 20 },
                    { name: 'ê³¼í•™ë¬¸ì œí•´ê²°ê³¼ì •í‰ê°€', maxScore: 10 }
                ],
                '1-ê¸°ìˆ ê°€ì •': [
                    { name: 'ì²­ì†Œë…„ê¸° ì˜ì–‘í”„ë¡œì íŠ¸', maxScore: 40 },
                    { name: 'ì˜ì–‘ì†Œ íƒ€ì´í¬ê·¸ë˜í”¼', maxScore: 20 },
                    { name: 'ìƒí™œ ì† ë¬¸ì œí•´ê²° ë°œëª…í•˜ê¸°', maxScore: 40 }
                ],
                '1-ì²´ìœ¡': [
                    { name: 'í”Œë¼ì‰ë””ìŠ¤í¬', maxScore: 30 },
                    { name: 'ë°°ë“œë¯¼í„´', maxScore: 20 },
                    { name: 'ì²´ë ¥ ì¦ì§„', maxScore: 20 },
                    { name: 'íƒêµ¬', maxScore: 30 }
                ],
                '1-ìŒì•…': [
                    { name: 'ë¦¬ë“¬ ì‹œì°½ê³¼ ì„ ìœ¨ ì²­ìŒ', maxScore: 25 },
                    { name: 'ì»µíƒ€ ì—°ì£¼í•˜ê¸°', maxScore: 30 },
                    { name: 'ìŒì•… ê°ìƒë¬¸ ì‘ì„±í•˜ê¸°', maxScore: 30 },
                    { name: 'ìŒì•…í•™ìŠµ ê³¼ì •í‰ê°€', maxScore: 15 }
                ],
                '1-ë¯¸ìˆ ': [
                    { name: 'ì´ëª¨í‹°ì½˜ ë””ìì¸', maxScore: 30 },
                    { name: 'êµ¿ì¦ˆ ì œì‘', maxScore: 30 },
                    { name: 'í™•ì¥í˜• ë“œë¡œì‰', maxScore: 20 },
                    { name: 'ë¯¸ìˆ  ê°ìƒ', maxScore: 20 }
                ],
                '1-ì˜ì–´': [
                    { name: 'ë“£ê¸°', maxScore: 10 },
                    { name: 'ìƒí™©ì— ë”°ë¥¸ ë§í•˜ê¸°', maxScore: 20 },
                    { name: 'ì˜ë¯¸ì— ë§ê²Œ ì˜ì‘í•˜ê¸°', maxScore: 20 }
                ],
                '1-ì •ë³´': [
                    { name: 'í”„ë¡œê·¸ë˜ë°', maxScore: 25 },
                    { name: 'ì¸ê³µì§€ëŠ¥ ê¸°ëŠ¥ íƒêµ¬í•˜ê¸°', maxScore: 25 },
                    { name: 'ì¸ê³µì§€ëŠ¥ ë°ì´í„° í™œìš©ì˜ ìœ¤ë¦¬ì  ìŸì  ë‹¤ë£¨ê¸°', maxScore: 25 },
                    { name: 'í”¼ì§€ì»¬ ì»´í“¨íŒ… íƒêµ¬', maxScore: 25 }
                ],

                // 2í•™ë…„ ê³¼ëª©ë“¤
                '2-êµ­ì–´': [
                    { name: 'ì„œí‰ì“°ê¸°', maxScore: 20 },
                    { name: 'ì„¤ëª…í•˜ëŠ” ê¸€ì“°ê¸°', maxScore: 15 },
                    { name: 'êµ­ì–´ì—­ëŸ‰ê³¼ì •í‰ê°€', maxScore: 15 }
                ],
                '2-ë„ë•': [
                    { name: 'í™˜ê²½ë³´ê³ ì„œ ì‘ì„±í•˜ê¸°', maxScore: 20 },
                    { name: 'ì˜ë¯¸ìˆëŠ” ì‚¶ì„ ìœ„í•œ ì±… ì†Œê°œí•˜ê¸°', maxScore: 20 },
                    { name: 'ìƒê°ë‚˜ëˆ” í¬íŠ¸í´ë¦¬ì˜¤', maxScore: 10 }
                ],
                '2-ìˆ˜í•™': [
                    { name: 'ì‚¼ê°í˜•ì˜ ì„±ì§ˆ íƒêµ¬í•˜ê¸°', maxScore: 20 },
                    { name: 'ë„í˜•ì˜ ë‹®ìŒ í™œìš©í•˜ê¸°', maxScore: 20 },
                    { name: 'ìˆ˜í•™ë¬¸ì œí•´ê²° ê³¼ì •í‰ê°€', maxScore: 10 }
                ],
                '2-ê³¼í•™': [
                    { name: 'ê´‘í•©ì„±ì˜ ê³¼ì • íƒêµ¬í•˜ê¸° ì‹¤í—˜', maxScore: 20 },
                    { name: 'ì†Œí™”ì™€ ìˆœí™˜ì˜ ê³¼ì • ì´í•´í•˜ê¸°', maxScore: 30 }
                ],
                '2-ê¸°ìˆ ê°€ì •': [
                    { name: 'ì „ê¸°ìë™ì°¨ ë§Œë“¤ê¸°', maxScore: 30 },
                    { name: 'ìƒí™œ ì† ì‹ ì¬ì„±ì—ë„ˆì§€ íƒêµ¬í•˜ê¸°', maxScore: 20 },
                    { name: 'íƒ„ì†Œì¤‘ë¦½ ì–´ë„¤ì§€ ìë¦½ ì£¼íƒ ëª¨í˜• ë§Œë“¤ê¸°', maxScore: 30 },
                    { name: 'ìƒëª…ê¸°ìˆ ì˜ ê¸ì •ì ì¸ ì˜í–¥ê³¼ ë¶€ì •ì ì¸ ì˜í–¥ íƒìƒ‰í•˜ê¸°', maxScore: 20 }
                ],
                '2-ì²´ìœ¡': [
                    { name: 'ì œìë¦¬ ë©€ë¦¬ë›°ê¸°', maxScore: 20 },
                    { name: 'ë°°ë“œë¯¼í„´ ìŠ¤íŠ¸ë¡œí¬í•˜ê¸°', maxScore: 30 },
                    { name: 'í‹°ë³¼ ë˜ì§€ê¸°', maxScore: 30 },
                    { name: 'ë°°ë“œë¯¼í„´ ê²½ê¸°í•˜ê¸°', maxScore: 20 }
                ],
                '2-ë¯¸ìˆ ': [
                    { name: 'ì„œì–‘ë¯¸ìˆ  ì¬í•´ì„', maxScore: 20 },
                    { name: 'í„°ë„ë¶ ì œì‘', maxScore: 30 },
                    { name: 'ì¸ì„±ë¡œê³  ì•„ì´ë””ì–´ìŠ¤ì¼€ì¹˜', maxScore: 20 },
                    { name: 'ì¸ì„±ë¡œê³  íŒí™”ì œì‘', maxScore: 30 }
                ],
                '2-ì˜ì–´': [
                    { name: 'ë“£ê¸°', maxScore: 10 },
                    { name: 'ë§í•˜ê¸°', maxScore: 10 },
                    { name: 'ë°œëª…í’ˆ ì†Œê°œí•˜ê¸°', maxScore: 20 }
                ],
                '2-ì—­ì‚¬': [
                    { name: 'ê·¸ë¦¬ìŠ¤, ë¡œë§ˆ íŒœí”Œë › ì œì‘í•˜ê¸°', maxScore: 20 },
                    { name: 'ì‹ í•­ë¡œ ê°œì²™ì— ëŒ€í•œ ë…¼ìˆ í•˜ê¸°', maxScore: 15 },
                    { name: 'ì—­ì‚¬ ë°°ì›€ í¬íŠ¸í´ë¦¬ì˜¤ ì‘ì„±í•˜ê¸°', maxScore: 15 }
                ],
                '2-í•œë¬¸': [
                    { name: 'ê³ ì‚¬ì„±ì–´ ë°œí‘œí•˜ê¸°', maxScore: 10 },
                    { name: 'í•œì ì½ê¸°', maxScore: 10 },
                    { name: 'í˜¸ë„ì¥ ë§Œë“¤ê¸°', maxScore: 20 },
                    { name: 'í•œì ì“°ê¸°', maxScore: 10 }
                ],

                // 3í•™ë…„ ê³¼ëª©ë“¤
                '3-êµ­ì–´': [
                    { name: 'ìš°ë¦¬ë§ íƒêµ¬', maxScore: 20 },
                    { name: 'ì„œí‰ì“°ê¸°', maxScore: 20 },
                    { name: 'êµ­ì–´ì—­ëŸ‰ê³¼ì •í‰ê°€', maxScore: 10 }
                ],
                '3-ì‚¬íšŒ': [
                    { name: 'ì¸êµ¬ íŠ¹ì§•ê³¼ ì¸êµ¬ ë¬¸ì œ í¬íŠ¸í´ë¦¬ì˜¤ ì‘ì„±', maxScore: 30 },
                    { name: 'ì„¸ê³„ ë„ì‹œì™€ ë„ì‹œí™” ë¬¸ì œ í¬íŠ¸í´ë¦¬ì˜¤ ì‘ì„±', maxScore: 30 }
                ],
                '3-ìˆ˜í•™': [
                    { name: 'ì‚¼ê°ë¹„ í™œìš©í•˜ê¸°', maxScore: 20 },
                    { name: 'ì›ì£¼ê° íƒêµ¬í•˜ê¸°', maxScore: 20 },
                    { name: 'ìˆ˜í•™ë¬¸ì œí•´ê²° ê³¼ì •í‰ê°€', maxScore: 10 }
                ],
                '3-ê³¼í•™': [
                    { name: 'ì²´ì„¸í¬ë¶„ì—´ê³¼ ê°ìˆ˜ë¶„ì—´ ê³¼ì • ë¶„ì„í•˜ê¸°', maxScore: 30 },
                    { name: 'ë©˜ë¸ì˜ ìœ ì „ ì›ë¦¬ ì´í•´í•˜ê¸°', maxScore: 20 }
                ],
                '3-ê¸°ìˆ ê°€ì •': [
                    { name: 'ì£¼ìƒí™œ í”„ë¡œì íŠ¸', maxScore: 15 },
                    { name: 'í™ˆì¦ˆ êµ¬í•´ë³´ê¸°', maxScore: 40 },
                    { name: 'ì‰ì–´í•˜ìš°ìŠ¤ ë””ìì¸í•˜ê¸°', maxScore: 25 },
                    { name: 'ì£¼ê±°íŠ¸ë Œë“œ ì‹ ë¬¸ ë§Œë“¤ê¸°', maxScore: 20 }
                ],
                '3-ì²´ìœ¡': [
                    { name: 'íƒêµ¬ ì„œë¸Œ', maxScore: 30 },
                    { name: 'ì¤„ë„˜ê¸°', maxScore: 20 },
                    { name: 'íƒêµ¬ í¬í•¸ë“œ ìŠ¤íŠ¸ë¡œí¬', maxScore: 30 },
                    { name: 'ì•ˆì „í™œë™', maxScore: 20 }
                ],
                '3-ìŒì•…': [
                    { name: 'ì¥êµ¬ ì—°ì£¼í•˜ê¸°', maxScore: 30 },
                    { name: 'íŒì†Œë¦¬ ë¶€ë¥´ê¸°', maxScore: 30 },
                    { name: 'ë‹¤ì–‘í•œ ì¥ë¥´ì˜ êµ­ì•… ê°ìƒí•˜ê¸°', maxScore: 25 },
                    { name: 'ìŒì•…í•™ìŠµ ê³¼ì •í‰ê°€', maxScore: 15 }
                ],
                '3-ì˜ì–´': [
                    { name: 'ë“£ê¸°', maxScore: 10 },
                    { name: 'ì£¼ì œ ê¸€ì“°ê¸°', maxScore: 20 },
                    { name: 'ë§í•˜ê¸°', maxScore: 20 }
                ],
                '3-ì—­ì‚¬': [
                    { name: 'ì—­ì‚¬ ë…ì„œ ì¼ì§€ ì“°ê¸°', maxScore: 20 },
                    { name: 'ì—­ì‚¬ ì„œí‰ ì“°ê¸°', maxScore: 20 },
                    { name: 'ê¸°ë¡ë¬¸í™”ì²´í—˜', maxScore: 10 }
                ],
                '3-ìƒí™œì¼ë³¸ì–´': [
                    { name: 'ì¼ë³¸ì–´ ì‘ë¬¸í•˜ê¸°', maxScore: 40 },
                    { name: 'ì¼ë³¸ì–´ë¡œ ë§í•˜ê¸°', maxScore: 20 },
                    { name: 'í•œì¼ë¬¸í™” ë¹„êµíƒêµ¬', maxScore: 20 },
                    { name: 'ì¼ë³¸ì–´ í™œìš© í¬íŠ¸í´ë¦¬ì˜¤', maxScore: 20 }
                ],
                '3-ìƒí™œì¤‘êµ­ì–´': [
                    { name: 'ë‚˜ì˜ í•˜ë£¨ ë””ìì¸í•˜ê¸°', maxScore: 30 },
                    { name: 'ì¤‘êµ­ì–´ë¡œ ë§Œë‚˜ëŠ” ë‚˜ ìŠ¤í† ë¦¬í…”ë§', maxScore: 30 },
                    { name: 'ì˜ì‚¬ì†Œí†µê¸°ë³¸í‘œí˜„ ë§í•˜ê¸°', maxScore: 30 },
                    { name: 'í•™ìŠµí™œë™í‰ê°€', maxScore: 10 }
                ]
            };


        // ê³¼ëª© ì¶”ê°€
        function addSubject() {
            const gradeSelect = document.getElementById('subjectGrade');
            const nameInput = document.getElementById('subjectName');

            const grade = gradeSelect.value;
            const name = nameInput.value.trim();

            if (!name) {
                alert('ê³¼ëª©ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const subjectKey = `${grade}-${name}`;

            if (subjects[subjectKey]) {
                alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê³¼ëª©ì…ë‹ˆë‹¤.');
                return;
            }

            // í‰ê°€ê³„íšì—ì„œ í•´ë‹¹ ê³¼ëª© ê²€ìƒ‰
            const foundPlan = evaluationPlan[subjectKey];

            if (foundPlan) {
                // í‰ê°€ê³„íšì— ìˆëŠ” ê³¼ëª©ì´ë©´ ìë™ ì¶”ê°€ ëª¨ë‹¬ ë„ìš°ê¸°
                pendingSubject = {
                    key: subjectKey,
                    grade: parseInt(grade),
                    name: name,
                    planAreas: foundPlan
                };
                openAutoAreaModal();
            } else {
                // í‰ê°€ê³„íšì— ì—†ëŠ” ê³¼ëª©ì´ë©´ ë°”ë¡œ ì¶”ê°€
                subjects[subjectKey] = {
                    grade: parseInt(grade),
                    name: name,
                    areas: []
                };
                scores[subjectKey] = {};
                nameInput.value = '';

                updateSubjectList();
                updateSubjectSelectors();
                saveSubjects();
            }
        }

        // ìë™ ì˜ì—­ ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°
        function openAutoAreaModal() {
            if (!pendingSubject || !pendingSubject.planAreas) {
                console.error('pendingSubjectê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤:', pendingSubject);
                return;
            }

            const info = document.getElementById('autoAreaInfo');
            const subject = pendingSubject;

            const areasText = subject.planAreas.map(area => `â€¢ ${area.name} (${area.maxScore}ì )`).join('<br>');
            const totalScore = subject.planAreas.reduce((sum, area) => sum + area.maxScore, 0);

            info.innerHTML = `
                <div style="background-color: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                    <h5 style="margin: 0 0 10px 0; color: #007bff;">${subject.grade}í•™ë…„ ${subject.name}</h5>
                    <p style="margin: 0 0 15px 0; color: #666;">2025í•™ë…„ë„ í‰ê°€ê³„íšì—ì„œ ë‹¤ìŒ ìˆ˜í–‰ì˜ì—­ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤:</p>
                    <div style="margin-bottom: 15px; line-height: 1.6;">
                        ${areasText}
                    </div>
                    <div style="font-weight: bold; color: #28a745;">
                        ì´ ${totalScore}ì  (${subject.planAreas.length}ê°œ ì˜ì—­)
                    </div>
                </div>
                <p style="color: #666; margin: 0;">ìë™ìœ¼ë¡œ ìˆ˜í–‰ì˜ì—­ì„ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            `;

            // ëª¨ë‹¬ ë²„íŠ¼ì— ë°ì´í„° ì €ì¥
            const confirmBtn = document.getElementById('confirmAutoBtn');
            const addWithoutBtn = document.getElementById('addWithoutAreasBtn');

            confirmBtn.setAttribute('data-subject', JSON.stringify(pendingSubject));
            addWithoutBtn.setAttribute('data-subject', JSON.stringify(pendingSubject));

            document.getElementById('autoAreaModal').style.display = 'block';

            // ë””ë²„ê¹…ì„ ìœ„í•œ ë¡œê·¸
            console.log('ìë™ ì˜ì—­ ëª¨ë‹¬ ì—´ë¦¼:', pendingSubject);
        }

        // ìë™ ì˜ì—­ ì¶”ê°€ í™•ì¸
        function confirmAutoAreaAddition() {
            try {
                // ë²„íŠ¼ì—ì„œ ì €ì¥ëœ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const confirmBtn = document.getElementById('confirmAutoBtn');
                const subjectData = JSON.parse(confirmBtn.getAttribute('data-subject'));

                if (!subjectData || !subjectData.grade || !subjectData.name) {
                    console.error('ì €ì¥ëœ ê³¼ëª© ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤:', subjectData);
                    closeAutoAreaModal();
                    return;
                }

                const subjectKey = subjectData.key;
                subjects[subjectKey] = {
                    grade: subjectData.grade,
                    name: subjectData.name,
                    areas: [...subjectData.planAreas]
                };
                scores[subjectKey] = {};

                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                document.getElementById('subjectName').value = '';

                updateSubjectList();
                updateSubjectSelectors();
                saveSubjects();

                const alertMessage = `${subjectData.grade}í•™ë…„ ${subjectData.name} ê³¼ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.\n${subjectData.planAreas.length}ê°œì˜ ìˆ˜í–‰ì˜ì—­ì´ ìë™ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`;

                closeAutoAreaModal();
                alert(alertMessage);
            } catch (error) {
                console.error('ìë™ ì˜ì—­ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜:', error);
                closeAutoAreaModal();
            }
        }

        // ì˜ì—­ ì—†ì´ ê³¼ëª©ë§Œ ì¶”ê°€
        function addSubjectWithoutAreas() {
            try {
                // ë²„íŠ¼ì—ì„œ ì €ì¥ëœ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const addWithoutBtn = document.getElementById('addWithoutAreasBtn');
                const subjectData = JSON.parse(addWithoutBtn.getAttribute('data-subject'));

                if (!subjectData || !subjectData.grade || !subjectData.name) {
                    console.error('ì €ì¥ëœ ê³¼ëª© ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤:', subjectData);
                    closeAutoAreaModal();
                    return;
                }

                const subjectKey = subjectData.key;
                subjects[subjectKey] = {
                    grade: subjectData.grade,
                    name: subjectData.name,
                    areas: []
                };
                scores[subjectKey] = {};

                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                document.getElementById('subjectName').value = '';

                updateSubjectList();
                updateSubjectSelectors();
                saveSubjects();

                closeAutoAreaModal();
            } catch (error) {
                console.error('ê³¼ëª© ì¶”ê°€ ì¤‘ ì˜¤ë¥˜:', error);
                closeAutoAreaModal();
            }
        }

        // ìë™ ì˜ì—­ ëª¨ë‹¬ ë‹«ê¸°
        function closeAutoAreaModal() {
            document.getElementById('autoAreaModal').style.display = 'none';
            pendingSubject = null;
        }

        // ê³¼ëª© ëª©ë¡ ì—…ë°ì´íŠ¸ (í•™ë…„ë³„ë¡œ ê°€ë¡œ 3ë“±ë¶„í•˜ì—¬ í‘œì‹œ)
        function updateSubjectList() {
            const container = document.getElementById('subjectList');
            container.innerHTML = '';

            // í•™ë…„ë³„ë¡œ ê·¸ë£¹í•‘í•´ì„œ ì •ë ¬
            const groupedSubjects = {};
            Object.keys(subjects).forEach(subjectKey => {
                const subject = subjects[subjectKey];
                if (!groupedSubjects[subject.grade]) {
                    groupedSubjects[subject.grade] = [];
                }
                groupedSubjects[subject.grade].push({key: subjectKey, data: subject});
            });

            // ê°€ë¡œ 3ë“±ë¶„ ë ˆì´ì•„ì›ƒìœ¼ë¡œ í•™ë…„ë³„ í‘œì‹œ
            const gradeRow = document.createElement('div');
            gradeRow.className = 'grade-row';

            [3, 2, 1].forEach(grade => {
                const gradeColumn = document.createElement('div');
                gradeColumn.className = `grade-column grade-${grade}`;

                const gradeTitle = document.createElement('h5');
                gradeTitle.innerHTML = `${grade}í•™ë…„ (${groupedSubjects[grade] ? groupedSubjects[grade].length : 0}ê°œ ê³¼ëª©)`;
                gradeColumn.appendChild(gradeTitle);

                const subjectContainer = document.createElement('div');

                if (groupedSubjects[grade] && groupedSubjects[grade].length > 0) {
                    groupedSubjects[grade].forEach(({key, data}) => {
                        const subjectItem = document.createElement('div');
                        subjectItem.className = 'subject-item';
                        subjectItem.setAttribute('data-subject-key', key);
                        subjectItem.innerHTML = `
                            <span onclick="selectSubjectForArea('${key}')" style="flex: 1;">${data.name} (${data.areas.length}ê°œ ì˜ì—­)</span>
                            <span class="delete-btn" onclick="event.stopPropagation(); removeSubject('${key}')" title="ê³¼ëª© ì‚­ì œ">Ã—</span>
                        `;
                        subjectItem.style.display = 'flex';
                        subjectItem.style.alignItems = 'center';
                        subjectItem.style.justifyContent = 'space-between';
                        subjectContainer.appendChild(subjectItem);
                    });
                } else {
                    const emptyMsg = document.createElement('p');
                    emptyMsg.style.color = '#999';
                    emptyMsg.style.fontSize = '12px';
                    emptyMsg.style.textAlign = 'center';
                    emptyMsg.style.margin = '10px 0';
                    emptyMsg.textContent = 'ë“±ë¡ëœ ê³¼ëª© ì—†ìŒ';
                    subjectContainer.appendChild(emptyMsg);
                }

                gradeColumn.appendChild(subjectContainer);
                gradeRow.appendChild(gradeColumn);
            });

            container.appendChild(gradeRow);
        }

        // ê³¼ëª© ì‚­ì œ
        function removeSubject(subjectKey) {
            const subject = subjects[subjectKey];
            const displayName = `${subject.grade}í•™ë…„-${subject.name}`;

            if (!confirm(`${displayName} ê³¼ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ê´€ë ¨ ì ìˆ˜ë„ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤)`)) return;

            delete subjects[subjectKey];
            delete scores[subjectKey];

            updateSubjectList();
            updateSubjectSelectors();
            saveSubjects();
            saveScores();

            // í˜„ì¬ ì„ íƒëœ ê³¼ëª©ì´ ì‚­ì œëœ ê²½ìš° ì´ˆê¸°í™”
            if (currentSubject === subjectKey) {
                resetAreaManagement();
            }
        }

        // ê³¼ëª© ì„ íƒì ì—…ë°ì´íŠ¸ (ì ìˆ˜ê´€ë¦¬ìš© ê³¼ëª© ëª©ë¡ í‘œì‹œ)
        function updateSubjectSelectors() {
            updateScoreSubjectList();
            updateTemplateButton();
        }

        // ì ìˆ˜ê´€ë¦¬ìš© ê³¼ëª© ëª©ë¡ ì—…ë°ì´íŠ¸ (í•™ë…„ë³„ë¡œ ê°€ë¡œ 3ë“±ë¶„í•˜ì—¬ í‘œì‹œ)
        function updateScoreSubjectList() {
            const container = document.getElementById('scoreSubjectList');
            container.innerHTML = '';

            // í•™ë…„ë³„ë¡œ ê·¸ë£¹í•‘í•´ì„œ ì •ë ¬
            const groupedSubjects = {};
            Object.keys(subjects).forEach(subjectKey => {
                const subject = subjects[subjectKey];
                if (!groupedSubjects[subject.grade]) {
                    groupedSubjects[subject.grade] = [];
                }
                groupedSubjects[subject.grade].push({key: subjectKey, data: subject});
            });

            // ê°€ë¡œ 3ë“±ë¶„ ë ˆì´ì•„ì›ƒìœ¼ë¡œ í•™ë…„ë³„ í‘œì‹œ
            const gradeRow = document.createElement('div');
            gradeRow.className = 'grade-row';

            [3, 2, 1].forEach(grade => {
                const gradeColumn = document.createElement('div');
                gradeColumn.className = `grade-column grade-${grade}`;

                const gradeTitle = document.createElement('h5');
                gradeTitle.innerHTML = `${grade}í•™ë…„ (${groupedSubjects[grade] ? groupedSubjects[grade].length : 0}ê°œ ê³¼ëª©)`;
                gradeColumn.appendChild(gradeTitle);

                const subjectContainer = document.createElement('div');

                if (groupedSubjects[grade] && groupedSubjects[grade].length > 0) {
                    groupedSubjects[grade].forEach(({key, data}) => {
                        const subjectItem = document.createElement('div');
                        subjectItem.className = 'score-subject-item';
                        subjectItem.setAttribute('data-subject-key', key);
                        subjectItem.innerHTML = `${data.name} (${data.areas.length}ê°œ ì˜ì—­)`;
                        subjectItem.onclick = () => selectSubjectForScore(key);
                        subjectContainer.appendChild(subjectItem);
                    });
                } else {
                    const emptyMsg = document.createElement('p');
                    emptyMsg.style.color = '#999';
                    emptyMsg.style.fontSize = '12px';
                    emptyMsg.style.textAlign = 'center';
                    emptyMsg.style.margin = '10px 0';
                    emptyMsg.textContent = 'ë“±ë¡ëœ ê³¼ëª© ì—†ìŒ';
                    subjectContainer.appendChild(emptyMsg);
                }

                gradeColumn.appendChild(subjectContainer);
                gradeRow.appendChild(gradeColumn);
            });

            container.appendChild(gradeRow);
        }

        // ì ìˆ˜ê´€ë¦¬ìš© ê³¼ëª©ì„ í´ë¦­í•˜ì—¬ ì ìˆ˜ ê´€ë¦¬ ì¸í„°í˜ì´ìŠ¤ë¡œ ì´ë™
        function selectSubjectForScore(subjectKey) {
            // ëª¨ë“  ì ìˆ˜ê´€ë¦¬ìš© ê³¼ëª© ì•„ì´í…œì—ì„œ selected í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll('.score-subject-item').forEach(item => {
                item.classList.remove('selected');
            });

            // í´ë¦­ëœ ê³¼ëª©ì— selected í´ë˜ìŠ¤ ì¶”ê°€
            const clickedItem = document.querySelector(`#scoreSubjectList [data-subject-key="${subjectKey}"]`);
            if (clickedItem) {
                clickedItem.classList.add('selected');
            }

            // í˜„ì¬ ì„ íƒëœ ì ìˆ˜ê´€ë¦¬ ê³¼ëª© ì„¤ì •
            currentScoreSubject = subjectKey;

            // ì ìˆ˜ ê´€ë¦¬ ì¸í„°í˜ì´ìŠ¤ ì—…ë°ì´íŠ¸
            updateScoreInterface();

            // ì ìˆ˜ ì—…ë¡œë“œ ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            document.getElementById('scoreUploadSection').scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }

        // ê³¼ëª©ì„ í´ë¦­í•˜ì—¬ ìˆ˜í–‰ì˜ì—­ ì„¤ì •ìœ¼ë¡œ ë°”ë¡œ ì´ë™
        function selectSubjectForArea(subjectKey) {
            // ëª¨ë“  ê³¼ëª© ì•„ì´í…œì—ì„œ selected í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll('.subject-item').forEach(item => {
                item.classList.remove('selected');
            });

            // í´ë¦­ëœ ê³¼ëª©ì— selected í´ë˜ìŠ¤ ì¶”ê°€
            const clickedItem = document.querySelector(`[data-subject-key="${subjectKey}"]`);
            if (clickedItem) {
                clickedItem.classList.add('selected');
            }

            // í˜„ì¬ ì„ íƒëœ ê³¼ëª© ì„¤ì •
            currentSubject = subjectKey;

            // ìˆ˜í–‰ì˜ì—­ ì„¤ì • ì˜ì—­ í™œì„±í™”
            document.getElementById('areaManagement').style.display = 'block';

            // í•´ë‹¹ ê³¼ëª©ì˜ ì˜ì—­ ë¡œë“œ
            updateCurrentSubjectAreas();

            // ìˆ˜í–‰ì˜ì—­ ì„¤ì • ë¶€ë¶„ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            document.getElementById('areaManagement').scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }

        // ê³¼ëª© ì‚­ì œ ì‹œ ìˆ˜í–‰ì˜ì—­ ì„¤ì • ì´ˆê¸°í™”
        function resetAreaManagement() {
            document.getElementById('areaManagement').style.display = 'none';
            currentSubject = '';

            // ëª¨ë“  ê³¼ëª© ì•„ì´í…œì—ì„œ selected í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll('.subject-item').forEach(item => {
                item.classList.remove('selected');
            });
        }

        // í˜„ì¬ ê³¼ëª©ì˜ ì˜ì—­ ì—…ë°ì´íŠ¸
        function updateCurrentSubjectAreas() {
            const container = document.getElementById('currentSubjectAreas');

            if (!currentSubject || !subjects[currentSubject]) {
                container.innerHTML = '';
                return;
            }

            const subject = subjects[currentSubject];
            const areas = subject.areas;

            if (areas.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center;">ë“±ë¡ëœ ìˆ˜í–‰ì˜ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const displayName = `${subject.grade}í•™ë…„-${subject.name}`;
            let html = `<h5>${displayName} ìˆ˜í–‰ì˜ì—­ ëª©ë¡</h5><div class="list-container">`;

            areas.forEach((area, index) => {
                html += `
                    <div class="area-tag tag">
                        <span>${area.name} (${area.maxScore}ì )</span>
                        <button class="remove-btn" onclick="removeArea(${index})">Ã—</button>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;

            updateTemplateButton();
        }

        // ìˆ˜í–‰ì˜ì—­ ì¶”ê°€
        function addArea() {
            if (!currentSubject) {
                alert('ë¨¼ì € ê³¼ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const nameInput = document.getElementById('areaName');
            const scoreInput = document.getElementById('areaMaxScore');

            const name = nameInput.value.trim();
            const maxScore = parseInt(scoreInput.value);

            if (!name) {
                alert('ì˜ì—­ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!maxScore || maxScore <= 0) {
                alert('ì˜¬ë°”ë¥¸ ë§Œì ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ê°™ì€ ê³¼ëª© ë‚´ì—ì„œ ì¤‘ë³µ ì˜ì—­ëª… ì²´í¬
            if (subjects[currentSubject].areas.some(area => area.name === name)) {
                alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì˜ì—­ëª…ì…ë‹ˆë‹¤.');
                return;
            }

            subjects[currentSubject].areas.push({ name, maxScore });
            nameInput.value = '';
            scoreInput.value = '';

            updateCurrentSubjectAreas();
            saveSubjects();
        }

        // ì˜ì—­ ì‚­ì œ
        function removeArea(index) {
            if (!currentSubject) return;

            const area = subjects[currentSubject].areas[index];
            if (!confirm(`${area.name} ì˜ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            subjects[currentSubject].areas.splice(index, 1);

            // í•´ë‹¹ ì˜ì—­ì˜ ëª¨ë“  ì ìˆ˜ ì‚­ì œ
            Object.keys(scores[currentSubject] || {}).forEach(studentNum => {
                delete scores[currentSubject][studentNum][area.name];
            });

            updateCurrentSubjectAreas();
            saveSubjects();
            saveScores();
        }

        // ëª¨ë“  ê³¼ëª© ì‚­ì œ
        function clearAllSubjects() {
            if (!confirm('ëª¨ë“  ê³¼ëª©ê³¼ ì ìˆ˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            subjects = {};
            scores = {};
            currentSubject = '';
            currentScoreSubject = '';

            updateSubjectList();
            updateSubjectSelectors();
            document.getElementById('areaManagement').style.display = 'none';
            document.getElementById('scoreUploadSection').style.display = 'none';

            saveSubjects();
            saveScores();
        }

        // ===== ì ìˆ˜ ê´€ë¦¬ =====

        // ì ìˆ˜ ê´€ë¦¬ ì¸í„°í˜ì´ìŠ¤ ì—…ë°ì´íŠ¸
        function updateScoreInterface() {
            const uploadSection = document.getElementById('scoreUploadSection');

            if (!currentScoreSubject) {
                uploadSection.style.display = 'none';
                return;
            }
            uploadSection.style.display = 'block';

            // í˜„ì¬ ê³¼ëª©ì˜ ë“±ë¡ ìƒíƒœ í‘œì‹œ
            updatePublishStatus();
            generateScoreTable();
        }

        // ë“±ë¡ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updatePublishStatus() {
            // ì ìˆ˜í‘œê°€ ìƒì„±ë  ë•Œ ì²´í¬ë°•ìŠ¤ ìƒíƒœê°€ ìë™ìœ¼ë¡œ ì„¤ì •ë¨
            // ë” ì´ìƒ ë³„ë„ UI ì—…ë°ì´íŠ¸ ë¶ˆí•„ìš”
        }

        // ë“±ë¡ ìƒíƒœ í† ê¸€
        function togglePublishStatus() {
            if (!currentScoreSubject) return;

            const checkbox = document.getElementById('publishCheckbox');
            publishedSubjects[currentScoreSubject] = checkbox.checked;

            updatePublishStatus();
            savePublishedSubjects();

            const subject = subjects[currentScoreSubject];
            const displayName = `${subject.grade}í•™ë…„-${subject.name}`;

            if (checkbox.checked) {
                alert(`âœ… ${displayName}\ní•™ìƒë“¤ì´ ì´ ê³¼ëª©ì˜ ì ìˆ˜ë¥¼ ì¡°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
            } else {
                alert(`â›” ${displayName}\ní•™ìƒë“¤ì´ ì´ ê³¼ëª©ì˜ ì ìˆ˜ë¥¼ ì¡°íšŒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
            }
        }

        // í…œí”Œë¦¿ ìƒì„±
        function generateTemplate() {
            const selectedSubjectKey = currentSubject;

            if (!selectedSubjectKey) {
                alert('ë¨¼ì € ê³¼ëª©ì„ í´ë¦­í•˜ì—¬ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!subjects[selectedSubjectKey] || subjects[selectedSubjectKey].areas.length === 0) {
                alert('ë¨¼ì € ìˆ˜í–‰ì˜ì—­ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (Object.keys(students).length === 0) {
                alert('ë¨¼ì € í•™ìƒì„ ë“±ë¡í•´ì£¼ì„¸ìš”.');
                return;
            }

            const wb = XLSX.utils.book_new();
            const subject = subjects[selectedSubjectKey];
            const areas = subject.areas;

            // í—¤ë” ìƒì„±
            const headers = ['í•™ë²ˆ', 'ì´ë¦„'];
            areas.forEach(area => {
                headers.push(`${area.name}(${area.maxScore})`);
            });

            // ë°ì´í„° ë°°ì—´ ìƒì„±
            const data = [headers];

            // í•™ë²ˆ ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ í•™ìƒ ë°ì´í„° ì¶”ê°€
            const sortedNumbers = Object.keys(students).sort();
            sortedNumbers.forEach(num => {
                const row = [num, students[num].name];
                areas.forEach(() => row.push('')); // ë¹ˆ ì ìˆ˜ ì¹¸
                data.push(row);
            });

            const ws = XLSX.utils.aoa_to_sheet(data);

            // ì—´ ë„ˆë¹„ ì„¤ì •
            const colWidths = [
                { wch: 8 },  // í•™ë²ˆ
                { wch: 12 }, // ì´ë¦„
                ...areas.map(() => ({ wch: 15 }))
            ];
            ws['!cols'] = colWidths;

            const sheetName = `${subject.grade}í•™ë…„_${subject.name}`;
            XLSX.utils.book_append_sheet(wb, ws, sheetName);

            const today = new Date().toISOString().split('T')[0];
            const fileName = `${subject.grade}í•™ë…„_${subject.name}_ìˆ˜í–‰í‰ê°€_${today}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        // í…œí”Œë¦¿ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateTemplateButton() {
            const templateBtn = document.getElementById('templateBtn');
            const hasSubjectsWithAreas = Object.values(subjects).some(subject => subject.areas.length > 0);
            const hasStudents = Object.keys(students).length > 0;

            templateBtn.disabled = !hasSubjectsWithAreas || !hasStudents;
        }

        // ì ìˆ˜í‘œ ìƒì„±
        function generateScoreTable() {
            const container = document.getElementById('scoreTableContainer');

            if (!currentScoreSubject || !subjects[currentScoreSubject] || subjects[currentScoreSubject].areas.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">ìˆ˜í–‰ì˜ì—­ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.</p>';
                return;
            }

            if (Object.keys(students).length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">í•™ìƒì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.</p>';
                return;
            }

            const subject = subjects[currentScoreSubject];
            const areas = subject.areas;
            const subjectScores = scores[currentScoreSubject] || {};
            const displayName = `${subject.grade}í•™ë…„-${subject.name}`;
            // ê¸°ë³¸ê°’ì„ í—ˆìš©ìœ¼ë¡œ ì„¤ì •, ëª…ì‹œì ìœ¼ë¡œ falseì¸ ê²½ìš°ë§Œ ë¹„í—ˆìš©
            const isPublished = publishedSubjects[currentScoreSubject] !== false;

            let tableHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="margin: 0;">ğŸ“Š ${displayName} ì ìˆ˜í‘œ</h4>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px;">
                        <input type="checkbox" id="publishCheckbox" onchange="togglePublishStatus()"
                               ${isPublished ? 'checked' : ''}
                               title="í•™ìƒ ì¡°íšŒ í—ˆìš© ì—¬ë¶€ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤"
                               aria-label="í•™ìƒ ì ìˆ˜ ì¡°íšŒ í—ˆìš© ì„¤ì •">
                        <span style="color: ${isPublished ? '#28a745' : '#6c757d'};">
                            ${displayName} - í•™ìƒ ì¡°íšŒ ${isPublished ? 'í—ˆìš© âœ“' : 'ë¹„í—ˆìš©'}
                        </span>
                    </label>
                </div>
                <table class="score-table">
                    <thead>
                        <tr>
                            <th>í•™ë²ˆ</th>
                            <th>ì´ë¦„</th>
                            ${areas.map(area => `<th>${area.name}<br>(${area.maxScore}ì )</th>`).join('')}
                            <th>ì´ì </th>
                            <th>í™•ì¸ì—¬ë¶€</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            const sortedNumbers = Object.keys(students).sort();
            sortedNumbers.forEach(num => {
                const student = students[num];
                const studentScores = subjectScores[num] || {};
                let total = 0;

                // í•™ìƒì˜ í™•ì¸ ì—¬ë¶€ ì²´í¬ (ì˜ì—­ë³„)
                const subject = subjects[currentScoreSubject];
                let checkedAreas = 0;
                let totalAreas = subject.areas.length;
                let hasQuestions = false;

                if (studentChecked[currentScoreSubject] && studentChecked[currentScoreSubject][num]) {
                    subject.areas.forEach(area => {
                        if (studentChecked[currentScoreSubject][num][area.name]) {
                            checkedAreas++;
                        }
                    });
                }

                if (studentQuestions[currentScoreSubject] && studentQuestions[currentScoreSubject][num]) {
                    hasQuestions = Object.keys(studentQuestions[currentScoreSubject][num]).length > 0;
                }

                let checkStatus = '';
                let checkColor = '';

                if (hasQuestions) {
                    checkStatus = `â“ ì˜ë¬¸(${checkedAreas}/${totalAreas})`;
                    checkColor = '#dc3545';
                } else if (checkedAreas === totalAreas) {
                    checkStatus = `âœ… ì™„ë£Œ(${checkedAreas}/${totalAreas})`;
                    checkColor = '#28a745';
                } else {
                    checkStatus = `â³ ì§„í–‰ì¤‘(${checkedAreas}/${totalAreas})`;
                    checkColor = '#ffc107';
                }

                tableHTML += `<tr><td>${num}</td><td>${student.name}</td>`;

                areas.forEach(area => {
                    const score = studentScores[area.name] || 0;
                    total += score;
                    tableHTML += `<td>${score}</td>`;
                });

                const questionButton = hasQuestions ? ` <button onclick="showStudentQuestions('${num}')" style="background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;">í™•ì¸</button>` : '';

                tableHTML += `<td><strong>${total}</strong></td><td style="color: ${checkColor}; font-weight: bold;">${checkStatus}${questionButton}</td></tr>`;
            });

            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        // í•™ìƒ ì˜ë¬¸ì‚¬í•­ í™•ì¸
        function showStudentQuestions(studentNumber) {
            if (!currentScoreSubject || !studentQuestions[currentScoreSubject] || !studentQuestions[currentScoreSubject][studentNumber]) {
                alert('ì˜ë¬¸ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const student = students[studentNumber];
            const subject = subjects[currentScoreSubject];
            const questions = studentQuestions[currentScoreSubject][studentNumber];

            let message = `ğŸ“‹ ${student.name} (${studentNumber}) - ${subject.grade}í•™ë…„ ${subject.name}\n\n`;
            message += 'ğŸ“ ì˜ë¬¸ì‚¬í•­:\n\n';

            Object.keys(questions).forEach(areaName => {
                message += `ğŸ”¸ ${areaName}:\n`;
                message += `   "${questions[areaName]}"\n\n`;
            });

            message += 'ì˜ë¬¸ì‚¬í•­ì„ í•´ê²°í•˜ì…¨ë‹¤ë©´ í•™ìƒì—ê²Œ ì§ì ‘ ì„¤ëª…í•´ì£¼ì„¸ìš”.';

            if (confirm(message + '\n\nì´ ì˜ë¬¸ì‚¬í•­ë“¤ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                delete studentQuestions[currentScoreSubject][studentNumber];
                saveStudentQuestions();
                generateScoreTable(); // í…Œì´ë¸” ìƒˆë¡œê³ ì¹¨
                alert('ì˜ë¬¸ì‚¬í•­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ===== íŒŒì¼ ì²˜ë¦¬ =====

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„¤ì •
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            });
        }

        // í•™ìƒ ëª…ë‹¨ ì—…ë¡œë“œ ì²˜ë¦¬
        function uploadStudentFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});

                    parseStudentData(jsonData);
                } catch (error) {
                    alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // ì ìˆ˜ íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
        function uploadFile(event) {
            const file = event.target.files[0];
            if (file) {
                handleFileUpload(file);
            }
        }

        function handleFileUpload(file) {
            if (!currentScoreSubject) {
                alert('ë¨¼ì € ê³¼ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!subjects[currentScoreSubject] || subjects[currentScoreSubject].areas.length === 0) {
                alert('ë¨¼ì € ìˆ˜í–‰ì˜ì—­ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (Object.keys(students).length === 0) {
                alert('ë¨¼ì € í•™ìƒì„ ë“±ë¡í•´ì£¼ì„¸ìš”.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});

                    parseUploadedScoreData(jsonData);
                } catch (error) {
                    alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // í•™ìƒ ë°ì´í„° íŒŒì‹±
        function parseStudentData(data) {
            let addedCount = 0;
            let skippedCount = 0;
            let errorCount = 0;

            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                if (row.length >= 2) {
                    const studentNumber = String(row[0]).trim();
                    const name = String(row[1]).trim();

                    if (studentNumber && name) {
                        const parsed = parseStudentNumber(studentNumber);
                        if (parsed) {
                            if (!students[studentNumber]) {
                                students[studentNumber] = {
                                    name: name,
                                    grade: parsed.grade,
                                    class: parsed.class,
                                    number: parsed.number,
                                    password: generateDefaultPassword(studentNumber) // ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸ ìƒì„±
                                };
                                addedCount++;
                            } else {
                                skippedCount++;
                            }
                        } else {
                            errorCount++;
                        }
                    }
                }
            }

            updateStats();
            updateMatrix();
            updateTemplateButton();
            saveStudents();

            let message = `í•™ìƒ ${addedCount}ëª…ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`;
            if (skippedCount > 0) message += `\nì¤‘ë³µëœ í•™ë²ˆ ${skippedCount}ëª…ì€ ê±´ë„ˆë›°ì—ˆìŠµë‹ˆë‹¤.`;
            if (errorCount > 0) message += `\nì˜ëª»ëœ í•™ë²ˆ í˜•ì‹ ${errorCount}ëª…ì€ ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤.`;

            alert(message);
        }

        // ì ìˆ˜ ë°ì´í„° íŒŒì‹±
        function parseUploadedScoreData(data) {
            if (data.length < 2) {
                alert('ì˜¬ë°”ë¥¸ í˜•ì‹ì˜ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.');
                return;
            }

            const headers = data[0];
            const areas = subjects[currentScoreSubject].areas;

            if (!scores[currentScoreSubject]) {
                scores[currentScoreSubject] = {};
            }

            let errorMessages = [];

            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                const studentNum = String(row[0]).trim();
                const studentName = String(row[1]).trim();

                if (studentNum && students[studentNum]) {
                    // ì´ë¦„ ê²€ì¦
                    if (students[studentNum].name !== studentName) {
                        errorMessages.push(`${studentNum}ë²ˆ: ì´ë¦„ ë¶ˆì¼ì¹˜ (ë“±ë¡: ${students[studentNum].name}, íŒŒì¼: ${studentName})`);
                    }

                    scores[currentScoreSubject][studentNum] = {};

                    for (let j = 2; j < headers.length && j < row.length; j++) {
                        const areaIndex = j - 2;
                        if (areaIndex < areas.length) {
                            const score = row[j];
                            if (score !== undefined && score !== '') {
                                scores[currentScoreSubject][studentNum][areas[areaIndex].name] = parseInt(score) || 0;
                            }
                        }
                    }
                } else if (studentNum) {
                    errorMessages.push(`${studentNum}ë²ˆ: ë“±ë¡ë˜ì§€ ì•Šì€ í•™ìƒ`);
                }
            }

            if (errorMessages.length > 0) {
                alert('ì˜¤ë¥˜ ë°œê²¬:\n' + errorMessages.join('\n') + '\n\nê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
            }

            generateScoreTable();
            saveScores();
            alert(`${currentScoreSubject} ì ìˆ˜ íŒŒì¼ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }

        // ===== í•™ìƒ ì¡°íšŒ =====

        // í•™ìƒ ì ìˆ˜ í™•ì¸
        function checkScore() {
            const studentNumber = document.getElementById('studentLoginNumber').value.trim();
            const resultDiv = document.getElementById('studentResult');

            if (!studentNumber) {
                alert('í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            if (!students[studentNumber]) {
                alert('ë“±ë¡ë˜ì§€ ì•Šì€ í•™ë²ˆì…ë‹ˆë‹¤.');
                return;
            }

            if (Object.keys(subjects).length === 0) {
                resultDiv.innerHTML = `
                    <div class="result-box">
                        <h4>ğŸ˜” ì•„ì§ ê³¼ëª©ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</h4>
                    </div>
                `;
                resultDiv.style.display = 'block';
                return;
            }

            // ë“±ë¡ëœ ê³¼ëª©ë§Œ í•„í„°ë§
            const publishedSubjectKeys = Object.keys(publishedSubjects).filter(key => publishedSubjects[key] === true);

            if (publishedSubjectKeys.length === 0) {
                resultDiv.innerHTML = `
                    <div class="result-box">
                        <h4>ğŸ“š ì¡°íšŒ ê°€ëŠ¥í•œ ì ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤</h4>
                        <p style="color: #666;">ì„ ìƒë‹˜ì´ ì•„ì§ ì ìˆ˜ë¥¼ ë“±ë¡í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                resultDiv.style.display = 'block';
                return;
            }

            const student = students[studentNumber];
            let resultHTML = `
                <div class="result-box">
                    <h4>ğŸ‰ ${student.name} (${student.grade}í•™ë…„ ${student.class}ë°˜) ì ìˆ˜</h4>
            `;

            // ë“±ë¡ëœ ê³¼ëª©ë§Œ í•™ë…„ë³„ë¡œ ê·¸ë£¹í•‘í•´ì„œ í‘œì‹œ
            const groupedSubjects = {};
            publishedSubjectKeys.forEach(subjectKey => {
                const subject = subjects[subjectKey];
                if (subject) {
                    if (!groupedSubjects[subject.grade]) {
                        groupedSubjects[subject.grade] = [];
                    }
                    groupedSubjects[subject.grade].push({key: subjectKey, data: subject});
                }
            });

            // í•™ë…„ ìˆœìœ¼ë¡œ ê³¼ëª©ë³„ ì ìˆ˜ í‘œì‹œ (3,2,1)
            [3,2,1].forEach(grade => {
                if (groupedSubjects[grade]) {
                    resultHTML += `<h5 style="margin: 30px 0 15px 0; color: #28a745;">ğŸ“ ${grade}í•™ë…„ ê³¼ëª©</h5>`;

                    groupedSubjects[grade].forEach(({key, data}) => {
                        const studentScores = scores[key] && scores[key][studentNumber] ? scores[key][studentNumber] : {};

                        if (data.areas.length > 0) {
                            let subjectTotal = 0;
                            let subjectMaxTotal = 0;

                            resultHTML += `
                                <div style="margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 4px;">
                                    <h5 style="margin: 0 0 15px 0; color: #007bff;">ğŸ“š ${data.name}</h5>
                                    <table style="width: 100%; margin: 10px 0;">
                                        <tr style="background-color: #f8f9fa;">
                                            <th style="padding: 8px; border: 1px solid #ddd;">ì˜ì—­</th>
                                            <th style="padding: 8px; border: 1px solid #ddd;">ì ìˆ˜</th>
                                            <th style="padding: 8px; border: 1px solid #ddd;">ë§Œì </th>
                                        </tr>
                            `;

                            data.areas.forEach(area => {
                                const score = studentScores[area.name] || 0;
                                subjectTotal += score;
                                subjectMaxTotal += area.maxScore;

                                resultHTML += `
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #ddd;">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <span>${area.name}</span>
                                                <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; cursor: pointer;">
                                                    <input type="checkbox" id="area_${key}_${area.name}" onchange="markAreaAsChecked('${key}', '${studentNumber}', '${area.name}')" style="transform: scale(0.9);"
                                                           title="${area.name} ì˜ì—­ ì ìˆ˜ í™•ì¸ ì™„ë£Œ í‘œì‹œ"
                                                           aria-label="${area.name} ì˜ì—­ í™•ì¸ ì²´í¬ë°•ìŠ¤">
                                                    <span style="color: #666;">í™•ì¸</span>
                                                </label>
                                            </div>
                                        </td>
                                        <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; color: #007bff;">
                                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                                <span>${score}ì </span>
                                                <button onclick="askQuestion('${key}', '${studentNumber}', '${area.name}', ${score})"
                                                        style="background: #ffc107; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;">
                                                    ?
                                                </button>
                                            </div>
                                        </td>
                                        <td style="padding: 8px; border: 1px solid #ddd;">${area.maxScore}ì </td>
                                    </tr>
                                `;
                            });

                            resultHTML += `
                                        <tr style="background-color: #e3f2fd;">
                                            <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">ì†Œê³„</td>
                                            <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; color: #007bff;">${subjectTotal}ì </td>
                                            <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">${subjectMaxTotal}ì </td>
                                        </tr>
                                    </table>

                                    <div id="subjectStatus_${key}" style="margin-top: 15px; text-align: center; padding: 10px; border-radius: 4px;">
                                        <!-- ì˜ì—­ë³„ í™•ì¸ ìƒíƒœê°€ ë™ì ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤ -->
                                    </div>
                                </div>
                            `;
                        }
                    });
                }
            });

            resultHTML += '</div>';

            resultDiv.innerHTML = resultHTML;
            resultDiv.style.display = 'block';

            // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë³µì› ë° ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
            publishedSubjectKeys.forEach(subjectKey => {
                const subject = subjects[subjectKey];
                if (subject && subject.areas) {
                    // ì˜ì—­ë³„ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë³µì›
                    subject.areas.forEach(area => {
                        const checkbox = document.getElementById(`area_${subjectKey}_${area.name}`);
                        if (checkbox && studentChecked[subjectKey] && studentChecked[subjectKey][studentNumber] && studentChecked[subjectKey][studentNumber][area.name]) {
                            checkbox.checked = true;
                        }
                    });

                    // ê³¼ëª©ë³„ ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
                    updateSubjectStatus(subjectKey, studentNumber);
                }
            });
        }

        // ì˜ì—­ë³„ í™•ì¸ í‘œì‹œ
        function markAreaAsChecked(subjectKey, studentNumber, areaName) {
            if (!studentChecked[subjectKey]) {
                studentChecked[subjectKey] = {};
            }
            if (!studentChecked[subjectKey][studentNumber]) {
                studentChecked[subjectKey][studentNumber] = {};
            }

            const checkbox = document.getElementById(`area_${subjectKey}_${areaName}`);
            studentChecked[subjectKey][studentNumber][areaName] = checkbox.checked;

            saveStudentChecked();
            updateSubjectStatus(subjectKey, studentNumber);
        }

        // ê³¼ëª©ë³„ ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateSubjectStatus(subjectKey, studentNumber) {
            const subject = subjects[subjectKey];
            const statusDiv = document.getElementById(`subjectStatus_${subjectKey}`);

            if (!subject || !statusDiv) return;

            const totalAreas = subject.areas.length;
            let checkedAreas = 0;
            let questionsCount = 0;

            // í™•ì¸ëœ ì˜ì—­ ìˆ˜ ê³„ì‚°
            if (studentChecked[subjectKey] && studentChecked[subjectKey][studentNumber]) {
                subject.areas.forEach(area => {
                    if (studentChecked[subjectKey][studentNumber][area.name]) {
                        checkedAreas++;
                    }
                });
            }

            // ì˜ë¬¸ì‚¬í•­ ìˆ˜ ê³„ì‚°
            if (studentQuestions[subjectKey] && studentQuestions[subjectKey][studentNumber]) {
                questionsCount = Object.keys(studentQuestions[subjectKey][studentNumber]).length;
            }

            let statusHTML = '';
            if (checkedAreas === totalAreas) {
                statusHTML = `
                    <div style="background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb;">
                        âœ… ëª¨ë“  ì˜ì—­ í™•ì¸ ì™„ë£Œ (${checkedAreas}/${totalAreas})
                    </div>
                `;
            } else {
                statusHTML = `
                    <div style="background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7;">
                        â³ í™•ì¸ ì§„í–‰ ì¤‘ (${checkedAreas}/${totalAreas})
                    </div>
                `;
            }

            if (questionsCount > 0) {
                statusHTML += `
                    <div style="background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; margin-top: 5px;">
                        â“ ì˜ë¬¸ì‚¬í•­ ${questionsCount}ê±´
                    </div>
                `;
            }

            statusDiv.innerHTML = statusHTML;
        }

        // ì ìˆ˜ ì˜ë¬¸ì‚¬í•­ ì œê¸°
        function askQuestion(subjectKey, studentNumber, areaName, score) {
            const subject = subjects[subjectKey];
            const student = students[studentNumber];
            const question = prompt(`ğŸ“ ${subject.grade}í•™ë…„-${subject.name} > ${areaName} (${score}ì )\n\nê¶ê¸ˆí•œ ì ì´ë‚˜ ì˜ë¬¸ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”:`);

            if (question && question.trim()) {
                if (!studentQuestions[subjectKey]) {
                    studentQuestions[subjectKey] = {};
                }
                if (!studentQuestions[subjectKey][studentNumber]) {
                    studentQuestions[subjectKey][studentNumber] = {};
                }

                studentQuestions[subjectKey][studentNumber][areaName] = question.trim();
                saveStudentQuestions();
                updateSubjectStatus(subjectKey, studentNumber);

                alert(`ğŸ“© ì˜ë¬¸ì‚¬í•­ì´ ì„ ìƒë‹˜ê»˜ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n${areaName}: ${question.trim()}`);
            }
        }

        // ===== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ =====

        // í•™ìƒ ëª…ë‹¨ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
        function downloadStudentTemplate() {
            const wb = XLSX.utils.book_new();
            const data = [
                ['í•™ë²ˆ', 'ì´ë¦„'],
                ['30101', 'ê¹€ì² ìˆ˜'],
                ['30102', 'ì´ì˜í¬'],
                ['30201', 'ë°•ë¯¼ìˆ˜'],
                ['30202', 'ìµœí•˜ë‚˜']
            ];

            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{ wch: 10 }, { wch: 15 }];

            XLSX.utils.book_append_sheet(wb, ws, 'í•™ìƒëª…ë‹¨');
            const today = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `í•™ìƒëª…ë‹¨_ì–‘ì‹_${today}.xlsx`);
        }

        // ëª¨ë“  í•™ìƒ ì‚­ì œ
        function clearAllStudents() {
            if (!confirm('ëª¨ë“  í•™ìƒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì ìˆ˜ ë°ì´í„°ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤)')) return;

            students = {};
            // ëª¨ë“  ê³¼ëª©ì˜ ì ìˆ˜ ì´ˆê¸°í™”
            Object.keys(scores).forEach(subject => {
                scores[subject] = {};
            });

            updateStats();
            updateMatrix();
            updateTemplateButton();
            saveStudents();
            saveScores();
        }

        // ì ìˆ˜ ì´ˆê¸°í™”
        function clearScores() {
            if (!currentScoreSubject) return;
            if (!confirm(`${currentScoreSubject} ê³¼ëª©ì˜ ëª¨ë“  ì ìˆ˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            scores[currentScoreSubject] = {};
            generateScoreTable();
            saveScores();
        }

        // ===== ë°ì´í„° ì €ì¥/ë¡œë“œ =====

        function saveStudents() {
            localStorage.setItem('students', JSON.stringify(students));
            // Firebaseì—ë„ ë™ê¸°í™” (ë¹„ë°€ë²ˆí˜¸ í¬í•¨)
            syncToFirebase('students', students);
        }

        function loadStudents() {
            const saved = localStorage.getItem('students');
            if (saved) {
                students = JSON.parse(saved);
                updateStats();
            }
        }

        function saveSubjects() {
            localStorage.setItem('subjects', JSON.stringify(subjects));
        }

        function loadSubjects() {
            const saved = localStorage.getItem('subjects');
            if (saved) {
                subjects = JSON.parse(saved);
                updateSubjectList();
            }
        }

        function saveScores() {
            localStorage.setItem('scores', JSON.stringify(scores));
            // Firebaseì—ë„ ë™ê¸°í™”
            syncToFirebase('scores', scores);
        }

        function loadScores() {
            const saved = localStorage.getItem('scores');
            if (saved) {
                scores = JSON.parse(saved);
            }
        }

        function savePublishedSubjects() {
            localStorage.setItem('publishedSubjects', JSON.stringify(publishedSubjects));
            // Firebaseì—ë„ ë™ê¸°í™”
            syncToFirebase('publishedSubjects', publishedSubjects);
        }

        function loadPublishedSubjects() {
            const saved = localStorage.getItem('publishedSubjects');
            if (saved) {
                publishedSubjects = JSON.parse(saved);
            }
        }

        function saveStudentChecked() {
            localStorage.setItem('studentChecked', JSON.stringify(studentChecked));
            // Firebaseì—ë„ ë™ê¸°í™”
            syncToFirebase('studentChecked', studentChecked);
        }

        function loadStudentChecked() {
            const saved = localStorage.getItem('studentChecked');
            if (saved) {
                studentChecked = JSON.parse(saved);
            }
        }

        function saveStudentQuestions() {
            localStorage.setItem('studentQuestions', JSON.stringify(studentQuestions));
            // Firebaseì—ë„ ë™ê¸°í™”
            syncToFirebase('studentQuestions', studentQuestions);
        }

        function loadStudentQuestions() {
            const saved = localStorage.getItem('studentQuestions');
            if (saved) {
                studentQuestions = JSON.parse(saved);
            }
        }

        // ===== ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ =====

        // Enter í‚¤ ì´ë²¤íŠ¸
        document.addEventListener('DOMContentLoaded', function() {
            // í•™ìƒ ì¶”ê°€
            document.getElementById('studentNumber').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') document.getElementById('studentName').focus();
            });

            document.getElementById('studentName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addStudent();
            });

            // ê³¼ëª© ì¶”ê°€
            document.getElementById('subjectName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addSubject();
            });

            // ì˜ì—­ ì¶”ê°€
            document.getElementById('areaName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') document.getElementById('areaMaxScore').focus();
            });

            document.getElementById('areaMaxScore').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addArea();
            });

            // í•™ìƒ ì¡°íšŒ
            document.getElementById('studentLoginNumber').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') checkScore();
            });

            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
            document.getElementById('studentModal').addEventListener('click', function(e) {
                if (e.target === this) closeModal();
            });

            document.getElementById('autoAreaModal').addEventListener('click', function(e) {
                if (e.target === this) closeAutoAreaModal();
            });
        });

        // ===== Firebase í†µí•© ê¸°ëŠ¥ =====

        // Firebase ì—°ê²° ìƒíƒœ í‘œì‹œ
        function showConnectionStatus(message, type) {
            // ìƒíƒœ í‘œì‹œ ì˜ì—­ì´ ì—†ìœ¼ë©´ ìƒì„±
            let statusDiv = document.getElementById('connectionStatus');
            if (!statusDiv) {
                statusDiv = document.createElement('div');
                statusDiv.id = 'connectionStatus';
                statusDiv.style.cssText = `
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    padding: 8px 15px;
                    border-radius: 4px;
                    font-size: 12px;
                    font-weight: bold;
                    z-index: 1000;
                    max-width: 200px;
                `;
                document.body.appendChild(statusDiv);
            }

            statusDiv.textContent = message;

            if (type === 'success') {
                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.style.border = '1px solid #c3e6cb';
            } else if (type === 'error') {
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.style.border = '1px solid #f5c6cb';
            } else {
                statusDiv.style.backgroundColor = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.style.border = '1px solid #ffeaa7';
            }
        }

        // Firebaseì— ë°ì´í„° ë™ê¸°í™”
        function syncToFirebase(path, data) {
            if (!window.firebase || !firebaseInitialized) {
                console.log(`Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•„ ${path} ë™ê¸°í™”ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.`);
                return;
            }

            try {
                const dataRef = window.firebase.ref(window.firebase.database, path);
                window.firebase.set(dataRef, data).then(() => {
                    console.log(`${path} ë°ì´í„°ê°€ Firebaseì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                }).catch(error => {
                    console.error(`${path} Firebase ì €ì¥ ì˜¤ë¥˜:`, error);
                    showConnectionStatus('âš ï¸ Firebase ì €ì¥ ì˜¤ë¥˜', 'error');
                });
            } catch (error) {
                console.error(`${path} Firebase ë™ê¸°í™” ì˜¤ë¥˜:`, error);
                showConnectionStatus('âš ï¸ Firebase ë™ê¸°í™” ì˜¤ë¥˜', 'error');
            }
        }

        // Firebase ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupFirebaseListeners() {
            if (!window.firebase || !firebaseInitialized) {
                console.log('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •ì„ ê±´ë„ˆëœë‹ˆë‹¤.');
                return;
            }

            // í•™ìƒ í™•ì¸ ìƒíƒœ ë¦¬ìŠ¤ë„ˆ
            const checkedRef = window.firebase.ref(window.firebase.database, 'studentChecked');
            firebaseListeners.studentChecked = window.firebase.onValue(checkedRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    studentChecked = data;
                    localStorage.setItem('studentChecked', JSON.stringify(studentChecked));
                    // í˜„ì¬ ì ìˆ˜ ê´€ë¦¬ íƒ­ì´ ì—´ë ¤ìˆë‹¤ë©´ í…Œì´ë¸” ìƒˆë¡œê³ ì¹¨
                    if (currentScoreSubject && document.getElementById('admin-content').classList.contains('active')) {
                        generateScoreTable();
                    }
                }
            });

            // í•™ìƒ ì˜ë¬¸ì‚¬í•­ ë¦¬ìŠ¤ë„ˆ
            const questionsRef = window.firebase.ref(window.firebase.database, 'studentQuestions');
            firebaseListeners.studentQuestions = window.firebase.onValue(questionsRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const previousQuestions = JSON.stringify(studentQuestions);
                    studentQuestions = data;
                    localStorage.setItem('studentQuestions', JSON.stringify(studentQuestions));

                    // ìƒˆë¡œìš´ ì˜ë¬¸ì‚¬í•­ì´ ì¶”ê°€ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ê³  ì•Œë¦¼
                    if (previousQuestions !== JSON.stringify(studentQuestions)) {
                        checkForNewQuestions();
                    }

                    // í˜„ì¬ ì ìˆ˜ ê´€ë¦¬ íƒ­ì´ ì—´ë ¤ìˆë‹¤ë©´ í…Œì´ë¸” ìƒˆë¡œê³ ì¹¨
                    if (currentScoreSubject && document.getElementById('admin-content').classList.contains('active')) {
                        generateScoreTable();
                    }
                }
            });

            console.log('Firebase ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ìƒˆë¡œìš´ ì˜ë¬¸ì‚¬í•­ í™•ì¸ ë° ì•Œë¦¼
        function checkForNewQuestions() {
            Object.keys(studentQuestions).forEach(subjectKey => {
                const subjectQuestions = studentQuestions[subjectKey];
                Object.keys(subjectQuestions).forEach(studentNumber => {
                    const questionCount = Object.keys(subjectQuestions[studentNumber]).length;
                    if (questionCount > 0) {
                        const student = students[studentNumber];
                        const subject = subjects[subjectKey];
                        if (student && subject) {
                            showConnectionStatus(`ìƒˆ ì˜ë¬¸ì‚¬í•­: ${student.name} (${subject.name})`, 'error');
                        }
                    }
                });
            });
        }

        // ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸ ìƒì„± í•¨ìˆ˜
        function generateDefaultPassword(studentNumber) {
            return '0123'; // ëª¨ë“  í•™ìƒì˜ ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ëŠ” 0123
        }

        // ë¹„ë°€ë²ˆí˜¸ ë³´ê¸°/ìˆ¨ê¸°ê¸° í† ê¸€
        function togglePasswordVisibility() {
            const passwordField = document.getElementById('modalStudentPassword');
            const toggleBtn = document.getElementById('togglePasswordBtn');

            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                toggleBtn.textContent = 'ğŸ™ˆ';
            } else {
                passwordField.type = 'password';
                toggleBtn.textContent = 'ğŸ‘ï¸';
            }
        }

        // ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”
        function resetPassword() {
            if (!currentEditingStudent) return;

            const student = students[currentEditingStudent];
            const confirmMsg = `${student.name} í•™ìƒì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n` +
                              `â€¢ ë¹„ë°€ë²ˆí˜¸ê°€ 0123ìœ¼ë¡œ ì¬ì„¤ì •ë©ë‹ˆë‹¤\n` +
                              `â€¢ í•™ìƒì€ ë‹¤ìŒ ë¡œê·¸ì¸ ì‹œ ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤\n` +
                              `â€¢ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤`;

            if (!confirm(confirmMsg)) return;

            // ë¹„ë°€ë²ˆí˜¸ë¥¼ 0123ìœ¼ë¡œ ì´ˆê¸°í™”
            students[currentEditingStudent].password = '0123';

            // ëª¨ë‹¬ì˜ ë¹„ë°€ë²ˆí˜¸ í•„ë“œ ì—…ë°ì´íŠ¸
            document.getElementById('modalStudentPassword').value = '0123';

            // ì €ì¥
            saveStudents();

            alert(`${student.name} í•™ìƒì˜ ë¹„ë°€ë²ˆí˜¸ê°€ 0123ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.\ní•™ìƒì—ê²Œ ì²« ë¡œê·¸ì¸ ì‹œ ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•˜ë„ë¡ ì•ˆë‚´í•´ì£¼ì„¸ìš”.`);
        }

        // Firebase ì„¤ì • ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function openFirebaseSettings() {
            const modal = document.getElementById('firebaseSettingsModal');

            // ì €ì¥ëœ ì„¤ì •ì´ ìˆìœ¼ë©´ í‘œì‹œ
            const apiKey = localStorage.getItem('firebaseApiKey');
            const projectId = localStorage.getItem('firebaseProjectId');

            if (apiKey) document.getElementById('firebaseApiKey').value = apiKey;
            if (projectId) document.getElementById('firebaseProjectId').value = projectId;

            modal.style.display = 'block';
        }

        function closeFirebaseModal() {
            document.getElementById('firebaseSettingsModal').style.display = 'none';
        }

        function saveUserFirebaseConfig() {
            const apiKey = document.getElementById('firebaseApiKey').value.trim();
            const projectId = document.getElementById('firebaseProjectId').value.trim();

            // í•„ìˆ˜ í•„ë“œ ê²€ì¦
            if (!apiKey || !projectId) {
                alert('API Keyì™€ Project IDëŠ” í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.');
                return;
            }

            if (!apiKey.startsWith('AIza')) {
                alert('ì˜¬ë°”ë¥¸ Firebase API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (AIzaë¡œ ì‹œì‘)');
                return;
            }

            // localStorageì— ì„¤ì • ì €ì¥
            localStorage.setItem('firebaseApiKey', apiKey);
            localStorage.setItem('firebaseProjectId', projectId);

            // ë‚˜ë¨¸ì§€ ê°’ë“¤ì€ Project IDë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìë™ ìƒì„±
            const authDomain = `${projectId}.firebaseapp.com`;
            const databaseURL = `https://${projectId}-default-rtdb.asia-southeast1.firebasedatabase.app/`;
            const storageBucket = `${projectId}.appspot.com`;

            localStorage.setItem('firebaseAuthDomain', authDomain);
            localStorage.setItem('userDatabaseURL', databaseURL);
            localStorage.setItem('firebaseStorageBucket', storageBucket);

            alert('Firebase ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì €ì¥ëœ ì„¤ì •:\nâ€¢ API Key: ' + apiKey.substring(0, 20) + '...\nâ€¢ Project ID: ' + projectId + '\nâ€¢ ì§€ì—­: ì‹±ê°€í¬ë¥´ (asia-southeast1)');
            closeFirebaseModal();
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
        document.getElementById('firebaseSettingsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeFirebaseModal();
            }
        });

        document.getElementById('studentModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        document.getElementById('autoAreaModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAutoAreaModal();
            }
        });

        // Firebase ë¦¬ìŠ¤ë„ˆ ì •ë¦¬ (í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ)
        window.addEventListener('beforeunload', () => {
            Object.values(firebaseListeners).forEach(unsubscribe => {
                if (typeof unsubscribe === 'function') {
                    unsubscribe();
                }
            });
        });
    </script>
</body>
</html>
