<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“š í•™ìƒ ì ìˆ˜ ì¡°íšŒ</title>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue, set, push } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyBqDemoApiKey123456789",
            authDomain: "student-scores-demo.firebaseapp.com",
            databaseURL: "https://student-scores-demo-default-rtdb.firebaseio.com",
            projectId: "student-scores-demo",
            storageBucket: "student-scores-demo.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456789"
        };

        // Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // ì „ì—­ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ window ê°ì²´ì— í• ë‹¹
        window.firebase = {
            database,
            ref,
            onValue,
            set,
            push
        };
    </script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }

        .header h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
        }

        .header p {
            margin: 0;
            opacity: 0.9;
            font-size: 16px;
        }

        .login-section {
            padding: 40px;
            text-align: center;
            background-color: #f8f9fa;
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .input-field {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .result-section {
            display: none;
            padding: 30px;
        }

        .student-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            text-align: center;
        }

        .subject-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .subject-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .subject-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin: 0;
        }

        .subject-content {
            padding: 20px;
        }

        .score-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        .score-table th, .score-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .score-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #495057;
        }

        .score-table .score-cell {
            font-weight: bold;
            color: #007bff;
            text-align: center;
        }

        .score-table .max-score-cell {
            text-align: center;
            color: #6c757d;
        }

        .total-row {
            background-color: #e3f2fd;
            font-weight: bold;
        }

        .area-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .area-checkbox input[type="checkbox"] {
            transform: scale(1.2);
        }

        .area-checkbox label {
            cursor: pointer;
            margin: 0;
        }

        .question-btn {
            background: #ffc107;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 10px;
        }

        .question-btn:hover {
            background: #e0a800;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-top: 15px;
        }

        .status-complete {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-progress {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-question {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .no-data h3 {
            margin: 0 0 10px 0;
            font-size: 24px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 30px 30px 20px 30px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
        }

        .modal-header h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 24px;
        }

        .modal-header p {
            margin: 0;
            font-size: 14px;
        }

        .modal-body {
            padding: 30px;
        }

        .modal-footer {
            padding: 20px 30px 30px 30px;
            text-align: center;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
        }

        .connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 24px;
            }

            .login-section {
                padding: 20px;
            }

            .subject-content {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- ì—°ê²° ìƒíƒœ í‘œì‹œ -->
    <div id="connectionStatus" class="connection-status disconnected">
        ğŸ”„ ì—°ê²° ì¤‘...
    </div>

    <div class="container">
        <div class="header">
            <h1>ğŸ“š í•™ìƒ ì ìˆ˜ ì¡°íšŒ</h1>
            <p>ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ëŠ” ìˆ˜í–‰í‰ê°€ ì ìˆ˜ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
        </div>

        <!-- ë¡œê·¸ì¸ ì„¹ì…˜ -->
        <div id="loginSection" class="login-section">
            <div class="login-form">
                <h2 style="color: #333; margin-bottom: 30px;">ğŸ” í•™ìƒ ë¡œê·¸ì¸</h2>

                <div class="input-group">
                    <label for="studentNumber">í•™ë²ˆ (ì•„ì´ë””)</label>
                    <input type="text"
                           id="studentNumber"
                           class="input-field"
                           placeholder="í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 30101)"
                           maxlength="5">
                </div>

                <div class="input-group">
                    <label for="studentPassword">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password"
                           id="studentPassword"
                           class="input-field"
                           placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>

                <button id="loginBtn" class="btn" onclick="loginStudent()">
                    ğŸ“Š ë¡œê·¸ì¸í•˜ê¸°
                </button>

                <div style="margin-top: 20px; padding: 15px; background-color: #e9ecef; border-radius: 8px; text-align: left; font-size: 14px; color: #495057;">
                    <strong>ğŸ“‹ ë¡œê·¸ì¸ ì •ë³´:</strong><br>
                    â€¢ í•™ë²ˆ: í•™ë…„(1ìë¦¬) + ë°˜(2ìë¦¬) + ë²ˆí˜¸(2ìë¦¬)<br>
                    â€¢ ì˜ˆì‹œ: 3í•™ë…„ 1ë°˜ 1ë²ˆ â†’ 30101<br><br>
                    â€¢ ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸: 0123<br>
                    â€¢ âš ï¸ ì²« ë¡œê·¸ì¸ ì‹œ ë°˜ë“œì‹œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤<br>
                    â€¢ ì„±ì  ë³´ì•ˆì„ ìœ„í•´ ê°œì¸ë§Œ ì•„ëŠ” ë¹„ë°€ë²ˆí˜¸ë¡œ ì„¤ì •í•˜ì„¸ìš”
                </div>
            </div>
        </div>

        <!-- ê²°ê³¼ ì„¹ì…˜ -->
        <div id="resultSection" class="result-section">
            <div id="studentInfo" class="student-info">
                <!-- í•™ìƒ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>

            <div id="scoresContainer">
                <!-- ì ìˆ˜ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" onclick="logout()" style="width: auto; padding: 10px 30px;">
                    ğŸ”„ ë‹¤ë¥¸ í•™ë²ˆìœ¼ë¡œ ì¡°íšŒ
                </button>
            </div>
        </div>

        <!-- ë°ì´í„° ì—†ìŒ -->
        <div id="noDataSection" class="no-data" style="display: none;">
            <h3>ğŸ“š ì¡°íšŒ ê°€ëŠ¥í•œ ì ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
            <p>ì„ ìƒë‹˜ì´ ì•„ì§ ì ìˆ˜ë¥¼ ë“±ë¡í•˜ì§€ ì•Šì•˜ê±°ë‚˜<br>í•´ë‹¹ í•™ë²ˆì´ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
            <button class="btn" onclick="logout()" style="width: auto; padding: 10px 30px; margin-top: 20px;">
                ğŸ”„ ë‹¤ì‹œ ì‹œë„
            </button>
        </div>

        <!-- ë¡œë”© -->
        <div id="loadingSection" class="loading" style="display: none;">
            <h3>ğŸ”„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h3>
        </div>

        <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ -->
        <div id="passwordChangeModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ğŸ” ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í•„ìˆ˜</h3>
                    <p style="color: #dc3545; font-weight: bold;">ë³´ì•ˆì„ ìœ„í•´ ì²« ë¡œê·¸ì¸ ì‹œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë°˜ë“œì‹œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.</p>
                </div>
                <div class="modal-body">
                    <div class="input-group">
                        <label for="currentPassword">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="currentPassword" class="input-field" value="0123" readonly style="background-color: #f8f9fa;">
                    </div>
                    <div class="input-group">
                        <label for="newPassword">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="newPassword" class="input-field" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (4ìë¦¬ ì´ìƒ)">
                    </div>
                    <div class="input-group">
                        <label for="confirmPassword">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                        <input type="password" id="confirmPassword" class="input-field" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <div style="background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 15px; margin: 15px 0; color: #856404; font-size: 14px;">
                        <strong>âš ï¸ ì£¼ì˜ì‚¬í•­:</strong><br>
                        â€¢ ë¹„ë°€ë²ˆí˜¸ëŠ” 4ìë¦¬ ì´ìƒìœ¼ë¡œ ì„¤ì •í•˜ì„¸ìš”<br>
                        â€¢ ë‹¤ë¥¸ í•™ìƒì´ ì¶”ì¸¡í•˜ê¸° ì–´ë ¤ìš´ ë²ˆí˜¸ë¡œ ì„¤ì •í•˜ì„¸ìš”<br>
                        â€¢ ìƒë…„ì›”ì¼, ì „í™”ë²ˆí˜¸ ë“± ê°œì¸ì •ë³´ ì‚¬ìš©ì€ í”¼í•˜ì„¸ìš”<br>
                        â€¢ ë¹„ë°€ë²ˆí˜¸ë¥¼ ìŠì–´ë²„ë¦¬ë©´ ë‹´ì„ì„ ìƒë‹˜ê»˜ ë¬¸ì˜í•˜ì„¸ìš”
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="changePasswordBtn" class="btn" onclick="changePassword()">
                        âœ… ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentStudent = null;
        let isConnected = false;
        let dataListeners = []; // ë°ì´í„° ë¦¬ìŠ¤ë„ˆë“¤ì„ ì €ì¥

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = function() {
            setupEventListeners();

            // Firebaseê°€ ë¡œë“œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
            const checkFirebase = setInterval(() => {
                if (window.firebase) {
                    clearInterval(checkFirebase);
                    initializeFirebase();
                }
            }, 100);
        };

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupEventListeners() {
            // Enter í‚¤ë¡œ ë¡œê·¸ì¸
            document.getElementById('studentNumber').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('studentPassword').focus();
                }
            });

            document.getElementById('studentPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loginStudent();
                }
            });

            // í•™ë²ˆ ì…ë ¥ ì‹œ ìˆ«ìë§Œ í—ˆìš©
            document.getElementById('studentNumber').addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
            });

            // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ ì´ë²¤íŠ¸
            document.getElementById('newPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('confirmPassword').focus();
                }
            });

            document.getElementById('confirmPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    changePassword();
                }
            });
        }

        // í•™ë²ˆ ìœ íš¨ì„± ê²€ì‚¬
        function validateStudentNumber(studentNumber) {
            if (!studentNumber || studentNumber.length !== 5) {
                return false;
            }

            const grade = parseInt(studentNumber.substring(0, 1));
            const classNum = parseInt(studentNumber.substring(1, 3));
            const number = parseInt(studentNumber.substring(3, 5));

            return grade >= 1 && grade <= 3 &&
                   classNum >= 1 && classNum <= 20 &&
                   number >= 1 && number <= 40;
        }

        // í•™ìƒ ë¡œê·¸ì¸
        function loginStudent() {
            const studentNumber = document.getElementById('studentNumber').value.trim();
            const password = document.getElementById('studentPassword').value.trim();

            if (!validateStudentNumber(studentNumber)) {
                alert('ì˜¬ë°”ë¥¸ í•™ë²ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\ní˜•ì‹: í•™ë…„(1ìë¦¬) + ë°˜(2ìë¦¬) + ë²ˆí˜¸(2ìë¦¬)\nì˜ˆì‹œ: 30101');
                return;
            }

            if (!password) {
                alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            showLoading();

            // ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ í›„ í•™ìƒ ë°ì´í„° ì¡°íšŒ
            setTimeout(() => {
                authenticateAndLoadStudent(studentNumber, password);
            }, 1000);
        }

        // ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ ë° í•™ìƒ ë°ì´í„° ë¡œë“œ
        function authenticateAndLoadStudent(studentNumber, password) {
            if (!window.firebase) {
                alert('Firebase ì—°ê²°ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                logout();
                return;
            }

            // Firebaseì—ì„œ í•™ìƒ ì •ë³´ ë° ë¹„ë°€ë²ˆí˜¸ í™•ì¸
            const studentRef = window.firebase.ref(window.firebase.database, `students/${studentNumber}`);
            window.firebase.onValue(studentRef, (snapshot) => {
                const studentData = snapshot.val();

                if (!studentData) {
                    hideLoading();
                    alert('ë“±ë¡ë˜ì§€ ì•Šì€ í•™ë²ˆì…ë‹ˆë‹¤.\në‹´ì„ì„ ìƒë‹˜ê»˜ ë¬¸ì˜í•˜ì„¸ìš”.');
                    return;
                }

                // ë¹„ë°€ë²ˆí˜¸ ê²€ì¦
                const storedPassword = studentData.password || generateDefaultPassword(studentNumber);

                if (password !== storedPassword) {
                    hideLoading();
                    alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.\nì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ëŠ” 0123ì…ë‹ˆë‹¤.');
                    return;
                }

                // ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ì¸ ê²½ìš° ê°•ì œ ë³€ê²½
                if (storedPassword === '0123') {
                    hideLoading();
                    showPasswordChangeModal(studentNumber);
                    return;
                }

                // ì¸ì¦ ì„±ê³µ - í•™ìƒ ë°ì´í„° ë¡œë“œ
                loadStudentData(studentNumber);
            }, {
                onlyOnce: true // í•œ ë²ˆë§Œ ì‹¤í–‰
            });
        }

        // ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸ ìƒì„±
        function generateDefaultPassword(studentNumber) {
            return '0123'; // ëª¨ë“  í•™ìƒì˜ ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ëŠ” 0123
        }

        // í•™ìƒ ë°ì´í„° ë¡œë“œ (Firebaseì—ì„œ ì‹¤ì‹œê°„ìœ¼ë¡œ)
        function loadStudentData(studentNumber) {
            if (!window.firebase) {
                alert('Firebase ì—°ê²°ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                logout();
                return;
            }

            const { database, ref, onValue } = window.firebase;

            try {
                // ë¨¼ì € í•™ìƒ ì •ë³´ í™•ì¸
                const studentRef = ref(database, `students/${studentNumber}`);
                onValue(studentRef, (snapshot) => {
                    const studentData = snapshot.val();

                    if (!studentData) {
                        showNoData();
                        return;
                    }

                    // í•™ìƒ ë°ì´í„° ì„¤ì •
                    currentStudent = {
                        student: {
                            number: studentNumber,
                            name: studentData.name,
                            grade: studentData.grade,
                            class: studentData.class
                        },
                        subjects: {}
                    };

                    // ë°œí–‰ëœ ê³¼ëª©ë“¤ ë¡œë“œ
                    loadPublishedSubjects(studentNumber);
                }, (error) => {
                    console.error('í•™ìƒ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                    showNoData();
                });

            } catch (error) {
                console.error('Firebase ì˜¤ë¥˜:', error);
                showNoData();
            }
        }

        // ë°œí–‰ëœ ê³¼ëª©ë“¤ ë¡œë“œ
        function loadPublishedSubjects(studentNumber) {
            const { database, ref, onValue } = window.firebase;

            // ë°œí–‰ëœ ê³¼ëª© ëª©ë¡ ì¡°íšŒ
            const publishedRef = ref(database, 'publishedSubjects');
            onValue(publishedRef, (snapshot) => {
                const publishedSubjects = snapshot.val() || {};

                // ê³¼ëª© ë°ì´í„° ë¡œë“œ
                loadSubjectsData(studentNumber, publishedSubjects);
            });
        }

        // ê³¼ëª© ë°ì´í„° ë¡œë“œ
        function loadSubjectsData(studentNumber, publishedSubjects) {
            const { database, ref, onValue } = window.firebase;

            // ë°œí–‰ëœ ê³¼ëª©ë§Œ í•„í„°ë§
            const publishedKeys = Object.keys(publishedSubjects).filter(key => publishedSubjects[key] === true);

            if (publishedKeys.length === 0) {
                showNoData();
                return;
            }

            let loadedCount = 0;
            currentStudent.subjects = {};

            publishedKeys.forEach(subjectKey => {
                // ê³¼ëª© ì •ë³´ ë¡œë“œ
                const subjectRef = ref(database, `subjects/${subjectKey}`);
                onValue(subjectRef, (snapshot) => {
                    const subjectData = snapshot.val();

                    if (subjectData) {
                        currentStudent.subjects[subjectKey] = {
                            name: subjectData.name,
                            grade: subjectData.grade,
                            areas: subjectData.areas || [],
                            scores: {},
                            checked: {},
                            questions: {}
                        };

                        // ì ìˆ˜ ë°ì´í„° ë¡œë“œ
                        loadScoreData(studentNumber, subjectKey);

                        // ì²´í¬ ìƒíƒœ ë¡œë“œ
                        loadCheckedData(studentNumber, subjectKey);

                        // ì˜ë¬¸ì‚¬í•­ ë¡œë“œ
                        loadQuestionData(studentNumber, subjectKey);
                    }

                    loadedCount++;
                    if (loadedCount === publishedKeys.length) {
                        showResults();
                    }
                });
            });
        }

        // ì ìˆ˜ ë°ì´í„° ë¡œë“œ
        function loadScoreData(studentNumber, subjectKey) {
            const { database, ref, onValue } = window.firebase;

            const scoreRef = ref(database, `scores/${subjectKey}/${studentNumber}`);
            const listener = onValue(scoreRef, (snapshot) => {
                const scoreData = snapshot.val() || {};

                if (currentStudent.subjects[subjectKey]) {
                    currentStudent.subjects[subjectKey].scores = scoreData;
                    updateScoresDisplay();
                }
            });

            dataListeners.push(listener);
        }

        // ì²´í¬ ìƒíƒœ ë¡œë“œ
        function loadCheckedData(studentNumber, subjectKey) {
            const { database, ref, onValue } = window.firebase;

            const checkedRef = ref(database, `studentChecked/${subjectKey}/${studentNumber}`);
            const listener = onValue(checkedRef, (snapshot) => {
                const checkedData = snapshot.val() || {};

                if (currentStudent.subjects[subjectKey]) {
                    currentStudent.subjects[subjectKey].checked = checkedData;
                    updateScoresDisplay();
                }
            });

            dataListeners.push(listener);
        }

        // ì˜ë¬¸ì‚¬í•­ ë¡œë“œ
        function loadQuestionData(studentNumber, subjectKey) {
            const { database, ref, onValue } = window.firebase;

            const questionRef = ref(database, `studentQuestions/${subjectKey}/${studentNumber}`);
            const listener = onValue(questionRef, (snapshot) => {
                const questionData = snapshot.val() || {};

                if (currentStudent.subjects[subjectKey]) {
                    currentStudent.subjects[subjectKey].questions = questionData;
                    updateScoresDisplay();
                }
            });

            dataListeners.push(listener);
        }

        // ê²°ê³¼ í‘œì‹œ
        function showResults() {
            hideAllSections();
            document.getElementById('resultSection').style.display = 'block';

            updateStudentInfo();
            updateScoresDisplay();
        }

        // í•™ìƒ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateStudentInfo() {
            const student = currentStudent.student;
            document.getElementById('studentInfo').innerHTML = `
                <h2>ğŸ‰ ${student.name} (${student.number})</h2>
                <p>${student.grade}í•™ë…„ ${student.class}ë°˜ ${student.number.substring(3)}ë²ˆ</p>
            `;
        }

        // ì ìˆ˜ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateScoresDisplay() {
            const container = document.getElementById('scoresContainer');
            const subjects = currentStudent.subjects;

            if (Object.keys(subjects).length === 0) {
                container.innerHTML = '<div class="no-data"><h3>ğŸ“š ë“±ë¡ëœ ì ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤</h3></div>';
                return;
            }

            let html = '';
            Object.keys(subjects).forEach(subjectKey => {
                const subject = subjects[subjectKey];
                html += createSubjectCard(subjectKey, subject);
            });

            container.innerHTML = html;
        }

        // ê³¼ëª© ì¹´ë“œ ìƒì„±
        function createSubjectCard(subjectKey, subject) {
            let totalScore = 0;
            let maxTotalScore = 0;
            let checkedAreas = 0;
            let questionCount = 0;

            let tableRows = '';
            subject.areas.forEach(area => {
                const score = subject.scores[area.name] || 0;
                const isChecked = subject.checked[area.name] || false;
                const hasQuestion = subject.questions[area.name];

                totalScore += score;
                maxTotalScore += area.maxScore;
                if (isChecked) checkedAreas++;
                if (hasQuestion) questionCount++;

                tableRows += `
                    <tr>
                        <td>
                            ${area.name}
                            <div class="area-checkbox">
                                <input type="checkbox" id="check_${subjectKey}_${area.name}"
                                       ${isChecked ? 'checked' : ''}
                                       onchange="markAreaAsChecked('${subjectKey}', '${area.name}')">
                                <label for="check_${subjectKey}_${area.name}">í™•ì¸ì™„ë£Œ</label>
                            </div>
                        </td>
                        <td class="score-cell">
                            ${score}ì 
                            <button class="question-btn" onclick="askQuestion('${subjectKey}', '${area.name}', ${score})">?</button>
                        </td>
                        <td class="max-score-cell">${area.maxScore}ì </td>
                    </tr>
                `;
            });

            // ìƒíƒœ ë±ƒì§€
            let statusBadge = '';
            if (questionCount > 0) {
                statusBadge = `<div class="status-badge status-question">â“ ì˜ë¬¸ì‚¬í•­ ${questionCount}ê±´</div>`;
            } else if (checkedAreas === subject.areas.length) {
                statusBadge = `<div class="status-badge status-complete">âœ… ëª¨ë“  ì˜ì—­ í™•ì¸ ì™„ë£Œ</div>`;
            } else {
                statusBadge = `<div class="status-badge status-progress">â³ í™•ì¸ ì§„í–‰ ì¤‘ (${checkedAreas}/${subject.areas.length})</div>`;
            }

            return `
                <div class="subject-card">
                    <div class="subject-header">
                        <h3 class="subject-title">${subject.grade}í•™ë…„ ${subject.name}</h3>
                    </div>
                    <div class="subject-content">
                        <table class="score-table">
                            <thead>
                                <tr>
                                    <th>ì˜ì—­</th>
                                    <th style="text-align: center;">ì ìˆ˜</th>
                                    <th style="text-align: center;">ë§Œì </th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                                <tr class="total-row">
                                    <td><strong>ì´ì </strong></td>
                                    <td class="score-cell"><strong>${totalScore}ì </strong></td>
                                    <td class="max-score-cell"><strong>${maxTotalScore}ì </strong></td>
                                </tr>
                            </tbody>
                        </table>
                        ${statusBadge}
                    </div>
                </div>
            `;
        }

        // ì˜ì—­ í™•ì¸ í‘œì‹œ
        function markAreaAsChecked(subjectKey, areaName) {
            const checkbox = document.getElementById(`check_${subjectKey}_${areaName}`);

            if (currentStudent.subjects[subjectKey]) {
                currentStudent.subjects[subjectKey].checked[areaName] = checkbox.checked;

                // íŒŒì´ì–´ë² ì´ìŠ¤ì— ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
                updateCheckedStatus(subjectKey, areaName, checkbox.checked);
            }
        }

        // ì˜ë¬¸ì‚¬í•­ ì œê¸°
        function askQuestion(subjectKey, areaName, score) {
            const subject = currentStudent.subjects[subjectKey];
            const question = prompt(`ğŸ“ ${subject.grade}í•™ë…„ ${subject.name} > ${areaName} (${score}ì )\n\nê¶ê¸ˆí•œ ì ì´ë‚˜ ì˜ë¬¸ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”:`);

            if (question && question.trim()) {
                subject.questions[areaName] = question.trim();

                // íŒŒì´ì–´ë² ì´ìŠ¤ì— ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
                updateQuestionData(subjectKey, areaName, question.trim());

                alert(`ğŸ“© ì˜ë¬¸ì‚¬í•­ì´ ì„ ìƒë‹˜ê»˜ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n${areaName}: ${question.trim()}`);
            }
        }

        // ì²´í¬ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateCheckedStatus(subjectKey, areaName, checked) {
            if (!window.firebase || !currentStudent) return;

            const { database, ref, set } = window.firebase;
            const studentNumber = currentStudent.student.number;

            const checkedRef = ref(database, `studentChecked/${subjectKey}/${studentNumber}/${areaName}`);
            set(checkedRef, checked).catch(error => {
                console.error('ì²´í¬ ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            });
        }

        // ì˜ë¬¸ì‚¬í•­ ì—…ë°ì´íŠ¸
        function updateQuestionData(subjectKey, areaName, question) {
            if (!window.firebase || !currentStudent) return;

            const { database, ref, set } = window.firebase;
            const studentNumber = currentStudent.student.number;

            const questionRef = ref(database, `studentQuestions/${subjectKey}/${studentNumber}/${areaName}`);
            set(questionRef, question).catch(error => {
                console.error('ì˜ë¬¸ì‚¬í•­ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            });
        }

        // ì„¹ì…˜ í‘œì‹œ ê´€ë¦¬
        function showLoading() {
            hideAllSections();
            document.getElementById('loadingSection').style.display = 'block';
        }

        function showNoData() {
            hideAllSections();
            document.getElementById('noDataSection').style.display = 'block';
        }

        function hideAllSections() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('noDataSection').style.display = 'none';
            document.getElementById('loadingSection').style.display = 'none';
        }

        function logout() {
            // ëª¨ë“  Firebase ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
            dataListeners.forEach(listener => {
                if (typeof listener === 'function') {
                    listener(); // ë¦¬ìŠ¤ë„ˆ í•´ì œ
                }
            });
            dataListeners = [];

            currentStudent = null;
            document.getElementById('studentNumber').value = '';
            document.getElementById('studentPassword').value = '';
            hideAllSections();
            document.getElementById('loginSection').style.display = 'block';
        }

        // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ í‘œì‹œ
        function showPasswordChangeModal(studentNumber) {
            currentStudent = { studentNumber }; // ì„ì‹œë¡œ í•™ë²ˆ ì €ì¥
            document.getElementById('passwordChangeModal').style.display = 'flex';
            document.getElementById('newPassword').focus();
        }

        // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
        function changePassword() {
            const newPassword = document.getElementById('newPassword').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();

            if (!newPassword) {
                alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (newPassword.length < 4) {
                alert('ë¹„ë°€ë²ˆí˜¸ëŠ” 4ìë¦¬ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            if (newPassword === '0123') {
                alert('ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ì™€ ê°™ì€ ë¹„ë°€ë²ˆí˜¸ëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\në³´ì•ˆì„ ìœ„í•´ ë‹¤ë¥¸ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }

            if (!window.firebase) {
                alert('ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }

            // Firebaseì—ì„œ ë¹„ë°€ë²ˆí˜¸ ì—…ë°ì´íŠ¸
            const studentRef = window.firebase.ref(window.firebase.database, `students/${currentStudent.studentNumber}/password`);
            window.firebase.set(studentRef, newPassword).then(() => {
                // ëª¨ë‹¬ ë‹«ê¸°
                document.getElementById('passwordChangeModal').style.display = 'none';

                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';

                alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!\nì´ì œ ì ìˆ˜ë¥¼ ì¡°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');

                // í•™ìƒ ë°ì´í„° ë¡œë“œ
                showLoading();
                setTimeout(() => {
                    loadStudentData(currentStudent.studentNumber);
                }, 500);

            }).catch(error => {
                console.error('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì˜¤ë¥˜:', error);
                alert('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            });
        }

        // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateConnectionStatus(connected) {
            isConnected = connected;
            const statusElement = document.getElementById('connectionStatus');

            if (connected) {
                statusElement.className = 'connection-status connected';
                statusElement.textContent = 'ğŸŸ¢ ì‹¤ì‹œê°„ ì—°ê²°ë¨';
            } else {
                statusElement.className = 'connection-status disconnected';
                statusElement.textContent = 'ğŸ”´ ì—°ê²° ëŠê¹€';
            }
        }

        // íŒŒì´ì–´ë² ì´ìŠ¤ ì´ˆê¸°í™”
        function initializeFirebase() {
            console.log('Firebase ì´ˆê¸°í™” ì¤‘...');

            if (!window.firebase) {
                console.error('Firebaseê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                updateConnectionStatus(false);
                return;
            }

            try {
                const { database, ref, onValue } = window.firebase;

                // ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§
                const connectedRef = ref(database, '.info/connected');
                onValue(connectedRef, (snapshot) => {
                    const connected = snapshot.val() === true;
                    updateConnectionStatus(connected);

                    if (connected) {
                        console.log('Firebaseì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } else {
                        console.log('Firebase ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.');
                    }
                });

                console.log('Firebase ì´ˆê¸°í™” ì™„ë£Œ');

            } catch (error) {
                console.error('Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                updateConnectionStatus(false);
            }
        }
    </script>
</body>
</html>
