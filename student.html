<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìö ÌïôÏÉù Ï†êÏàò Ï°∞Ìöå</title>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue, set, push } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase ÏÑ§Ï†ï
        const firebaseConfig = {
            apiKey: "AIzaSyBqDemoApiKey123456789",
            authDomain: "student-scores-demo.firebaseapp.com",
            databaseURL: "https://student-scores-demo-default-rtdb.firebaseio.com",
            projectId: "student-scores-demo",
            storageBucket: "student-scores-demo.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456789"
        };

        // Firebase Ï¥àÍ∏∞Ìôî
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Ï†ÑÏó≠ÏóêÏÑú ÏÇ¨Ïö©Ìï† Ïàò ÏûàÎèÑÎ°ù window Í∞ùÏ≤¥Ïóê Ìï†Îãπ
        window.firebase = {
            database,
            ref,
            onValue,
            set,
            push
        };
    </script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }

        .header h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
        }

        .header p {
            margin: 0;
            opacity: 0.9;
            font-size: 16px;
        }

        .login-section {
            padding: 40px;
            text-align: center;
            background-color: #f8f9fa;
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .input-field {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .result-section {
            display: none;
            padding: 30px;
        }

        .student-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            text-align: center;
        }

        .subject-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .subject-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .subject-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin: 0;
        }

        .subject-content {
            padding: 20px;
        }

        .score-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        .score-table th, .score-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .score-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #495057;
        }

        .score-table .score-cell {
            font-weight: bold;
            color: #007bff;
            text-align: center;
        }

        .score-table .max-score-cell {
            text-align: center;
            color: #6c757d;
        }

        .total-row {
            background-color: #e3f2fd;
            font-weight: bold;
        }

        .area-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .area-checkbox input[type="checkbox"] {
            transform: scale(1.2);
        }

        .area-checkbox label {
            cursor: pointer;
            margin: 0;
        }

        .question-btn {
            background: #ffc107;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 10px;
        }

        .question-btn:hover {
            background: #e0a800;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-top: 15px;
        }

        .status-complete {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-progress {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-question {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .no-data h3 {
            margin: 0 0 10px 0;
            font-size: 24px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 30px 30px 20px 30px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
        }

        .modal-header h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 24px;
        }

        .modal-header p {
            margin: 0;
            font-size: 14px;
        }

        .modal-body {
            padding: 30px;
        }

        .modal-footer {
            padding: 20px 30px 30px 30px;
            text-align: center;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
        }

        .connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 24px;
            }

            .login-section {
                padding: 20px;
            }

            .subject-content {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Ïó∞Í≤∞ ÏÉÅÌÉú ÌëúÏãú -->
    <div id="connectionStatus" class="connection-status disconnected">
        üîÑ Ïó∞Í≤∞ Ï§ë...
    </div>

    <div class="container">
        <div class="header">
            <h1>üìö ÌïôÏÉù Ï†êÏàò Ï°∞Ìöå</h1>
            <p>Ïã§ÏãúÍ∞ÑÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏ÎêòÎäî ÏàòÌñâÌèâÍ∞Ä Ï†êÏàòÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî</p>
        </div>

        <!-- Î°úÍ∑∏Ïù∏ ÏÑπÏÖò -->
        <div id="loginSection" class="login-section">
            <div class="login-form">
                <h2 style="color: #333; margin-bottom: 30px;">üîê ÌïôÏÉù Î°úÍ∑∏Ïù∏</h2>

                <div class="input-group">
                    <label for="studentNumber">ÌïôÎ≤à (ÏïÑÏù¥Îîî)</label>
                    <input type="text"
                           id="studentNumber"
                           class="input-field"
                           placeholder="ÌïôÎ≤àÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Ïòà: 30101)"
                           maxlength="5">
                </div>

                <div class="input-group">
                    <label for="studentPassword">ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                    <input type="password"
                           id="studentPassword"
                           class="input-field"
                           placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                </div>

                <button id="loginBtn" class="btn" onclick="loginStudent()">
                    üìä Î°úÍ∑∏Ïù∏ÌïòÍ∏∞
                </button>

                <div style="margin-top: 20px; padding: 15px; background-color: #e9ecef; border-radius: 8px; text-align: left; font-size: 14px; color: #495057;">
                    <strong>üìã Î°úÍ∑∏Ïù∏ Ï†ïÎ≥¥:</strong><br>
                    ‚Ä¢ ÌïôÎ≤à: ÌïôÎÖÑ(1ÏûêÎ¶¨) + Î∞ò(2ÏûêÎ¶¨) + Î≤àÌò∏(2ÏûêÎ¶¨)<br>
                    ‚Ä¢ ÏòàÏãú: 3ÌïôÎÖÑ 1Î∞ò 1Î≤à ‚Üí 30101<br><br>
                    ‚Ä¢ Ï¥àÍ∏∞ ÎπÑÎ∞ÄÎ≤àÌò∏: 0123<br>
                    ‚Ä¢ ‚ö†Ô∏è Ï≤´ Î°úÍ∑∏Ïù∏ Ïãú Î∞òÎìúÏãú ÎπÑÎ∞ÄÎ≤àÌò∏Î•º Î≥ÄÍ≤ΩÌï¥Ïïº Ìï©ÎãàÎã§<br>
                    ‚Ä¢ ÏÑ±Ï†Å Î≥¥ÏïàÏùÑ ÏúÑÌï¥ Í∞úÏù∏Îßå ÏïÑÎäî ÎπÑÎ∞ÄÎ≤àÌò∏Î°ú ÏÑ§Ï†ïÌïòÏÑ∏Ïöî
                </div>
            </div>
        </div>

        <!-- Í≤∞Í≥º ÏÑπÏÖò -->
        <div id="resultSection" class="result-section">
            <div id="studentInfo" class="student-info">
                <!-- ÌïôÏÉù Ï†ïÎ≥¥Í∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
            </div>

            <div id="scoresContainer">
                <!-- Ï†êÏàò Ïπ¥ÎìúÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" onclick="logout()" style="width: auto; padding: 10px 30px;">
                    üîÑ Îã§Î•∏ ÌïôÎ≤àÏúºÎ°ú Ï°∞Ìöå
                </button>
            </div>
        </div>

        <!-- Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå -->
        <div id="noDataSection" class="no-data" style="display: none;">
            <h3>üìö Ï°∞Ìöå Í∞ÄÎä•Ìïú Ï†êÏàòÍ∞Ä ÏóÜÏäµÎãàÎã§</h3>
            <p>ÏÑ†ÏÉùÎãòÏù¥ ÏïÑÏßÅ Ï†êÏàòÎ•º Îì±Î°ùÌïòÏßÄ ÏïäÏïòÍ±∞ÎÇò<br>Ìï¥Îãπ ÌïôÎ≤àÏù¥ Îì±Î°ùÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.</p>
            <button class="btn" onclick="logout()" style="width: auto; padding: 10px 30px; margin-top: 20px;">
                üîÑ Îã§Ïãú ÏãúÎèÑ
            </button>
        </div>

        <!-- Î°úÎî© -->
        <div id="loadingSection" class="loading" style="display: none;">
            <h3>üîÑ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</h3>
        </div>

        <!-- ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω Î™®Îã¨ -->
        <div id="passwordChangeModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üîê ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω ÌïÑÏàò</h3>
                    <p style="color: #dc3545; font-weight: bold;">Î≥¥ÏïàÏùÑ ÏúÑÌï¥ Ï≤´ Î°úÍ∑∏Ïù∏ Ïãú ÎπÑÎ∞ÄÎ≤àÌò∏Î•º Î∞òÎìúÏãú Î≥ÄÍ≤ΩÌï¥Ïïº Ìï©ÎãàÎã§.</p>
                </div>
                <div class="modal-body">
                    <div class="input-group">
                        <label for="currentPassword">ÌòÑÏû¨ ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                        <input type="password" id="currentPassword" class="input-field" value="0123" readonly style="background-color: #f8f9fa;">
                    </div>
                    <div class="input-group">
                        <label for="newPassword">ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                        <input type="password" id="newPassword" class="input-field" placeholder="ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî (4ÏûêÎ¶¨ Ïù¥ÏÉÅ)">
                    </div>
                    <div class="input-group">
                        <label for="confirmPassword">ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏</label>
                        <input type="password" id="confirmPassword" class="input-field" placeholder="ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏Î•º Îã§Ïãú ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                    </div>
                    <div style="background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 15px; margin: 15px 0; color: #856404; font-size: 14px;">
                        <strong>‚ö†Ô∏è Ï£ºÏùòÏÇ¨Ìï≠:</strong><br>
                        ‚Ä¢ ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 4ÏûêÎ¶¨ Ïù¥ÏÉÅÏúºÎ°ú ÏÑ§Ï†ïÌïòÏÑ∏Ïöî<br>
                        ‚Ä¢ Îã§Î•∏ ÌïôÏÉùÏù¥ Ï∂îÏ∏°ÌïòÍ∏∞ Ïñ¥Î†§Ïö¥ Î≤àÌò∏Î°ú ÏÑ§Ï†ïÌïòÏÑ∏Ïöî<br>
                        ‚Ä¢ ÏÉùÎÖÑÏõîÏùº, Ï†ÑÌôîÎ≤àÌò∏ Îì± Í∞úÏù∏Ï†ïÎ≥¥ ÏÇ¨Ïö©ÏùÄ ÌîºÌïòÏÑ∏Ïöî<br>
                        ‚Ä¢ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûäÏñ¥Î≤ÑÎ¶¨Î©¥ Îã¥ÏûÑÏÑ†ÏÉùÎãòÍªò Î¨∏ÏùòÌïòÏÑ∏Ïöî
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="changePasswordBtn" class="btn" onclick="changePassword()">
                        ‚úÖ ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let currentStudent = null;
        let isConnected = false;
        let dataListeners = []; // Îç∞Ïù¥ÌÑ∞ Î¶¨Ïä§ÎÑàÎì§ÏùÑ Ï†ÄÏû•

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        window.onload = function() {
            setupEventListeners();

            // FirebaseÍ∞Ä Î°úÎìúÎê† ÎïåÍπåÏßÄ Í∏∞Îã§Î¶º
            const checkFirebase = setInterval(() => {
                if (window.firebase) {
                    clearInterval(checkFirebase);
                    initializeFirebase();
                }
            }, 100);
        };

        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
        function setupEventListeners() {
            // Enter ÌÇ§Î°ú Î°úÍ∑∏Ïù∏
            document.getElementById('studentNumber').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('studentPassword').focus();
                }
            });

            document.getElementById('studentPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loginStudent();
                }
            });

            // ÌïôÎ≤à ÏûÖÎ†• Ïãú Ïà´ÏûêÎßå ÌóàÏö©
            document.getElementById('studentNumber').addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
            });

            // ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω Î™®Îã¨ Ïù¥Î≤§Ìä∏
            document.getElementById('newPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('confirmPassword').focus();
                }
            });

            document.getElementById('confirmPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    changePassword();
                }
            });
        }

        // ÌïôÎ≤à Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
        function validateStudentNumber(studentNumber) {
            if (!studentNumber || studentNumber.length !== 5) {
                return false;
            }

            const grade = parseInt(studentNumber.substring(0, 1));
            const classNum = parseInt(studentNumber.substring(1, 3));
            const number = parseInt(studentNumber.substring(3, 5));

            return grade >= 1 && grade <= 3 &&
                   classNum >= 1 && classNum <= 20 &&
                   number >= 1 && number <= 40;
        }

        // ÌïôÏÉù Î°úÍ∑∏Ïù∏
        function loginStudent() {
            const studentNumber = document.getElementById('studentNumber').value.trim();
            const password = document.getElementById('studentPassword').value.trim();

            if (!validateStudentNumber(studentNumber)) {
                alert('Ïò¨Î∞îÎ•∏ ÌïôÎ≤àÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.\nÌòïÏãù: ÌïôÎÖÑ(1ÏûêÎ¶¨) + Î∞ò(2ÏûêÎ¶¨) + Î≤àÌò∏(2ÏûêÎ¶¨)\nÏòàÏãú: 30101');
                return;
            }

            if (!password) {
                alert('ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            showLoading();

            // ÎπÑÎ∞ÄÎ≤àÌò∏ Í≤ÄÏ¶ù ÌõÑ ÌïôÏÉù Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå
            setTimeout(() => {
                authenticateAndLoadStudent(studentNumber, password);
            }, 1000);
        }

        // ÎπÑÎ∞ÄÎ≤àÌò∏ Ïù∏Ï¶ù Î∞è ÌïôÏÉù Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        function authenticateAndLoadStudent(studentNumber, password) {
            if (!window.firebase) {
                alert('Firebase Ïó∞Í≤∞Ïù¥ Ï§ÄÎπÑÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                logout();
                return;
            }

            // FirebaseÏóêÏÑú ÌïôÏÉù Ï†ïÎ≥¥ Î∞è ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏
            const studentRef = window.firebase.ref(window.firebase.database, `students/${studentNumber}`);
            window.firebase.onValue(studentRef, (snapshot) => {
                const studentData = snapshot.val();

                if (!studentData) {
                    hideLoading();
                    alert('Îì±Î°ùÎêòÏßÄ ÏïäÏùÄ ÌïôÎ≤àÏûÖÎãàÎã§.\nÎã¥ÏûÑÏÑ†ÏÉùÎãòÍªò Î¨∏ÏùòÌïòÏÑ∏Ïöî.');
                    return;
                }

                // ÎπÑÎ∞ÄÎ≤àÌò∏ Í≤ÄÏ¶ù
                const storedPassword = studentData.password || generateDefaultPassword(studentNumber);

                if (password !== storedPassword) {
                    hideLoading();
                    alert('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏûòÎ™ªÎêòÏóàÏäµÎãàÎã§.\nÏ¥àÍ∏∞ ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 0123ÏûÖÎãàÎã§.');
                    return;
                }

                // Ï¥àÍ∏∞ ÎπÑÎ∞ÄÎ≤àÌò∏Ïù∏ Í≤ΩÏö∞ Í∞ïÏ†ú Î≥ÄÍ≤Ω
                if (storedPassword === '0123') {
                    hideLoading();
                    showPasswordChangeModal(studentNumber);
                    return;
                }

                // Ïù∏Ï¶ù ÏÑ±Í≥µ - ÌïôÏÉù Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                loadStudentData(studentNumber);
            }, {
                onlyOnce: true // Ìïú Î≤àÎßå Ïã§Ìñâ
            });
        }

        // Í∏∞Î≥∏ ÎπÑÎ∞ÄÎ≤àÌò∏ ÏÉùÏÑ±
        function generateDefaultPassword(studentNumber) {
            return '0123'; // Î™®Îì† ÌïôÏÉùÏùò Ï¥àÍ∏∞ ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 0123
        }

        // ÌïôÏÉù Îç∞Ïù¥ÌÑ∞ Î°úÎìú (FirebaseÏóêÏÑú Ïã§ÏãúÍ∞ÑÏúºÎ°ú)
        function loadStudentData(studentNumber) {
            if (!window.firebase) {
                alert('Firebase Ïó∞Í≤∞Ïù¥ Ï§ÄÎπÑÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                logout();
                return;
            }

            const { database, ref, onValue } = window.firebase;

            try {
                // Î®ºÏ†Ä ÌïôÏÉù Ï†ïÎ≥¥ ÌôïÏù∏
                const studentRef = ref(database, `students/${studentNumber}`);
                onValue(studentRef, (snapshot) => {
                    const studentData = snapshot.val();

                    if (!studentData) {
                        showNoData();
                        return;
                    }

                    // ÌïôÏÉù Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï
                    currentStudent = {
                        student: {
                            number: studentNumber,
                            name: studentData.name,
                            grade: studentData.grade,
                            class: studentData.class
                        },
                        subjects: {}
                    };

                    // Î∞úÌñâÎêú Í≥ºÎ™©Îì§ Î°úÎìú
                    loadPublishedSubjects(studentNumber);
                }, (error) => {
                    console.error('ÌïôÏÉù Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïò§Î•ò:', error);
                    showNoData();
                });

            } catch (error) {
                console.error('Firebase Ïò§Î•ò:', error);
                showNoData();
            }
        }

        // Î∞úÌñâÎêú Í≥ºÎ™©Îì§ Î°úÎìú
        function loadPublishedSubjects(studentNumber) {
            const { database, ref, onValue } = window.firebase;

            // Î∞úÌñâÎêú Í≥ºÎ™© Î™©Î°ù Ï°∞Ìöå
            const publishedRef = ref(database, 'publishedSubjects');
            onValue(publishedRef, (snapshot) => {
                const publishedSubjects = snapshot.val() || {};

                // Í≥ºÎ™© Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                loadSubjectsData(studentNumber, publishedSubjects);
            });
        }

        // Í≥ºÎ™© Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        function loadSubjectsData(studentNumber, publishedSubjects) {
            const { database, ref, onValue } = window.firebase;

            // Î∞úÌñâÎêú Í≥ºÎ™©Îßå ÌïÑÌÑ∞ÎßÅ
            const publishedKeys = Object.keys(publishedSubjects).filter(key => publishedSubjects[key] === true);

            if (publishedKeys.length === 0) {
                showNoData();
                return;
            }

            let loadedCount = 0;
            currentStudent.subjects = {};

            publishedKeys.forEach(subjectKey => {
                // Í≥ºÎ™© Ï†ïÎ≥¥ Î°úÎìú
                const subjectRef = ref(database, `subjects/${subjectKey}`);
                onValue(subjectRef, (snapshot) => {
                    const subjectData = snapshot.val();

                    if (subjectData) {
                        currentStudent.subjects[subjectKey] = {
                            name: subjectData.name,
                            grade: subjectData.grade,
                            areas: subjectData.areas || [],
                            scores: {},
                            checked: {},
                            questions: {}
                        };

                        // Ï†êÏàò Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                        loadScoreData(studentNumber, subjectKey);

                        // Ï≤¥ÌÅ¨ ÏÉÅÌÉú Î°úÎìú
                        loadCheckedData(studentNumber, subjectKey);

                        // ÏùòÎ¨∏ÏÇ¨Ìï≠ Î°úÎìú
                        loadQuestionData(studentNumber, subjectKey);
                    }

                    loadedCount++;
                    if (loadedCount === publishedKeys.length) {
                        showResults();
                    }
                });
            });
        }

        // Ï†êÏàò Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        function loadScoreData(studentNumber, subjectKey) {
            const { database, ref, onValue } = window.firebase;

            const scoreRef = ref(database, `scores/${subjectKey}/${studentNumber}`);
            const listener = onValue(scoreRef, (snapshot) => {
                const scoreData = snapshot.val() || {};

                if (currentStudent.subjects[subjectKey]) {
                    currentStudent.subjects[subjectKey].scores = scoreData;
                    updateScoresDisplay();
                }
            });

            dataListeners.push(listener);
        }

        // Ï≤¥ÌÅ¨ ÏÉÅÌÉú Î°úÎìú
        function loadCheckedData(studentNumber, subjectKey) {
            const { database, ref, onValue } = window.firebase;

            const checkedRef = ref(database, `studentChecked/${subjectKey}/${studentNumber}`);
            const listener = onValue(checkedRef, (snapshot) => {
                const checkedData = snapshot.val() || {};

                if (currentStudent.subjects[subjectKey]) {
                    currentStudent.subjects[subjectKey].checked = checkedData;
                    updateScoresDisplay();
                }
            });

            dataListeners.push(listener);
        }

        // ÏùòÎ¨∏ÏÇ¨Ìï≠ Î°úÎìú
        function loadQuestionData(studentNumber, subjectKey) {
            const { database, ref, onValue } = window.firebase;

            const questionRef = ref(database, `studentQuestions/${subjectKey}/${studentNumber}`);
            const listener = onValue(questionRef, (snapshot) => {
                const questionData = snapshot.val() || {};

                if (currentStudent.subjects[subjectKey]) {
                    currentStudent.subjects[subjectKey].questions = questionData;
                    updateScoresDisplay();
                }
            });

            dataListeners.push(listener);
        }

        // Í≤∞Í≥º ÌëúÏãú
        function showResults() {
            hideAllSections();
            document.getElementById('resultSection').style.display = 'block';

            updateStudentInfo();
            updateScoresDisplay();
        }

        // ÌïôÏÉù Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
        function updateStudentInfo() {
            const student = currentStudent.student;
            document.getElementById('studentInfo').innerHTML = `
                <h2>üéâ ${student.name} (${student.number})</h2>
                <p>${student.grade}ÌïôÎÖÑ ${student.class}Î∞ò ${student.number.substring(3)}Î≤à</p>
            `;
        }

        // Ï†êÏàò ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
        function updateScoresDisplay() {
            const container = document.getElementById('scoresContainer');
            const subjects = currentStudent.subjects;

            if (Object.keys(subjects).length === 0) {
                container.innerHTML = '<div class="no-data"><h3>üìö Îì±Î°ùÎêú Ï†êÏàòÍ∞Ä ÏóÜÏäµÎãàÎã§</h3></div>';
                return;
            }

            let html = '';
            Object.keys(subjects).forEach(subjectKey => {
                const subject = subjects[subjectKey];
                html += createSubjectCard(subjectKey, subject);
            });

            container.innerHTML = html;
        }

        // Í≥ºÎ™© Ïπ¥Îìú ÏÉùÏÑ±
        function createSubjectCard(subjectKey, subject) {
            let totalScore = 0;
            let maxTotalScore = 0;
            let checkedAreas = 0;
            let questionCount = 0;

            let tableRows = '';
            subject.areas.forEach(area => {
                const score = subject.scores[area.name] || 0;
                const isChecked = subject.checked[area.name] || false;
                const hasQuestion = subject.questions[area.name];

                totalScore += score;
                maxTotalScore += area.maxScore;
                if (isChecked) checkedAreas++;
                if (hasQuestion) questionCount++;

                tableRows += `
                    <tr>
                        <td>
                            ${area.name}
                            <div class="area-checkbox">
                                <input type="checkbox" id="check_${subjectKey}_${area.name}"
                                       ${isChecked ? 'checked' : ''}
                                       onchange="markAreaAsChecked('${subjectKey}', '${area.name}')">
                                <label for="check_${subjectKey}_${area.name}">ÌôïÏù∏ÏôÑÎ£å</label>
                            </div>
                        </td>
                        <td class="score-cell">
                            ${score}Ï†ê
                            <button class="question-btn" onclick="askQuestion('${subjectKey}', '${area.name}', ${score})">?</button>
                        </td>
                        <td class="max-score-cell">${area.maxScore}Ï†ê</td>
                    </tr>
                `;
            });

            // ÏÉÅÌÉú Î±ÉÏßÄ
            let statusBadge = '';
            if (questionCount > 0) {
                statusBadge = `<div class="status-badge status-question">‚ùì ÏùòÎ¨∏ÏÇ¨Ìï≠ ${questionCount}Í±¥</div>`;
            } else if (checkedAreas === subject.areas.length) {
                statusBadge = `<div class="status-badge status-complete">‚úÖ Î™®Îì† ÏòÅÏó≠ ÌôïÏù∏ ÏôÑÎ£å</div>`;
            } else {
                statusBadge = `<div class="status-badge status-progress">‚è≥ ÌôïÏù∏ ÏßÑÌñâ Ï§ë (${checkedAreas}/${subject.areas.length})</div>`;
            }

            return `
                <div class="subject-card">
                    <div class="subject-header">
                        <h3 class="subject-title">${subject.grade}ÌïôÎÖÑ ${subject.name}</h3>
                    </div>
                    <div class="subject-content">
                        <table class="score-table">
                            <thead>
                                <tr>
                                    <th>ÏòÅÏó≠</th>
                                    <th style="text-align: center;">Ï†êÏàò</th>
                                    <th style="text-align: center;">ÎßåÏ†ê</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                                <tr class="total-row">
                                    <td><strong>Ï¥ùÏ†ê</strong></td>
                                    <td class="score-cell"><strong>${totalScore}Ï†ê</strong></td>
                                    <td class="max-score-cell"><strong>${maxTotalScore}Ï†ê</strong></td>
                                </tr>
                            </tbody>
                        </table>
                        ${statusBadge}
                    </div>
                </div>
            `;
        }

        // ÏòÅÏó≠ ÌôïÏù∏ ÌëúÏãú
        function markAreaAsChecked(subjectKey, areaName) {
            const checkbox = document.getElementById(`check_${subjectKey}_${areaName}`);

            if (currentStudent.subjects[subjectKey]) {
                currentStudent.subjects[subjectKey].checked[areaName] = checkbox.checked;

                // ÌååÏù¥Ïñ¥Î≤†Ïù¥Ïä§Ïóê Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏
                updateCheckedStatus(subjectKey, areaName, checkbox.checked);
            }
        }

        // ÏùòÎ¨∏ÏÇ¨Ìï≠ Ï†úÍ∏∞
        function askQuestion(subjectKey, areaName, score) {
            const subject = currentStudent.subjects[subjectKey];
            const question = prompt(`üìù ${subject.grade}ÌïôÎÖÑ ${subject.name} > ${areaName} (${score}Ï†ê)\n\nÍ∂ÅÍ∏àÌïú Ï†êÏù¥ÎÇò ÏùòÎ¨∏ÏÇ¨Ìï≠ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:`);

            if (question && question.trim()) {
                subject.questions[areaName] = question.trim();

                // ÌååÏù¥Ïñ¥Î≤†Ïù¥Ïä§Ïóê Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏
                updateQuestionData(subjectKey, areaName, question.trim());

                alert(`üì© ÏùòÎ¨∏ÏÇ¨Ìï≠Ïù¥ ÏÑ†ÏÉùÎãòÍªò Ï†ÑÎã¨ÎêòÏóàÏäµÎãàÎã§.\n\n${areaName}: ${question.trim()}`);
            }
        }

        // Ï≤¥ÌÅ¨ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        function updateCheckedStatus(subjectKey, areaName, checked) {
            if (!window.firebase || !currentStudent) return;

            const { database, ref, set } = window.firebase;
            const studentNumber = currentStudent.student.number;

            const checkedRef = ref(database, `studentChecked/${subjectKey}/${studentNumber}/${areaName}`);
            set(checkedRef, checked).catch(error => {
                console.error('Ï≤¥ÌÅ¨ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:', error);
            });
        }

        // ÏùòÎ¨∏ÏÇ¨Ìï≠ ÏóÖÎç∞Ïù¥Ìä∏
        function updateQuestionData(subjectKey, areaName, question) {
            if (!window.firebase || !currentStudent) return;

            const { database, ref, set } = window.firebase;
            const studentNumber = currentStudent.student.number;

            const questionRef = ref(database, `studentQuestions/${subjectKey}/${studentNumber}/${areaName}`);
            set(questionRef, question).catch(error => {
                console.error('ÏùòÎ¨∏ÏÇ¨Ìï≠ ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:', error);
            });
        }

        // ÏÑπÏÖò ÌëúÏãú Í¥ÄÎ¶¨
        function showLoading() {
            hideAllSections();
            document.getElementById('loadingSection').style.display = 'block';
        }

        function showNoData() {
            hideAllSections();
            document.getElementById('noDataSection').style.display = 'block';
        }

        function hideAllSections() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('noDataSection').style.display = 'none';
            document.getElementById('loadingSection').style.display = 'none';
        }

        function logout() {
            // Î™®Îì† Firebase Î¶¨Ïä§ÎÑà Ï†ïÎ¶¨
            dataListeners.forEach(listener => {
                if (typeof listener === 'function') {
                    listener(); // Î¶¨Ïä§ÎÑà Ìï¥Ï†ú
                }
            });
            dataListeners = [];

            currentStudent = null;
            document.getElementById('studentNumber').value = '';
            document.getElementById('studentPassword').value = '';
            hideAllSections();
            document.getElementById('loginSection').style.display = 'block';
        }

        // ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω Î™®Îã¨ ÌëúÏãú
        function showPasswordChangeModal(studentNumber) {
            currentStudent = { studentNumber }; // ÏûÑÏãúÎ°ú ÌïôÎ≤à Ï†ÄÏû•
            document.getElementById('passwordChangeModal').style.display = 'flex';
            document.getElementById('newPassword').focus();
        }

        // ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω
        function changePassword() {
            const newPassword = document.getElementById('newPassword').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();

            if (!newPassword) {
                alert('ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            if (newPassword.length < 4) {
                alert('ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 4ÏûêÎ¶¨ Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§.');
                return;
            }

            if (newPassword === '0123') {
                alert('Ï¥àÍ∏∞ ÎπÑÎ∞ÄÎ≤àÌò∏ÏôÄ Í∞ôÏùÄ ÎπÑÎ∞ÄÎ≤àÌò∏Îäî ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§.\nÎ≥¥ÏïàÏùÑ ÏúÑÌï¥ Îã§Î•∏ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
                return;
            }

            if (!window.firebase) {
                alert('Ïó∞Í≤∞ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            // FirebaseÏóêÏÑú ÎπÑÎ∞ÄÎ≤àÌò∏ ÏóÖÎç∞Ïù¥Ìä∏
            const studentRef = window.firebase.ref(window.firebase.database, `students/${currentStudent.studentNumber}/password`);
            window.firebase.set(studentRef, newPassword).then(() => {
                // Î™®Îã¨ Îã´Í∏∞
                document.getElementById('passwordChangeModal').style.display = 'none';

                // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';

                alert('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§!\nÏù¥Ï†ú Ï†êÏàòÎ•º Ï°∞ÌöåÌï† Ïàò ÏûàÏäµÎãàÎã§.');

                // ÌïôÏÉù Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                showLoading();
                setTimeout(() => {
                    loadStudentData(currentStudent.studentNumber);
                }, 500);

            }).catch(error => {
                console.error('ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω Ïò§Î•ò:', error);
                alert('ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
            });
        }

        // Ïó∞Í≤∞ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        function updateConnectionStatus(connected) {
            isConnected = connected;
            const statusElement = document.getElementById('connectionStatus');

            if (connected) {
                statusElement.className = 'connection-status connected';
                statusElement.textContent = 'üü¢ Ïã§ÏãúÍ∞Ñ Ïó∞Í≤∞Îê®';
            } else {
                statusElement.className = 'connection-status disconnected';
                statusElement.textContent = 'üî¥ Ïó∞Í≤∞ ÎÅäÍπÄ';
            }
        }

        // ÌååÏù¥Ïñ¥Î≤†Ïù¥Ïä§ Ï¥àÍ∏∞Ìôî
        function initializeFirebase() {
            console.log('Firebase Ï¥àÍ∏∞Ìôî Ï§ë...');

            if (!window.firebase) {
                console.error('FirebaseÍ∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                updateConnectionStatus(false);
                return;
            }

            try {
                const { database, ref, onValue } = window.firebase;

                // Ïó∞Í≤∞ ÏÉÅÌÉú Î™®ÎãàÌÑ∞ÎßÅ
                const connectedRef = ref(database, '.info/connected');
                onValue(connectedRef, (snapshot) => {
                    const connected = snapshot.val() === true;
                    updateConnectionStatus(connected);

                    if (connected) {
                        console.log('FirebaseÏóê Ïó∞Í≤∞ÎêòÏóàÏäµÎãàÎã§.');
                    } else {
                        console.log('Firebase Ïó∞Í≤∞Ïù¥ ÎÅäÏñ¥Ï°åÏäµÎãàÎã§.');
                    }
                });

                console.log('Firebase Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');

            } catch (error) {
                console.error('Firebase Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', error);
                updateConnectionStatus(false);
            }
        }
    </script>
</body>
</html>
