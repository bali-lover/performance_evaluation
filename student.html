<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com https://*.firebasedatabase.app https://*.firebaseapp.com https://*.googleapis.com; style-src 'self' 'unsafe-inline'; img-src * data: blob:; connect-src 'self' https: wss: https://*.firebasedatabase.app https://*.firebaseapp.com https://*.googleapis.com;">
    <title>ğŸ“š í•™ìƒ ì ìˆ˜ ì¡°íšŒ v2 - Firebase ì—°ê²° í…ŒìŠ¤íŠ¸</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }

        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }

        .config-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
    </style>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        let app = null;
        let database = null;

        // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // URL íŒŒë¼ë¯¸í„°ì—ì„œ Firebase ì„¤ì • ì½ê¸°
        function getFirebaseConfigFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const apiKey = urlParams.get('apiKey');
            const projectId = urlParams.get('projectId');

            if (apiKey && projectId) {
                return {
                    apiKey: apiKey,
                    authDomain: `${projectId}.firebaseapp.com`,
                    databaseURL: `https://${projectId}-default-rtdb.asia-southeast1.firebasedatabase.app/`,
                    projectId: projectId,
                    storageBucket: `${projectId}.appspot.com`
                };
            }
            return null;
        }

        // Firebase ì´ˆê¸°í™” ë° ì—°ê²° í…ŒìŠ¤íŠ¸
        async function testFirebaseConnection() {
            try {
                showStatus('ğŸ”„ Firebase ì—°ê²° ì‹œë„ ì¤‘...', 'info');

                // URL íŒŒë¼ë¯¸í„° í™•ì¸
                const config = getFirebaseConfigFromURL();
                if (!config) {
                    showStatus('âŒ URL íŒŒë¼ë¯¸í„°ì— apiKey ë˜ëŠ” projectIdê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return false;
                }

                // ì„¤ì • ì •ë³´ í‘œì‹œ
                document.getElementById('config').innerHTML =
                    `<strong>Firebase ì„¤ì •:</strong><br>
                     API Key: ${config.apiKey}<br>
                     Project ID: ${config.projectId}<br>
                     Database URL: ${config.databaseURL}`;

                // Firebase ì•± ì´ˆê¸°í™”
                app = initializeApp(config);
                database = getDatabase(app);

                showStatus('âœ… Firebase ì´ˆê¸°í™” ì„±ê³µ!', 'success');

                // ì—°ê²° í…ŒìŠ¤íŠ¸
                const testRef = ref(database, '.info/connected');
                onValue(testRef, (snapshot) => {
                    if (snapshot.val() === true) {
                        showStatus('ğŸ‰ Firebase ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„±ê³µ!', 'success');
                        // ì—°ê²° ì„±ê³µì‹œ ë¡œê·¸ì¸ í¼ í‘œì‹œ
                        document.getElementById('loginSection').style.display = 'block';
                    } else {
                        showStatus('âš ï¸ Firebase ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì´ ëŠì–´ì§', 'warning');
                    }
                });

                return true;

            } catch (error) {
                console.error('Firebase ì˜¤ë¥˜:', error);
                showStatus(`âŒ Firebase ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
                return false;
            }
        }

        // í•™ìƒ ë¡œê·¸ì¸
        async function loginStudent() {
            const studentNumber = document.getElementById('studentNumber').value;
            const studentPassword = document.getElementById('studentPassword').value;

            if (!studentNumber) {
                showStatus('âŒ í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”.', 'error');
                return;
            }

            if (!studentPassword) {
                showStatus('âŒ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'error');
                return;
            }

            try {
                showStatus('ğŸ”„ ë¡œê·¸ì¸ ì¤‘...', 'info');

                // í•™ìƒ ì •ë³´ í™•ì¸
                const studentsRef = ref(database, `students/${studentNumber}`);
                onValue(studentsRef, (snapshot) => {
                    const student = snapshot.val();

                    if (!student) {
                        showStatus('âŒ ë“±ë¡ë˜ì§€ ì•Šì€ í•™ë²ˆì…ë‹ˆë‹¤.', 'error');
                        return;
                    }

                    if (student.password !== studentPassword) {
                        showStatus('âŒ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.', 'error');
                        return;
                    }

                    // ë¡œê·¸ì¸ ì„±ê³µ
                    showStatus(`âœ… í™˜ì˜í•©ë‹ˆë‹¤, ${student.name}ë‹˜!`, 'success');
                    console.log('ë¡œê·¸ì¸ ì„±ê³µ:', student);

                    // ì ìˆ˜ ì¡°íšŒ
                    loadStudentScores(studentNumber, student.name);

                }, { onlyOnce: true });

            } catch (error) {
                console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
                showStatus(`âŒ ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // í•™ìƒ ì ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadStudentScores(studentNumber, studentName) {
            try {
                showStatus('ğŸ”„ ì ìˆ˜ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'info');

                // ì ìˆ˜ ì„¹ì…˜ í‘œì‹œ
                document.getElementById('scoresSection').style.display = 'block';

                // ê³¼ëª©ê³¼ ì ìˆ˜ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                const subjectsRef = ref(database, 'subjects');
                const scoresRef = ref(database, 'scores');

                Promise.all([
                    new Promise((resolve) => {
                        onValue(subjectsRef, (snapshot) => {
                            resolve(snapshot.val() || {});
                        }, { onlyOnce: true });
                    }),
                    new Promise((resolve) => {
                        onValue(scoresRef, (snapshot) => {
                            resolve(snapshot.val() || {});
                        }, { onlyOnce: true });
                    })
                ]).then(([subjects, scores]) => {
                    displayStudentScores(studentNumber, studentName, subjects, scores);
                });

            } catch (error) {
                console.error('ì ìˆ˜ ë¡œë”© ì˜¤ë¥˜:', error);
                showStatus(`âŒ ì ìˆ˜ ë¡œë”© ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // ì ìˆ˜ í‘œì‹œ
        function displayStudentScores(studentNumber, studentName, subjects, scores) {
            const scoresContent = document.getElementById('scoresContent');

            let hasScores = false;
            let html = `<div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 5px;">
                           <strong>ğŸ‘¤ ${studentName} (${studentNumber}ë²ˆ)</strong>
                       </div>`;

            // ê° ê³¼ëª©ë³„ ì ìˆ˜ í‘œì‹œ
            for (const subjectKey in subjects) {
                const subject = subjects[subjectKey];
                const subjectScores = scores[subjectKey];
                const studentScore = subjectScores && subjectScores[studentNumber];

                html += `<div style="margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: white;">
                           <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                               <strong style="font-size: 16px;">${subject.name || subjectKey}</strong>
                               <span style="font-size: 14px; color: #666;">ë§Œì : ${subject.maxScore || 'ë¯¸ì„¤ì •'}ì </span>
                           </div>`;

                if (subject.areas && subject.areas.length > 0) {
                    // ì˜ì—­ë³„ ì ìˆ˜ í‘œì‹œ
                    subject.areas.forEach((area, index) => {
                        const areaScore = studentScore && studentScore[area.name];
                        const scoreText = areaScore ? `${areaScore}ì ` : 'ë¯¸ì…ë ¥';
                        const scoreColor = areaScore ? '#28a745' : '#6c757d';

                        html += `<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                                   <span>${area.name}</span>
                                   <span style="color: ${scoreColor}; font-weight: bold;">${scoreText} / ${area.maxScore}ì </span>
                                 </div>`;

                        if (areaScore) hasScores = true;
                    });
                } else {
                    // ë‹¨ì¼ ì ìˆ˜ í‘œì‹œ
                    const totalScore = studentScore && studentScore.score;
                    const scoreText = totalScore ? `${totalScore}ì ` : 'ë¯¸ì…ë ¥';
                    const scoreColor = totalScore ? '#28a745' : '#6c757d';

                    html += `<div style="text-align: center; font-size: 18px; color: ${scoreColor}; font-weight: bold;">
                               ${scoreText}
                             </div>`;

                    if (totalScore) hasScores = true;
                }

                html += `</div>`;
            }

            if (!hasScores) {
                html += `<div style="text-align: center; color: #999; font-style: italic; padding: 30px;">
                           ì•„ì§ ì…ë ¥ëœ ì ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.<br>
                           ì„ ìƒë‹˜ì´ ì ìˆ˜ë¥¼ ì…ë ¥í•  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.
                         </div>`;
            }

            scoresContent.innerHTML = html;
            showStatus(`âœ… ì ìˆ˜ ì¡°íšŒ ì™„ë£Œ!`, 'success');
        }

        // Firebase ë°ì´í„° êµ¬ì¡° ë””ë²„ê·¸
        function debugFirebaseData() {
            if (!database) {
                showStatus('âŒ Firebaseê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            showStatus('ğŸ” Firebase ë°ì´í„° êµ¬ì¡°ë¥¼ í™•ì¸í•˜ëŠ” ì¤‘...', 'info');

            // ì „ì²´ ë°ì´í„° êµ¬ì¡° í™•ì¸
            const rootRef = ref(database, '/');
            onValue(rootRef, (snapshot) => {
                const data = snapshot.val();
                console.log('=== Firebase ì „ì²´ ë°ì´í„° ===');
                console.log(data);

                let debugHtml = '<h4>ğŸ” Firebase ë°ì´í„° êµ¬ì¡°</h4>';
                debugHtml += '<pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px;">';
                debugHtml += JSON.stringify(data, null, 2);
                debugHtml += '</pre>';

                // ê¸°ì¡´ ì ìˆ˜ í‘œì‹œ ì˜ì—­ì— ë””ë²„ê·¸ ì •ë³´ í‘œì‹œ
                const scoresSection = document.getElementById('scoresSection');
                scoresSection.style.display = 'block';
                document.getElementById('scoresContent').innerHTML = debugHtml;

                showStatus('âœ… ë°ì´í„° êµ¬ì¡° í™•ì¸ ì™„ë£Œ! ì½˜ì†”ê³¼ í™”ë©´ì„ í™•ì¸í•˜ì„¸ìš”.', 'success');
            }, { onlyOnce: true });
        }

        // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ
        window.loginStudent = loginStudent;
        window.debugFirebaseData = debugFirebaseData;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.addEventListener('DOMContentLoaded', () => {
            testFirebaseConnection();
        });

    </script>
</head>
<body>
    <div class="container">
        <h1>ğŸ“š í•™ìƒ ì ìˆ˜ ì¡°íšŒ v2</h1>
        <h2>Firebase ì—°ê²° í…ŒìŠ¤íŠ¸</h2>

        <div id="status">
            <div class="status info">ğŸ”„ í˜ì´ì§€ ë¡œë”© ì¤‘...</div>
        </div>

        <div id="config" class="config-info">
            ì„¤ì • ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
        </div>

        <!-- í•™ìƒ ë¡œê·¸ì¸ í¼ -->
        <div id="loginSection" style="display: none; margin-top: 30px;">
            <hr>
            <h3>ğŸ“ í•™ìƒ ë¡œê·¸ì¸</h3>

            <div style="margin: 15px 0;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">í•™ë²ˆ:</label>
                <input type="number" id="studentNumber" placeholder="í•™ë²ˆ ì…ë ¥"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div style="margin: 15px 0;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">ë¹„ë°€ë²ˆí˜¸:</label>
                <input type="password" id="studentPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <button onclick="loginStudent()"
                    style="background: #007bff; color: white; border: none; padding: 12px 24px;
                           border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%; margin-bottom: 10px;">
                ğŸ“Š ì ìˆ˜ í™•ì¸
            </button>

            <button onclick="debugFirebaseData()"
                    style="background: #28a745; color: white; border: none; padding: 8px 16px;
                           border-radius: 4px; cursor: pointer; font-size: 14px; width: 100%;">
                ğŸ” Firebase ë°ì´í„° êµ¬ì¡° í™•ì¸
            </button>
        </div>

        <!-- ì ìˆ˜ í‘œì‹œ ì˜ì—­ -->
        <div id="scoresSection" style="display: none; margin-top: 30px;">
            <hr>
            <h3>ğŸ“Š ë‚´ ì ìˆ˜</h3>
            <div id="scoresContent">
                <div class="status info">ì ìˆ˜ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>

        <div style="margin-top: 20px; font-size: 14px; color: #666;">
            <strong>í…ŒìŠ¤íŠ¸ ë°©ë²•:</strong><br>
            URLì— ë‹¤ìŒê³¼ ê°™ì´ íŒŒë¼ë¯¸í„°ë¥¼ ì¶”ê°€í•˜ì„¸ìš”:<br>
            <code>?apiKey=YOUR_API_KEY&projectId=YOUR_PROJECT_ID</code>
        </div>
    </div>
</body>
</html>
